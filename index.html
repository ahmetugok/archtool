<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filo Çözümleri - Süreç Mimari Aracı (v3.7 - Stable Fix)</title>
   
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
   
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   
    <style>
        body { margin: 0; padding: 0; background-color: #f8fafc; user-select: none; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 20px; }
       
        .selection-box {
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.6);
            pointer-events: none;
            z-index: 9999;
        }
       
        .grid-pattern {
            background-image: radial-gradient(rgba(203, 213, 225, 0.3) 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            pointer-events: none;
            z-index: 10000;
            white-space: nowrap;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .floating-context-menu {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 240px;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.98);
        }
        
        .quick-add-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.9);
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
        }
        
        .quick-add-handle:hover {
            transform: scale(1.2);
            background: rgba(37, 99, 235, 1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .legend-box {
            position: fixed;
            z-index: 10000;
            backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        
        input:focus, textarea:focus {
            outline: 2px solid #2563eb;
            outline-offset: -1px;
        }

        /* Connection Handle Styles */
        [data-handle] {
            pointer-events: auto;
        }

        [data-handle]:hover {
            z-index: 50 !important;
        }

        @keyframes dashAnimation {
            to {
                stroke-dashoffset: -20;
            }
        }

        .animated-arrow {
            animation: dashAnimation 0.5s linear infinite;
            stroke-dasharray: 10, 5;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // --- ICONLAR ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Server = (props) => <IconBase {...props}><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></IconBase>;
        const Database = (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>;
        const Globe = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Smartphone = (props) => <IconBase {...props}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
        const Box = (props) => <IconBase {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconBase>;
        const Keyboard = (props) => <IconBase {...props}><rect width="20" height="16" x="2" y="4" rx="2" ry="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M6 12h.001"/><path d="M10 12h.001"/><path d="M14 12h.001"/><path d="M18 12h.001"/><path d="M7 16h10"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const PlayCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></IconBase>;
        const StopCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></IconBase>;
        const Layout = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Edit3 = (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const Cpu = (props) => <IconBase {...props}><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3"/><path d="M15 1v3"/><path d="M9 20v3"/><path d="M15 20v3"/><path d="M20 9h3"/><path d="M20 14h3"/><path d="M1 9h3"/><path d="M1 14h3"/></IconBase>;
        const Maximize2 = (props) => <IconBase {...props}><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const Key = (props) => <IconBase {...props}><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1 5.3 5.3L3 21l3-3 2.1 2.1L9 19l2.1 2.1z"/><circle cx="16" cy="7" r="2"/></IconBase>;
        const GitCommit = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><line x1="1.05" x2="8" y1="12" y2="12"/><line x1="16" x2="22.95" y1="12" y2="12"/></IconBase>;
        const Bot = (props) => <IconBase {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></IconBase>;
        const Copy = (props) => <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const ImageIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>;
        const FileJson = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>;
        const GitBranch = (props) => <IconBase {...props}><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></IconBase>;
        const ZoomIn = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></IconBase>;
        const ZoomOut = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></IconBase>;
        const Maximize = (props) => <IconBase {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Minus = (props) => <IconBase {...props}><path d="M5 12h14"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>;
        const AlignRight = (props) => <IconBase {...props}><line x1="21" x2="3" y1="6" y2="6"/><line x1="21" x2="9" y1="12" y2="12"/><line x1="21" x2="7" y1="18" y2="18"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const List = (props) => <IconBase {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>;
        const BoxSelect = (props) => <IconBase {...props}><path d="M5 3a2 2 0 0 0-2 2"/><path d="M19 3a2 2 0 0 1 2 2"/><path d="M21 19a2 2 0 0 1-2 2"/><path d="M5 21a2 2 0 0 1-2-2"/><path d="M9 3h1"/><path d="M9 21h1"/><path d="M14 3h1"/><path d="M14 21h1"/><path d="M3 9v1"/><path d="M21 9v1"/><path d="M3 14v1"/><path d="M21 14v1"/></IconBase>;
        const ArrowDown = (props) => <IconBase {...props}><line x1="12" x2="12" y1="5" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>;
        const AlignCenter = (props) => <IconBase {...props}><line x1="21" x2="3" y1="6" y2="6"/><line x1="17" x2="7" y1="12" y2="12"/><line x1="19" x2="5" y1="18" y2="18"/></IconBase>;
        const AlignLeft = (props) => <IconBase {...props}><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9" /></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6" /></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;

        const apiKey = "";

        const NODE_TYPES = {
            SERVER: { label: 'BACKEND', icon: Server, style: 'bg-white text-slate-900', headerColor: 'bg-blue-100' },
            DATABASE: { label: 'VERİTABANI', icon: Database, style: 'bg-white text-slate-900', headerColor: 'bg-green-100' },
            WEB: { label: 'WEB PORTAL', icon: Globe, style: 'bg-white text-slate-900', headerColor: 'bg-purple-100' },
            MOBILE: { label: 'MOBİL APP', icon: Smartphone, style: 'bg-white text-slate-900', headerColor: 'bg-pink-100' },
            USER: { label: 'KULLANICI', icon: User, style: 'bg-white text-slate-900', headerColor: 'bg-yellow-100' },
            PROCESS: { label: 'SÜREÇ', icon: Activity, style: 'bg-white text-slate-900', headerColor: 'bg-orange-100' },
            COMPONENT: { label: 'RAPOR', icon: Box, style: 'bg-white text-slate-900', headerColor: 'bg-gray-100' },
            MANUAL: { label: 'MANUEL GİRİŞ', icon: Keyboard, style: 'bg-white text-slate-900', headerColor: 'bg-slate-200' },
            DECISION: { label: 'KONTROL / SORGU', icon: GitBranch, style: 'bg-white text-slate-900', headerColor: 'bg-amber-100' },
            UML_CLASS: { label: 'UML SINIF', icon: BoxSelect, style: 'bg-white text-slate-900', headerColor: 'bg-white' },
            LIFELINE: { label: 'YAŞAM ÇİZGİSİ', icon: ArrowDown, style: 'bg-transparent', headerColor: 'bg-white border-slate-900' },
           
            START: { label: 'BAŞLANGIÇ', icon: PlayCircle, style: 'bg-yellow-100 border-4 border-green-500 border-dashed text-slate-900 rounded-full', headerColor: 'bg-transparent' },
            END: { label: 'BİTİŞ', icon: StopCircle, style: 'bg-yellow-100 border-4 border-red-500 border-dashed text-slate-900 rounded-full', headerColor: 'bg-transparent' },
            SWIMLANE: { label: 'KULVAR / ALAN', icon: Layout, style: 'bg-slate-50/50 border-slate-300 border-dashed text-slate-400', headerColor: 'bg-transparent' }
        };

        const BADGE_COLORS = [
            { id: 'slate', class: 'bg-slate-100 text-slate-800 border-slate-200' },
            { id: 'shell-yellow', class: 'bg-[#FBCE07] text-slate-900 border-yellow-400' },
            { id: 'shell-red', class: 'bg-[#DD1D21] text-white border-red-700' },
            { id: 'blue', class: 'bg-blue-100 text-blue-800 border-blue-200' },
            { id: 'green', class: 'bg-green-100 text-green-800 border-green-200' },
            { id: 'red', class: 'bg-red-100 text-red-800 border-red-200' },
            { id: 'yellow', class: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
            { id: 'purple', class: 'bg-purple-100 text-purple-800 border-purple-200' },
            { id: 'orange', class: 'bg-orange-100 text-orange-800 border-orange-200' },
            { id: 'pink', class: 'bg-pink-100 text-pink-800 border-pink-200' },
        ];

        const BG_COLORS = [
            { id: 'white', hex: '#ffffff', label: 'Beyaz' },
            { id: 'shell-yellow', hex: '#FBCE07', label: 'Shell Sarısı' },
            { id: 'shell-red', hex: '#DD1D21', label: 'Shell Kırmızısı' },
            { id: 'blue', hex: '#eff6ff', label: 'Mavi' },
            { id: 'green', hex: '#f0fdf4', label: 'Yeşil' },
            { id: 'red', hex: '#fef2f2', label: 'Kırmızı' },
            { id: 'yellow', hex: '#fefce8', label: 'Sarı' },
            { id: 'purple', hex: '#faf5ff', label: 'Mor' },
            { id: 'orange', hex: '#fff7ed', label: 'Turuncu' },
            { id: 'gray', hex: '#f8fafc', label: 'Gri' },
        ];

        const BORDER_COLORS = [
            { id: 'dark', hex: '#0f172a', label: 'Siyah' },
            { id: 'shell-yellow', hex: '#FBCE07', label: 'Shell Sarısı' },
            { id: 'shell-red', hex: '#DD1D21', label: 'Shell Kırmızısı' },
            { id: 'shell-blue', hex: '#003C88', label: 'Shell Mavisi' },
            { id: 'blue', hex: '#2563eb', label: 'Mavi' },
            { id: 'green', hex: '#16a34a', label: 'Yeşil' },
            { id: 'red', hex: '#dc2626', label: 'Kırmızı' },
            { id: 'purple', hex: '#9333ea', label: 'Mor' },
            { id: 'orange', hex: '#ea580c', label: 'Turuncu' },
        ];

        const HANDLES = [
            { id: 'tl', label: 'Sol Üst',    x: 0,   y: 0,   cursor: 'nwse-resize' },
            { id: 't',  label: 'Üst',        x: 50,  y: 0,   cursor: 'ns-resize' },
            { id: 'tr', label: 'Sağ Üst',    x: 100, y: 0,   cursor: 'nesw-resize' },
            { id: 'l',  label: 'Sol',        x: 0,   y: 50,  cursor: 'ew-resize' },
            { id: 'r',  label: 'Sağ',        x: 100, y: 50,  cursor: 'ew-resize' },
            { id: 'bl', label: 'Sol Alt',    x: 0,   y: 100, cursor: 'nesw-resize' },
            { id: 'b',  label: 'Alt',        x: 50,  y: 100, cursor: 'ns-resize' },
            { id: 'br', label: 'Sağ Alt',    x: 100, y: 100, cursor: 'nwse-resize' },
        ];

        // Function to get handles based on node type
        const getHandlesForNode = (node) => {
            if (node.type === 'LIFELINE') {
                const handles = [
                     { id: 't', x: 50, y: 0, cursor: 'ns-resize' },
                ];
                for (let i = 1; i <= 9; i++) {
                    handles.push({ id: `v${i}`, x: 50, y: i * 10, cursor: 'crosshair' });
                }
                handles.push({ id: 'b', x: 50, y: 100, cursor: 'ns-resize' });
                 handles.push({ id: 'br', x: 100, y: 100, cursor: 'nwse-resize' });
                return handles;
            }
            return HANDLES;
        };

        const INITIAL_NODES = [];
        const INITIAL_CONNECTIONS = [];
       
        // LocalStorage Keys
        const STORAGE_KEY_NODES = 'arch_tool_nodes_v3';
        const STORAGE_KEY_CONNS = 'arch_tool_conns_v3';
        const STORAGE_KEY_LEGEND = 'arch_tool_legend_v3';
        const STORAGE_KEY_PAGES = 'arch_tool_pages_v1';

        // Error boundary helper
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global Error:', msg, 'at line:', line);
            return false;
        };

        function ArchitectureTool() {
            // PAGES STATE - Çoklu sayfa desteği
            const [pages, setPages] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY_PAGES);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        if (Array.isArray(parsed) && parsed.length > 0) return parsed;
                    }
                    // Migration: mevcut verileri ilk sayfaya taşı
                    const existingNodes = localStorage.getItem(STORAGE_KEY_NODES);
                    const existingConns = localStorage.getItem(STORAGE_KEY_CONNS);
                    const existingLegend = localStorage.getItem(STORAGE_KEY_LEGEND);
                    return [{
                        id: 'page_1',
                        name: 'Sayfa 1',
                        nodes: existingNodes ? JSON.parse(existingNodes) : INITIAL_NODES,
                        connections: existingConns ? JSON.parse(existingConns) : INITIAL_CONNECTIONS,
                        legendItems: existingLegend ? JSON.parse(existingLegend) : { 'SFS': 'Satış Finans Sistemi' }
                    }];
                } catch (e) { 
                    console.error('Pages load error:', e);
                    return [{ id: 'page_1', name: 'Sayfa 1', nodes: INITIAL_NODES, connections: INITIAL_CONNECTIONS, legendItems: {} }]; 
                }
            });
            const STORAGE_KEY_CURRENT_PAGE_INIT = 'arch_tool_current_page';
            const [currentPageId, setCurrentPageId] = useState(() => {
                try {
                    // Önce kayıtlı currentPageId'yi kontrol et
                    const savedPageId = localStorage.getItem(STORAGE_KEY_CURRENT_PAGE_INIT);
                    const savedPages = localStorage.getItem(STORAGE_KEY_PAGES);
                    if (savedPageId && savedPages) {
                        const parsed = JSON.parse(savedPages);
                        // Kayıtlı sayfa hala mevcut mu kontrol et
                        if (Array.isArray(parsed) && parsed.some(p => p.id === savedPageId)) {
                            return savedPageId;
                        }
                    }
                    if (savedPages) {
                        const parsed = JSON.parse(savedPages);
                        if (Array.isArray(parsed) && parsed.length > 0) return parsed[0].id;
                    }
                } catch(e) {}
                return 'page_1';
            });

            // Current page data
            const currentPage = pages.find(p => p.id === currentPageId) || pages[0];
            const nodes = currentPage?.nodes || [];
            const connections = currentPage?.connections || [];
            const legendItems = currentPage?.legendItems || {};

            // Setters that update the current page
            const setNodes = (updater) => {
                setPages(prev => prev.map(p => p.id === currentPageId ? { ...p, nodes: typeof updater === 'function' ? updater(p.nodes) : updater } : p));
            };
            const setConnections = (updater) => {
                setPages(prev => prev.map(p => p.id === currentPageId ? { ...p, connections: typeof updater === 'function' ? updater(p.connections) : updater } : p));
            };
            const setLegendItems = (updater) => {
                setPages(prev => prev.map(p => p.id === currentPageId ? { ...p, legendItems: typeof updater === 'function' ? updater(p.legendItems) : updater } : p));
            };

            // Page management functions
            const addPage = () => {
                const newId = 'page_' + Date.now();
                const newPage = { id: newId, name: `Sayfa ${pages.length + 1}`, nodes: [], connections: [], legendItems: {} };
                setPages(prev => [...prev, newPage]);
                setCurrentPageId(newId);
            };
            const deletePage = (pageId) => {
                if (pages.length <= 1) return; // En az 1 sayfa kalmalı
                setPages(prev => prev.filter(p => p.id !== pageId));
                if (currentPageId === pageId) {
                    setCurrentPageId(pages.find(p => p.id !== pageId)?.id || pages[0].id);
                }
            };
            const renamePage = (pageId, newName) => {
                setPages(prev => prev.map(p => p.id === pageId ? { ...p, name: newName } : p));
            };
            const [editingPageId, setEditingPageId] = useState(null);

            // STATE - LAZY INITIALIZATION FROM LOCALSTORAGE (legacy - now handled by pages)
            /* const [nodes, setNodes] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY_NODES);
                    return saved ? JSON.parse(saved) : INITIAL_NODES;
                } catch (e) { console.error("Load error", e); return INITIAL_NODES; }
            });
           
            const [connections, setConnections] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY_CONNS);
                    return saved ? JSON.parse(saved) : INITIAL_CONNECTIONS;
                } catch (e) { return INITIAL_CONNECTIONS; }
            });

            // Legend State
            const [legendItems, setLegendItems] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY_LEGEND);
                    const parsed = saved ? JSON.parse(saved) : null;
                    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                        return parsed;
                    }
                    return {
                        'SFS': 'Satış Finans Sistemi',
                        'EVIAS': 'Kurumsal Varlık Yönetimi'
                    };
                } catch(e) { 
                    return { 'SFS': 'Satış Finans Sistemi', 'EVIAS': 'Kurumsal Varlık Yönetimi' }; 
                }
            }); */
            
            const updateLegendItems = (updater) => {
                try {
                    setLegendItems(prev => {
                        const prevSafe = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : {};
                        const result = typeof updater === 'function' ? updater(prevSafe) : updater;
                        return (result && typeof result === 'object' && !Array.isArray(result)) ? result : prevSafe;
                    });
                } catch(err) {
                    console.error('Legend update error:', err);
                }
            };

            // AUTO SAVE EFFECT - Pages and currentPageId
            const STORAGE_KEY_CURRENT_PAGE = 'arch_tool_current_page';
            const [lastSaved, setLastSaved] = useState(null);
            useEffect(() => {
                try {
                    localStorage.setItem(STORAGE_KEY_PAGES, JSON.stringify(pages));
                    localStorage.setItem(STORAGE_KEY_CURRENT_PAGE, currentPageId);
                    setLastSaved(new Date());
                } catch (e) {
                    console.error("Auto-save failed (likely quota exceeded):", e);
                }
            }, [pages, currentPageId]);

            const [selectedNodeIds, setSelectedNodeIds] = useState([]);
            const [selectedConnectionId, setSelectedConnectionId] = useState(null);
            
            // Clipboard - useRef kullanarak sayfa değişse bile korunur
            const copiedNodesRef = useRef([]);
            const copiedConnectionsRef = useRef([]);
            const isCutRef = useRef(false);
           
            const [scale, setScale] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });

            // Refs to reduce drag overhead
            const selectedNodeIdsRef = useRef(selectedNodeIds);
            const initialNodePositionsRef = useRef(initialNodePositions);
            const dragRafRef = useRef(null);
            const dragDeltaRef = useRef(null);
            useEffect(() => { selectedNodeIdsRef.current = selectedNodeIds; }, [selectedNodeIds]);
            useEffect(() => { initialNodePositionsRef.current = initialNodePositions; }, [initialNodePositions]);

            const [isDraggingNode, setIsDraggingNode] = useState(false);
            const [isPanning, setIsPanning] = useState(false);
            const [dragStartPos, setDragStartPos] = useState({ x: 0, y: 0 });
            const [initialNodePositions, setInitialNodePositions] = useState({});
           
            const [isResizing, setIsResizing] = useState(false);
            const [resizeStart, setResizeStart] = useState(null);
            const [isConnecting, setIsConnecting] = useState(false);
            const [connectionStartInfo, setConnectionStartInfo] = useState(null);
            const [tempConnectionEnd, setTempConnectionEnd] = useState({ x: 0, y: 0 });
            const [hoveredHandle, setHoveredHandle] = useState(null);
            const [isReconnecting, setIsReconnecting] = useState(false);
            const [reconnectInfo, setReconnectInfo] = useState(null);
            const [isSelecting, setIsSelecting] = useState(false);
            const [selectionBox, setSelectionBox] = useState(null);
            const [isDraggingControlPoint, setIsDraggingControlPoint] = useState(false); // New state for arrow control
            const [draggingWaypointInfo, setDraggingWaypointInfo] = useState(null); // { connId, waypointIndex }
           
            // New State for Inline Editing
            const [editingField, setEditingField] = useState(null); // { nodeId: string, field: string } | null

           
            const [showLegend, setShowLegend] = useState(false);
            const [legendPos, setLegendPos] = useState({ x: Math.max(100, (typeof window !== 'undefined' ? window.innerWidth : 1200) - 350), y: 100 });
            const [isDraggingLegend, setIsDraggingLegend] = useState(false);
            const [legendDragOffset, setLegendDragOffset] = useState({ x: 0, y: 0 });
            const [isEditingLegend, setIsEditingLegend] = useState(false);
            const [newLegendKey, setNewLegendKey] = useState('');
            const [newLegendValue, setNewLegendValue] = useState('');
            const [swimlaneGuide, setSwimlaneGuide] = useState(null);
            const [snapLines, setSnapLines] = useState([]); // Snap kılavuz çizgileri
            
            // Swimlane snap threshold (px)
            const SNAP_THRESHOLD = 15;
            
            // Collapsible panel sections
            const [expandedSections, setExpandedSections] = useState({ temel: true, gorunum: false, yazi: false, boyut: false });
            const toggleSection = (section) => setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));

            const [showLeftPanel, setShowLeftPanel] = useState(false);
            const [isLeftPanelExpanded, setIsLeftPanelExpanded] = useState(false);
            const [isLeftPanelPinned, setIsLeftPanelPinned] = useState(() => {
                const saved = localStorage.getItem('left_panel_pinned');
                return saved === 'true';
            });
            const [showExportModal, setShowExportModal] = useState(false);
            const [showAiSettingsModal, setShowAiSettingsModal] = useState(false);
            const [showAdvancedSettings, setShowAdvancedSettings] = useState(false);
            const [tooltip, setTooltip] = useState({ visible: false, text: '', x: 0, y: 0 });
            const [showQuickAddHandles, setShowQuickAddHandles] = useState(false);
            const [notePopupNodeId, setNotePopupNodeId] = useState(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiAnalysisResult, setAiAnalysisResult] = useState('');
            const [showAiModal, setShowAiModal] = useState(false);
            const [showSearchModal, setShowSearchModal] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [showTemplateModal, setShowTemplateModal] = useState(false);
           
            const [isComponentsOpen, setIsComponentsOpen] = useState(true);

            const [aiProvider, setAiProvider] = useState(() => localStorage.getItem('ai_provider') || 'gemini');
            const [apiKeyInput, setApiKeyInput] = useState(() => localStorage.getItem(aiProvider === 'gemini' ? 'gemini_api_key' : 'azure_api_key') || '');
            const [azureEndpoint, setAzureEndpoint] = useState(() => localStorage.getItem('azure_endpoint') || '');

            // Save pin state to localStorage
            useEffect(() => {
                localStorage.setItem('left_panel_pinned', isLeftPanelPinned.toString());
            }, [isLeftPanelPinned]);

            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const contentRef = useRef(null);

            const getWorldPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.clientX || e.touches?.[0]?.clientX;
                const clientY = e.clientY || e.touches?.[0]?.clientY;
                return { x: (clientX - rect.left - pan.x) / scale, y: (clientY - rect.top - pan.y) / scale };
            };

            const handleWheel = (e) => {
                e.preventDefault();
                if (e.ctrlKey || e.metaKey || true) {
                    const zoomSensitivity = 0.001; const delta = -e.deltaY * zoomSensitivity;
                    const newScale = Math.min(Math.max(0.1, scale + delta), 5);
                    const rect = canvasRef.current.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
                    const scaleRatio = newScale / scale;
                    const newPanX = mouseX - (mouseX - pan.x) * scaleRatio;
                    const newPanY = mouseY - (mouseY - pan.y) * scaleRatio;
                    setScale(newScale); setPan({ x: newPanX, y: newPanY });
                }
            };

            // Zoom Fonksiyonları
            const zoomIn = () => setScale(prev => Math.min(prev * 1.2, 3));
            const zoomOut = () => setScale(prev => Math.max(prev / 1.2, 0.2));
            const fitToScreen = () => {
                if (nodes.length === 0) return;
                const minX = Math.min(...nodes.map(n => n.x));
                const minY = Math.min(...nodes.map(n => n.y));
                const maxX = Math.max(...nodes.map(n => n.x + (n.width || 160)));
                const maxY = Math.max(...nodes.map(n => n.y + (n.height || 100)));
                const contentWidth = maxX - minX + 100;
                const contentHeight = maxY - minY + 100;
                const rect = canvasRef.current?.getBoundingClientRect();
                if (!rect) return;
                const scaleX = rect.width / contentWidth;
                const scaleY = rect.height / contentHeight;
                const newScale = Math.min(Math.max(Math.min(scaleX, scaleY) * 0.9, 0.2), 2);
                const centerX = (minX + maxX) / 2;
                const centerY = (minY + maxY) / 2;
                setScale(newScale);
                setPan({ x: rect.width / 2 - centerX * newScale, y: rect.height / 2 - centerY * newScale });
            };

            // Hizalama Fonksiyonları
            const alignNodes = (alignment) => {
                if (selectedNodeIds.length < 2) return;
                const selectedNodes = nodes.filter(n => selectedNodeIds.includes(n.id));
                let updates = {};
                if (alignment === 'left') {
                    const minX = Math.min(...selectedNodes.map(n => n.x));
                    selectedNodes.forEach(n => updates[n.id] = { x: minX });
                } else if (alignment === 'right') {
                    const maxX = Math.max(...selectedNodes.map(n => n.x + (n.width || 160)));
                    selectedNodes.forEach(n => updates[n.id] = { x: maxX - (n.width || 160) });
                } else if (alignment === 'centerH') {
                    const avgX = selectedNodes.reduce((sum, n) => sum + n.x + (n.width || 160) / 2, 0) / selectedNodes.length;
                    selectedNodes.forEach(n => updates[n.id] = { x: avgX - (n.width || 160) / 2 });
                } else if (alignment === 'top') {
                    const minY = Math.min(...selectedNodes.map(n => n.y));
                    selectedNodes.forEach(n => updates[n.id] = { y: minY });
                } else if (alignment === 'bottom') {
                    const maxY = Math.max(...selectedNodes.map(n => n.y + (n.height || 100)));
                    selectedNodes.forEach(n => updates[n.id] = { y: maxY - (n.height || 100) });
                } else if (alignment === 'centerV') {
                    const avgY = selectedNodes.reduce((sum, n) => sum + n.y + (n.height || 100) / 2, 0) / selectedNodes.length;
                    selectedNodes.forEach(n => updates[n.id] = { y: avgY - (n.height || 100) / 2 });
                }
                setNodes(prev => prev.map(n => updates[n.id] ? { ...n, ...updates[n.id] } : n));
            };

            // Dağıtım Fonksiyonları
            const distributeNodes = (direction) => {
                if (selectedNodeIds.length < 3) return;
                const selectedNodes = nodes.filter(n => selectedNodeIds.includes(n.id));
                if (direction === 'horizontal') {
                    const sorted = [...selectedNodes].sort((a, b) => a.x - b.x);
                    const minX = sorted[0].x;
                    const maxX = sorted[sorted.length - 1].x;
                    const totalWidth = sorted.reduce((sum, n) => sum + (n.width || 160), 0);
                    const gap = (maxX - minX + (sorted[sorted.length - 1].width || 160) - totalWidth) / (sorted.length - 1);
                    let currentX = minX;
                    const updates = {};
                    sorted.forEach((n, i) => {
                        updates[n.id] = { x: currentX };
                        currentX += (n.width || 160) + gap;
                    });
                    setNodes(prev => prev.map(n => updates[n.id] ? { ...n, ...updates[n.id] } : n));
                } else {
                    const sorted = [...selectedNodes].sort((a, b) => a.y - b.y);
                    const minY = sorted[0].y;
                    const maxY = sorted[sorted.length - 1].y;
                    const totalHeight = sorted.reduce((sum, n) => sum + (n.height || 100), 0);
                    const gap = (maxY - minY + (sorted[sorted.length - 1].height || 100) - totalHeight) / (sorted.length - 1);
                    let currentY = minY;
                    const updates = {};
                    sorted.forEach((n, i) => {
                        updates[n.id] = { y: currentY };
                        currentY += (n.height || 100) + gap;
                    });
                    setNodes(prev => prev.map(n => updates[n.id] ? { ...n, ...updates[n.id] } : n));
                }
            };

            // Kilitleme
            const toggleLock = () => {
                if (selectedNodeIds.length === 0) return;
                setNodes(prev => prev.map(n => selectedNodeIds.includes(n.id) ? { ...n, locked: !n.locked } : n));
            };

            // Arama Sonuçları
            const searchResults = searchQuery.trim() ? nodes.filter(n => 
                (n.title || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                (n.description || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                (n.techStack || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                (n.note || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                (n.tag || '').toLowerCase().includes(searchQuery.toLowerCase())
            ) : [];

            // Şablonlar
            const templates = [
                { 
                    name: 'Basit Süreç Akışı', 
                    description: 'Başlangıç → 3 Adım → Bitiş',
                    nodes: [
                        { id: 't1', type: 'START', x: 100, y: 200, width: 50, height: 50, title: 'Başla', owner: '', techStack: '' },
                        { id: 't2', type: 'PROCESS', x: 250, y: 180, width: 160, height: 100, title: 'Adım 1', description: 'İlk işlem adımı', owner: 'SİSTEM', techStack: '' },
                        { id: 't3', type: 'PROCESS', x: 480, y: 180, width: 160, height: 100, title: 'Adım 2', description: 'İkinci işlem adımı', owner: 'SİSTEM', techStack: '' },
                        { id: 't4', type: 'PROCESS', x: 710, y: 180, width: 160, height: 100, title: 'Adım 3', description: 'Üçüncü işlem adımı', owner: 'SİSTEM', techStack: '' },
                        { id: 't5', type: 'END', x: 940, y: 200, width: 50, height: 50, title: 'Bitir', owner: '', techStack: '' }
                    ],
                    connections: [
                        { id: 'tc1', from: 't1', to: 't2', type: 'straight', endArrow: 'standard' },
                        { id: 'tc2', from: 't2', to: 't3', type: 'straight', endArrow: 'standard' },
                        { id: 'tc3', from: 't3', to: 't4', type: 'straight', endArrow: 'standard' },
                        { id: 'tc4', from: 't4', to: 't5', type: 'straight', endArrow: 'standard' }
                    ]
                },
                { 
                    name: 'Karar Akışı', 
                    description: 'Koşullu dallanma şablonu',
                    nodes: [
                        { id: 't1', type: 'START', x: 300, y: 50, width: 50, height: 50, title: 'Başla', owner: '', techStack: '' },
                        { id: 't2', type: 'DECISION', x: 260, y: 180, width: 60, height: 60, title: 'Koşul', description: 'Karar noktası', owner: 'SİSTEM', techStack: '' },
                        { id: 't3', type: 'PROCESS', x: 50, y: 350, width: 160, height: 100, title: 'Evet Durumu', description: 'Koşul doğruysa', owner: 'SİSTEM', techStack: '' },
                        { id: 't4', type: 'PROCESS', x: 470, y: 350, width: 160, height: 100, title: 'Hayır Durumu', description: 'Koşul yanlışsa', owner: 'SİSTEM', techStack: '' },
                        { id: 't5', type: 'END', x: 300, y: 520, width: 50, height: 50, title: 'Bitir', owner: '', techStack: '' }
                    ],
                    connections: [
                        { id: 'tc1', from: 't1', to: 't2', type: 'straight', endArrow: 'standard' },
                        { id: 'tc2', from: 't2', to: 't3', type: 'straight', endArrow: 'standard', label: 'Evet' },
                        { id: 'tc3', from: 't2', to: 't4', type: 'straight', endArrow: 'standard', label: 'Hayır' },
                        { id: 'tc4', from: 't3', to: 't5', type: 'straight', endArrow: 'standard' },
                        { id: 'tc5', from: 't4', to: 't5', type: 'straight', endArrow: 'standard' }
                    ]
                },
                { 
                    name: '3 Katmanlı Mimari', 
                    description: 'Frontend → Backend → Database',
                    nodes: [
                        { id: 't1', type: 'USER', x: 100, y: 200, width: 50, height: 50, title: 'Kullanıcı', description: 'Son kullanıcı', owner: '', techStack: '' },
                        { id: 't2', type: 'WEB', x: 350, y: 200, width: 160, height: 100, title: 'Web Portal', description: 'Frontend uygulaması', owner: 'FE Team', techStack: 'React' },
                        { id: 't3', type: 'SERVER', x: 600, y: 200, width: 160, height: 100, title: 'API Server', description: 'Backend servisi', owner: 'BE Team', techStack: 'Node.js' },
                        { id: 't4', type: 'DATABASE', x: 850, y: 200, width: 160, height: 100, title: 'Veritabanı', description: 'Ana veritabanı', owner: 'DBA', techStack: 'PostgreSQL' }
                    ],
                    connections: [
                        { id: 'tc1', from: 't1', to: 't2', type: 'straight', endArrow: 'standard' },
                        { id: 'tc2', from: 't2', to: 't3', type: 'straight', endArrow: 'standard', label: 'REST API' },
                        { id: 'tc3', from: 't3', to: 't4', type: 'straight', endArrow: 'standard', label: 'SQL' }
                    ]
                }
            ];

            const applyTemplate = (template) => {
                const idMap = {};
                const timestamp = Date.now();
                const newNodes = template.nodes.map((n, i) => {
                    const newId = `tpl_${timestamp}_${i}`;
                    idMap[n.id] = newId;
                    return { ...n, id: newId };
                });
                const newConns = template.connections.map((c, i) => ({
                    ...c,
                    id: `tplc_${timestamp}_${i}`,
                    from: idMap[c.from],
                    to: idMap[c.to]
                }));
                setNodes(prev => [...prev, ...newNodes]);
                setConnections(prev => [...prev, ...newConns]);
                setShowTemplateModal(false);
            };

            // Swimlane çift tıklama - komşu kulvarların boyutlarını eşitle
            const handleSwimlaneDoubleClick = (nodeId) => {
                const clickedNode = nodes.find(n => n.id === nodeId);
                if (!clickedNode || clickedNode.type !== 'SWIMLANE') return;
                
                const clickedW = clickedNode.width || 350;
                const clickedH = clickedNode.height || 500;
                const clickedRight = clickedNode.x + clickedW;
                const clickedBottom = clickedNode.y + clickedH;
                const THRESHOLD = 20;
                
                // Find adjacent swimlanes
                const otherSwimlanes = nodes.filter(n => n.id !== nodeId && n.type === 'SWIMLANE');
                let hasAdjacent = false;
                const updates = {};
                
                otherSwimlanes.forEach(other => {
                    const otherW = other.width || 350;
                    const otherH = other.height || 500;
                    const otherRight = other.x + otherW;
                    const otherBottom = other.y + otherH;
                    
                    // Check if horizontally adjacent (yan yana)
                    const isRightAdjacent = Math.abs(clickedRight - other.x) < THRESHOLD;
                    const isLeftAdjacent = Math.abs(clickedNode.x - otherRight) < THRESHOLD;
                    
                    // Check if vertically adjacent (alt alta)
                    const isBottomAdjacent = Math.abs(clickedBottom - other.y) < THRESHOLD;
                    const isTopAdjacent = Math.abs(clickedNode.y - otherBottom) < THRESHOLD;
                    
                    if (isRightAdjacent || isLeftAdjacent) {
                        // Yan yana - HEM yükseklik HEM genişlik eşitle
                        hasAdjacent = true;
                        const maxH = Math.max(clickedH, otherH);
                        const maxW = Math.max(clickedW, otherW);
                        const minY = Math.min(clickedNode.y, other.y);
                        
                        updates[clickedNode.id] = { height: maxH, width: maxW, y: minY };
                        updates[other.id] = { height: maxH, width: maxW, y: minY };
                        
                        // Kenarları tam yapıştır
                        if (isRightAdjacent) {
                            updates[other.id].x = clickedNode.x + maxW;
                            updates[clickedNode.id].x = clickedNode.x;
                        } else if (isLeftAdjacent) {
                            updates[clickedNode.id].x = other.x + maxW;
                            updates[other.id].x = other.x;
                        }
                    }
                    
                    if (isBottomAdjacent || isTopAdjacent) {
                        // Alt alta - HEM genişlik HEM yükseklik eşitle
                        hasAdjacent = true;
                        const maxW = Math.max(clickedW, otherW);
                        const maxH = Math.max(clickedH, otherH);
                        const minX = Math.min(clickedNode.x, other.x);
                        
                        updates[clickedNode.id] = { ...updates[clickedNode.id], width: maxW, height: maxH, x: minX };
                        updates[other.id] = { ...updates[other.id], width: maxW, height: maxH, x: minX };
                        
                        // Kenarları tam yapıştır
                        if (isBottomAdjacent) {
                            updates[other.id] = { ...updates[other.id], y: clickedNode.y + maxH };
                            updates[clickedNode.id] = { ...updates[clickedNode.id], y: clickedNode.y };
                        } else if (isTopAdjacent) {
                            updates[clickedNode.id] = { ...updates[clickedNode.id], y: other.y + maxH };
                            updates[other.id] = { ...updates[other.id], y: other.y };
                        }
                    }
                });
                
                if (hasAdjacent) {
                    setNodes(prev => prev.map(n => {
                        if (updates[n.id]) {
                            return { ...n, ...updates[n.id] };
                        }
                        return n;
                    }));
                }
            };

            const resetCanvas = () => {
                if(confirm("Mevcut sayfa temizlenecek. Emin misiniz?")) {
                    setNodes([]);
                    setConnections([]);
                    setLegendItems({});
                }
            }

            const deleteSelected = useCallback(() => {
                if (selectedNodeIds.length > 0) { setNodes(prev => prev.filter(n => !selectedNodeIds.includes(n.id))); setConnections(prev => prev.filter(c => !selectedNodeIds.includes(c.from) && !selectedNodeIds.includes(c.to))); setSelectedNodeIds([]); }
                else if (selectedConnectionId) { setConnections(prev => prev.filter(c => c.id !== selectedConnectionId)); setSelectedConnectionId(null); }
            }, [selectedNodeIds, selectedConnectionId]);

            // Copy - sayfalar arası çalışır (useRef ile)
            const copySelected = useCallback(() => { 
                if (selectedNodeIds.length > 0) { 
                    copiedNodesRef.current = nodes.filter(n => selectedNodeIds.includes(n.id)); 
                    // İlgili bağlantıları da kopyala
                    copiedConnectionsRef.current = connections.filter(c => selectedNodeIds.includes(c.from) && selectedNodeIds.includes(c.to));
                    isCutRef.current = false;
                } 
            }, [selectedNodeIds, nodes, connections]);
            
            // Cut - kopyala ve sil (yapıştırınca orijinal silinir)
            const cutSelected = useCallback(() => {
                if (selectedNodeIds.length > 0) {
                    copiedNodesRef.current = nodes.filter(n => selectedNodeIds.includes(n.id));
                    copiedConnectionsRef.current = connections.filter(c => selectedNodeIds.includes(c.from) && selectedNodeIds.includes(c.to));
                    isCutRef.current = true;
                    // Orijinalleri sil
                    setNodes(prev => prev.filter(n => !selectedNodeIds.includes(n.id)));
                    setConnections(prev => prev.filter(c => !selectedNodeIds.includes(c.from) && !selectedNodeIds.includes(c.to)));
                    setSelectedNodeIds([]);
                }
            }, [selectedNodeIds, nodes, connections]);
           
            const pasteCopied = useCallback(() => {
                const copiedNodes = copiedNodesRef.current;
                const copiedConnections = copiedConnectionsRef.current;
                const isCut = isCutRef.current;
                
                if (copiedNodes.length > 0) {
                    const idMap = {};
                    const newNodes = copiedNodes.map(node => { 
                        const newId = Date.now().toString() + Math.random().toString(36).substr(2, 5); 
                        idMap[node.id] = newId; 
                        return { ...node, id: newId, x: node.x + 30, y: node.y + 30, title: isCut ? node.title : node.title + ' (Kopya)' }; 
                    });
                    // Bağlantıları da yapıştır (yeni ID'lerle)
                    const newConns = copiedConnections.map(conn => ({
                        ...conn,
                        id: 'conn_' + Date.now() + Math.random().toString(36).substr(2, 5),
                        from: idMap[conn.from] || conn.from,
                        to: idMap[conn.to] || conn.to
                    })).filter(c => idMap[c.from] && idMap[c.to]); // Sadece her iki ucu da kopyalanmışsa
                    
                    setNodes(prev => [...prev, ...newNodes]); 
                    setConnections(prev => [...prev, ...newConns]);
                    setSelectedNodeIds(newNodes.map(n => n.id));
                    
                    // Cut ise, yapıştırdıktan sonra clipboard'u temizle
                    if (isCut) {
                        copiedNodesRef.current = [];
                        copiedConnectionsRef.current = [];
                        isCutRef.current = false;
                    }
                }
            }, []);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    const isInput = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
                    if (e.key === 'Delete' || e.key === 'Backspace') { if (!isInput) deleteSelected(); }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'c') { if (!isInput) copySelected(); }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'x') { if (!isInput) { e.preventDefault(); cutSelected(); } }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'v') { if (!isInput) pasteCopied(); }
                    if (selectedNodeIds.length > 0 && !isInput) {
                        // Shift: 1px hassas, Normal: 5px, Ctrl: 20px hızlı
                        const step = e.shiftKey ? 1 : (e.ctrlKey ? 20 : 5); let dx = 0, dy = 0;
                        if (e.key === 'ArrowUp') dy = -step; else if (e.key === 'ArrowDown') dy = step; else if (e.key === 'ArrowLeft') dx = -step; else if (e.key === 'ArrowRight') dx = step;
                        if (dx !== 0 || dy !== 0) { e.preventDefault(); setNodes(prev => prev.map(n => selectedNodeIds.includes(n.id) ? { ...n, x: n.x + dx, y: n.y + dy } : n)); }
                    }
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [deleteSelected, copySelected, cutSelected, pasteCopied, selectedNodeIds]);

            const handleFileChange = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        // Yeni format: pages array
                        if (json && Array.isArray(json.pages)) {
                            setPages(json.pages);
                            setCurrentPageId(json.currentPageId || json.pages[0]?.id);
                            alert("Proje başarıyla yüklendi! (" + json.pages.length + " sayfa)");
                        }
                        // Eski format: tek sayfa (nodes, connections, legendItems)
                        else if (json && Array.isArray(json.nodes) && Array.isArray(json.connections)) {
                            const idMap = {};
                            const safeNodes = json.nodes.map((n, idx) => {
                                const newId = `n_${idx}_${Date.now()}`; idMap[n.id] = newId;
                                let safeType = NODE_TYPES[n.type] ? n.type : 'COMPONENT';
                                let safeX = Number.isFinite(Number(n.x)) ? Number(n.x) : 100; let safeY = Number.isFinite(Number(n.y)) ? Number(n.y) : 100;
                                if (safeX > 20000 || safeX < -20000) safeX = 100; if (safeY > 20000 || safeY < -20000) safeY = 100;
                                return {
                                    ...n, id: newId, type: safeType, x: safeX, y: safeY,
                                    width: Number(n.width)||160, height: Number(n.height)||100,
                                    methods: n.methods || '', headerPosition: n.headerPosition || 'top', headerFontSize: n.headerFontSize || 10,
                                    headerFontColor: n.headerFontColor || '#1f2937',
                                    headerFontFamily: n.headerFontFamily || "'Segoe UI', Tahoma, sans-serif",
                                    headerFontWeight: n.headerFontWeight || 800,
                                    techStackFontSize: n.techStackFontSize || 9,
                                    techStackFontColor: n.techStackFontColor || '#475569',
                                    techStackFontFamily: n.techStackFontFamily || "'Segoe UI', Tahoma, sans-serif",
                                    techStackFontWeight: n.techStackFontWeight || 700,
                                    backgroundColor: n.backgroundColor || '#ffffff',
                                    borderColor: n.borderColor || '#0f172a'
                                };
                            });
                            const safeConnections = json.connections.filter(c => idMap[c.from] && idMap[c.to]).map(c => ({...c, id: `c_${Date.now()}_${Math.random()}`, from: idMap[c.from], to: idMap[c.to], type: c.type || 'straight', curvature: c.curvature !== undefined ? c.curvature : 0.5, startArrow: c.startArrow || 'none', endArrow: c.endArrow || 'standard', animated: c.animated || false }));
                            // Eski formattan import: mevcut sayfaya ekle
                            setNodes(safeNodes); setConnections(safeConnections);
                            if(json.legendItems) setLegendItems(json.legendItems);
                            alert("Proje başarıyla yüklendi!");
                        } else { alert("Geçersiz dosya formatı."); }
                    } catch (err) { alert("Dosya okuma hatası: " + err.message); }
                };
                reader.readAsText(file); event.target.value = '';
            };

            const handleImportClick = () => fileInputRef.current.click();
            const handleProviderChange = (e) => { const v = e.target.value; setAiProvider(v); localStorage.setItem('ai_provider', v); setApiKeyInput(localStorage.getItem(v === 'gemini' ? 'gemini_api_key' : 'azure_api_key') || ''); };
            const handleKeyInput = (e) => { const v = e.target.value; setApiKeyInput(v); localStorage.setItem(aiProvider === 'gemini' ? 'gemini_api_key' : 'azure_api_key', v); };
            const handleEndpointInput = (e) => { const v = e.target.value; setAzureEndpoint(v); localStorage.setItem('azure_endpoint', v); };
           
            const callAI = async (prompt) => {
                if (!apiKeyInput) { alert("API Anahtarı Gerekli"); return null; }
                setIsAiLoading(true);
                try {
                    let responseText = "";
                    if (aiProvider === 'gemini') {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKeyInput}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const data = await response.json(); responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    }
                    else {
                         if (!azureEndpoint) throw new Error("Endpoint Gerekli");
                         const response = await fetch(azureEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', 'api-key': apiKeyInput }, body: JSON.stringify({ messages: [{ role: "user", content: prompt }] }) });
                         if (!response.ok) throw new Error(`API Error: ${response.status}`);
                         const data = await response.json(); responseText = data.choices?.[0]?.message?.content;
                    }
                    return responseText;
                } catch (error) { alert(`Hata: ${error.message}`); return null; } finally { setIsAiLoading(false); }
            };

            const handleAiArchitectureAudit = async () => { if (nodes.length) { const res = await callAI(`Sen İş Analistisin. Veri: ${JSON.stringify({nodes, connections})}. Türkçe Rapor: 1.Süreç 2.Risk 3.Öneri 4.Sistem Tasarım Soruları`); if (res) { setAiAnalysisResult(res); setShowAiModal(true); } } };
            const handleAiNodeDescription = async () => { if (selectedNodeIds.length) { const n = nodes.find(n => n.id === selectedNodeIds[0]); const res = await callAI(`Bileşen: ${n.title}. Tip: ${n.type}. Görevi? (Kısa, Türkçe)`); if (res) updateNodeData('description', res); } };
            const downloadReport = () => { if (!aiAnalysisResult) return; const blob = new Blob([aiAnalysisResult], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'analiz-raporu.md'; a.click(); };

            const exportJSON = () => { 
                const data = JSON.stringify({ pages, currentPageId }, null, 2); 
                const blob = new Blob([data], { type: 'application/json' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = 'proje.json'; 
                a.click(); 
                setShowExportModal(false); 
            };
            const exportMarkdown = () => { let content = "# Rapor\n"; /*...*/ const blob = new Blob([content], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'rapor.md'; a.click(); setShowExportModal(false); };
           
            const exportMermaid = () => {
                let mermaidCode = 'graph TD\n';
                const nodeMap = {};
                nodes.forEach((node, idx) => {
                    const nodeId = `N${idx + 1}`;
                    nodeMap[node.id] = nodeId;
                    const label = node.title || 'Untitled';
                    mermaidCode += `    ${nodeId}["${label}"]\n`;
                });
                connections.forEach(conn => {
                    const fromId = nodeMap[conn.from];
                    const toId = nodeMap[conn.to];
                    if (fromId && toId) {
                        const label = conn.label ? `|"${conn.label}"|` : '';
                        mermaidCode += `    ${fromId} -->${label} ${toId}\n`;
                    }
                });
                const blob = new Blob([mermaidCode], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'diagram.mmd';
                a.click();
                setShowExportModal(false);
            };
           
            const exportPNG = async () => {
                if (!contentRef.current) return;
                setIsAiLoading(true);
                
                // Önce seçimleri temizle
                const prevSelectedNodes = [...selectedNodeIds];
                const prevSelectedConn = selectedConnectionId;
                setSelectedNodeIds([]);
                setSelectedConnectionId(null);
                
                // Kısa bir bekleme - render için
                await new Promise(resolve => setTimeout(resolve, 100));
                
                try {
                    const canvasElement = contentRef.current;
                    
                    // Grid pattern'i geçici olarak gizle
                    const gridPattern = canvasElement.querySelector('.grid-pattern');
                    if (gridPattern) gridPattern.style.display = 'none';
                    
                    // Handle ve quick-add butonlarını gizle
                    const uiElements = canvasElement.querySelectorAll('.quick-add-handle, [data-handle]');
                    uiElements.forEach(el => el.style.visibility = 'hidden');
                    
                    // SVG içindeki control circle'ları gizle
                    const controlCircles = canvasElement.querySelectorAll('svg circle');
                    controlCircles.forEach(el => el.style.visibility = 'hidden');
                    
                    // Tüm node'ların sınırlarını hesapla
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    
                    nodes.forEach(n => {
                        minX = Math.min(minX, n.x);
                        minY = Math.min(minY, n.y);
                        maxX = Math.max(maxX, n.x + (n.width || 180));
                        maxY = Math.max(maxY, n.y + (n.height || 100));
                    });
                    
                    // Bağlantı yollarını da dahil et
                    connections.forEach(conn => {
                        const sourceNode = nodes.find(n => n.id === conn.from);
                        const targetNode = nodes.find(n => n.id === conn.to);
                        if (sourceNode && targetNode) {
                            const start = getHandleCoords(sourceNode, conn.sourceHandle || 'r');
                            const end = getHandleCoords(targetNode, conn.targetHandle || 'l');
                            minX = Math.min(minX, start.x - 30, end.x - 30);
                            minY = Math.min(minY, start.y - 30, end.y - 30);
                            maxX = Math.max(maxX, start.x + 30, end.x + 30);
                            maxY = Math.max(maxY, start.y + 30, end.y + 30);
                        }
                    });
                    
                    if (nodes.length === 0) {
                        minX = 0; minY = 0; maxX = 800; maxY = 600;
                    }
                    
                    const padding = 40;
                    const exportWidth = (maxX - minX) + (padding * 2);
                    const exportHeight = (maxY - minY) + (padding * 2);
                    
                    // html2canvas ile doğrudan yakala
                    const canvas = await html2canvas(canvasElement, {
                        backgroundColor: '#f0f4f8',
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        x: minX - padding,
                        y: minY - padding,
                        width: exportWidth,
                        height: exportHeight,
                        scrollX: -canvasElement.scrollLeft,
                        scrollY: -canvasElement.scrollTop,
                        windowWidth: canvasElement.scrollWidth,
                        windowHeight: canvasElement.scrollHeight
                    });
                    
                    // Gizlenen elementleri geri getir
                    if (gridPattern) gridPattern.style.display = '';
                    uiElements.forEach(el => el.style.visibility = '');
                    controlCircles.forEach(el => el.style.visibility = '');
                    
                    // Seçimleri geri yükle
                    setSelectedNodeIds(prevSelectedNodes);
                    setSelectedConnectionId(prevSelectedConn);
                    
                    // İndir
                    const data = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = data;
                    link.download = `surec-diyagrami-${Date.now()}.png`;
                    link.click();
                    
                } catch(e) { 
                    console.error('Export error:', e); 
                    alert("PNG dışa aktarma hatası: " + e.message);
                    
                    // Hata durumunda da geri yükle
                    setSelectedNodeIds(prevSelectedNodes);
                    setSelectedConnectionId(prevSelectedConn);
                } finally { 
                    setIsAiLoading(false); 
                    setShowExportModal(false); 
                }
            };

            const handleLegendPointerDown = (e) => { 
                try {
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    setIsDraggingLegend(true); 
                    const rect = e.currentTarget.getBoundingClientRect(); 
                    setLegendDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top }); 
                } catch(err) {
                    console.error('Legend drag error:', err);
                }
            };
            const handleGlobalPointerMove = useCallback((e) => { 
                if (isDraggingLegend) { 
                    try {
                        const newX = Math.max(0, Math.min(e.clientX - legendDragOffset.x, window.innerWidth - 300));
                        const newY = Math.max(0, Math.min(e.clientY - legendDragOffset.y, window.innerHeight - 200));
                        setLegendPos({ x: newX, y: newY }); 
                    } catch(err) {
                        console.error('Legend move error:', err);
                    }
                } 
            }, [isDraggingLegend, legendDragOffset]);
            const handleGlobalPointerUp = useCallback(() => { if (isDraggingLegend) setIsDraggingLegend(false); }, [isDraggingLegend]);
            useEffect(() => { 
                if (isDraggingLegend) { 
                    window.addEventListener('pointermove', handleGlobalPointerMove); 
                    window.addEventListener('pointerup', handleGlobalPointerUp); 
                } else { 
                    window.removeEventListener('pointermove', handleGlobalPointerMove); 
                    window.removeEventListener('pointerup', handleGlobalPointerUp); 
                } 
                return () => { 
                    window.removeEventListener('pointermove', handleGlobalPointerMove); 
                    window.removeEventListener('pointerup', handleGlobalPointerUp); 
                }; 
            }, [isDraggingLegend, handleGlobalPointerMove, handleGlobalPointerUp]);


            const addNode = (typeKey, dropPos = null) => {
                const id = Date.now().toString();
                let defaultWidth = 160; let defaultHeight = 100;
                let startX = 100;
                let startY = 100;

                if (typeKey === 'SWIMLANE') {
                    defaultWidth = 350; defaultHeight = 500;
                    const existingSwimlanes = nodes.filter(n => n.type === 'SWIMLANE');
                    if (existingSwimlanes.length > 0) {
                        const rightMost = Math.max(...existingSwimlanes.map(n => n.x + (n.width || 350)));
                        startX = rightMost + 20;
                        startY = Math.min(...existingSwimlanes.map(n => n.y));
                    } else {
                        startX = 100;
                        startY = 100;
                    }
                }
                else if (typeKey === 'START' || typeKey === 'END') { defaultWidth = 50; defaultHeight = 50; }
                else if (typeKey === 'DECISION') { defaultWidth = 60; defaultHeight = 60; }
                else if (typeKey === 'UML_CLASS') { defaultWidth = 180; defaultHeight = 220; }
                else if (typeKey === 'LIFELINE') { defaultWidth = 100; defaultHeight = 400; }
                else {
                    const offset = nodes.length * 20;
                    startX = 100 + (offset % 200);
                    startY = 100 + (offset % 200);
                }

                if (dropPos) {
                    startX = dropPos.x - (defaultWidth / 2);
                    startY = dropPos.y - (defaultHeight / 2);
                }

                let initialTitle = 'İşlem Adı'; let initialTechStack = NODE_TYPES[typeKey].label;
                if (typeKey === 'SWIMLANE') { initialTitle = 'YENİ KULVAR'; initialTechStack = ''; }
                else if (typeKey === 'START') { initialTitle = 'BAŞLA'; initialTechStack = ''; }
                else if (typeKey === 'END') { initialTitle = 'BİTİR'; initialTechStack = ''; }
                else if (typeKey === 'DECISION') { initialTitle = 'KONTROL'; initialTechStack = ''; }
                else if (typeKey === 'UML_CLASS') { initialTitle = 'ClassName'; initialTechStack = ''; }
                else if (typeKey === 'LIFELINE') { initialTitle = 'Actor'; initialTechStack = ''; }

                const newNode = {
                    id, type: typeKey, x: startX, y: startY, width: defaultWidth, height: defaultHeight,
                    title: initialTitle, description: '', techStack: initialTechStack,
                    owner: typeKey === 'SWIMLANE' || typeKey === 'UML_CLASS' ? '' : 'SİSTEM',
                    stepNumber: '', hasRisk: false, customColor: null,
                    headerHeight: 32, titleHeight: 28, methods: '', headerPosition: 'top', headerFontSize: 10,
                    headerFontColor: '#000000', headerFontFamily: "'Segoe UI', Tahoma, sans-serif", headerFontWeight: 800,
                    techStackFontSize: 9, techStackFontColor: '#000000', techStackFontFamily: "'Segoe UI', Tahoma, sans-serif", techStackFontWeight: 700,
                    descriptionFontSize: 11, descriptionFontColor: '#000000', descriptionFontFamily: "'Segoe UI', Tahoma, sans-serif",
                    backgroundColor: toPaleColor('#ffffff', '55'), // Pale default BG
                    borderColor: '#0f172a', // Default Border (slate-900)
                    headerColor: '#ffffff', // Default Header Color (beyaz)
                    stepNumberColor: '#000000', // Step number yazı rengi siyah
                    stepNumberBgColor: '#e5e7eb', // Step number arka plan açık gri
                    stepNumberBgOpacity: 100, // Tam opak
                    techStackBgColor: 'rgba(0,0,0,0.1)' // Tech badge arka plan
                };
               
                if (typeKey === 'SWIMLANE') setNodes(prev => [newNode, ...prev]); else setNodes(prev => [...prev, newNode]);
               
                setSelectedNodeIds([id]); setSelectedConnectionId(null); if (window.innerWidth < 768) setShowLeftPanel(false);
            };

            const updateNodeData = (field, value) => { setNodes(prev => prev.map(n => selectedNodeIds.includes(n.id) ? { ...n, [field]: value } : n)); };

            // Group/Ungroup helpers
            const groupSelected = () => {
                if (selectedNodeIds.length < 2) return;
                const newGroupId = `grp_${Date.now()}`;
                setNodes(prev => prev.map(n => selectedNodeIds.includes(n.id) ? { ...n, groupId: newGroupId } : n));
            };
            const ungroupSelected = () => {
                if (selectedNodeIds.length === 0) return;
                setNodes(prev => prev.map(n => selectedNodeIds.includes(n.id) ? (() => { const { groupId, ...rest } = n; return { ...rest }; })() : n));
            };
            const updateNodeDataWithId = (id, field, value) => { setNodes(prev => prev.map(n => n.id === id ? { ...n, [field]: value } : n)); };

            // Explicitly define renderEditableField here to fix ReferenceError
            const renderEditableField = (node, field, className, style = {}, elementType = 'input') => {
                const isEditing = editingField?.nodeId === node.id && editingField?.field === field;
                const value = node[field] || '';

                if (isEditing) {
                    if (elementType === 'textarea') {
                        return (
                            <textarea
                                autoFocus
                                value={value}
                                onChange={(e) => updateNodeDataWithId(node.id, field, e.target.value)}
                                onBlur={() => setEditingField(null)}
                                onPointerDown={(e) => e.stopPropagation()}
                                className={`w-full h-full bg-white text-slate-900 p-1 outline-blue-500 rounded resize-none text-[11px] font-mono leading-snug ${className}`}
                                style={style}
                            />
                        );
                    }
                    return (
                        <input
                            autoFocus
                            type="text"
                            value={value}
                            onChange={(e) => updateNodeDataWithId(node.id, field, e.target.value)}
                            onBlur={() => setEditingField(null)}
                            onKeyDown={(e) => { if(e.key === 'Enter') setEditingField(null); e.stopPropagation(); }}
                            onPointerDown={(e) => e.stopPropagation()}
                            className={`w-full h-full bg-white text-slate-900 px-1 outline-blue-500 rounded ${className}`}
                            style={style}
                        />
                    );
                }

                if (elementType === 'textarea') {
                     return (
                        <div
                            onDoubleClick={(e) => { e.stopPropagation(); setEditingField({ nodeId: node.id, field }); }}
                            className={`cursor-text hover:bg-black/5 rounded min-h-[40px] w-full h-full whitespace-pre-wrap ${className}`}
                            style={style}
                            title="Çift tıkla düzenle"
                        >
                            {value || <span className="italic opacity-50">Süreç detayı...</span>}
                        </div>
                    );
                }

                return (
                    <span
                        onDoubleClick={(e) => { e.stopPropagation(); setEditingField({ nodeId: node.id, field }); }}
                        className={`cursor-text hover:bg-black/5 rounded px-0.5 min-w-[10px] inline-block ${className}`}
                        style={style}
                        title="Çift tıkla düzenle"
                    >
                        {value || (field === 'stepNumber' ? '-' : '')}
                    </span>
                );
            };

            const updateConnectionLabel = (connId, label) => setConnections(prev => prev.map(c => c.id === connId ? { ...c, label } : c));
            const updateConnectionData = (connId, field, value) => setConnections(prev => prev.map(c => c.id === connId ? { ...c, [field]: value } : c));
            const deleteConnection = (connId) => setConnections(prev => prev.filter(c => c.id !== connId));
           
            const getNodeRect = (node) => ({ x: node.x, y: node.y, width: node.width || 160, height: node.height || 100 });

            const renderArrowHead = (type, tipX, tipY, angle, color = '#0f172a', size = 1) => {
                if (type === 'none') return null;
                
                const len = 12 * size;
                const wid = 6 * size;
                
                if (type === 'standard') {
                    // Sleek filled triangle arrow
                    const baseX = tipX - len * Math.cos(angle);
                    const baseY = tipY - len * Math.sin(angle);
                    const left = {
                        x: baseX - wid * Math.sin(angle),
                        y: baseY + wid * Math.cos(angle)
                    };
                    const right = {
                        x: baseX + wid * Math.sin(angle),
                        y: baseY - wid * Math.cos(angle)
                    };
                    return { type: 'path', d: `M ${tipX} ${tipY} L ${left.x} ${left.y} L ${right.x} ${right.y} Z`, fill: color };
                }
                
                if (type === 'open') {
                    // Open arrow (like >)
                    const left = {
                        x: tipX - len * Math.cos(angle) - wid * Math.sin(angle),
                        y: tipY - len * Math.sin(angle) + wid * Math.cos(angle)
                    };
                    const right = {
                        x: tipX - len * Math.cos(angle) + wid * Math.sin(angle),
                        y: tipY - len * Math.sin(angle) - wid * Math.cos(angle)
                    };
                    return { type: 'path', d: `M ${left.x} ${left.y} L ${tipX} ${tipY} L ${right.x} ${right.y}`, fill: 'none', stroke: color };
                }
                
                if (type === 'circle') {
                    const centerX = tipX - (len * 0.6) * Math.cos(angle);
                    const centerY = tipY - (len * 0.6) * Math.sin(angle);
                    return { type: 'circle', x: centerX, y: centerY, r: 5 * size, fill: 'white', stroke: color };
                }
                
                if (type === 'filledCircle') {
                    const centerX = tipX - (len * 0.6) * Math.cos(angle);
                    const centerY = tipY - (len * 0.6) * Math.sin(angle);
                    return { type: 'circle', x: centerX, y: centerY, r: 5 * size, fill: color, stroke: color };
                }
                
                if (type === 'diamond') {
                    const centerX = tipX - len * Math.cos(angle);
                    const centerY = tipY - len * Math.sin(angle);
                    const d = wid * 0.9;
                    // Rotate diamond to align with line
                    const cos = Math.cos(angle);
                    const sin = Math.sin(angle);
                    const points = [
                        { x: centerX + d * cos, y: centerY + d * sin },
                        { x: centerX - d * sin, y: centerY + d * cos },
                        { x: centerX - d * cos, y: centerY - d * sin },
                        { x: centerX + d * sin, y: centerY - d * cos }
                    ];
                    return { type: 'path', d: `M ${points[0].x} ${points[0].y} L ${points[1].x} ${points[1].y} L ${points[2].x} ${points[2].y} L ${points[3].x} ${points[3].y} Z`, fill: 'white', stroke: color };
                }
                
                if (type === 'filledDiamond') {
                    const centerX = tipX - len * Math.cos(angle);
                    const centerY = tipY - len * Math.sin(angle);
                    const d = wid * 0.9;
                    const cos = Math.cos(angle);
                    const sin = Math.sin(angle);
                    const points = [
                        { x: centerX + d * cos, y: centerY + d * sin },
                        { x: centerX - d * sin, y: centerY + d * cos },
                        { x: centerX - d * cos, y: centerY - d * sin },
                        { x: centerX + d * sin, y: centerY - d * cos }
                    ];
                    return { type: 'path', d: `M ${points[0].x} ${points[0].y} L ${points[1].x} ${points[1].y} L ${points[2].x} ${points[2].y} L ${points[3].x} ${points[3].y} Z`, fill: color, stroke: color };
                }
                
                return null;
            };
            
            // Helper function to render arrow shapes
            const renderArrow = (arrowData, isShadow = false) => {
                if (!arrowData) return null;
                
                if (arrowData.type === 'path') {
                    return (
                        <path 
                            d={arrowData.d} 
                            fill={isShadow ? '#000' : (arrowData.fill || 'none')}
                            stroke={isShadow ? '#000' : (arrowData.stroke || arrowData.fill)}
                            strokeWidth={isShadow ? '3' : '2'}
                            opacity={isShadow ? 0.15 : 1}
                            strokeLinejoin="round"
                        />
                    );
                }
                
                if (arrowData.type === 'circle') {
                    return (
                        <circle 
                            cx={arrowData.x} 
                            cy={arrowData.y} 
                            r={arrowData.r}
                            fill={isShadow ? '#000' : arrowData.fill}
                            stroke={isShadow ? '#000' : arrowData.stroke}
                            strokeWidth={isShadow ? '3' : '2'}
                            opacity={isShadow ? 0.15 : 1}
                        />
                    );
                }
                
                return null;
            };
           
            const calculatedHandles = useMemo(() => nodes.map(node => {
                 const rect = getNodeRect(node);
                 return HANDLES.map(h => ({ id: h.id, x: rect.x + (rect.width * h.x) / 100, y: rect.y + (rect.height * h.y) / 100 }));
            }), [nodes]);
           
            const getHandleCoords = (node, handleId) => {
                const rect = getNodeRect(node); const h = (node.type==='LIFELINE'?getHandlesForNode(node):HANDLES).find(x => x.id === handleId);
                if (!h) return { x: rect.x + rect.width / 2, y: rect.y + rect.height / 2 };
                return { x: rect.x + (rect.width * h.x) / 100, y: rect.y + (rect.height * h.y) / 100 };
            };

            const toPaleColor = (hex, alpha = '33') => {
                if (!hex || typeof hex !== 'string') return hex;
                if (hex.startsWith('#') && hex.length === 7) return `${hex}${alpha}`; // #RRGGBB -> #RRGGBBAA
                if (hex.startsWith('#') && hex.length === 4) {
                    // #RGB -> #RRGGBB + alpha
                    const r = hex[1]; const g = hex[2]; const b = hex[3];
                    return `#${r}${r}${g}${g}${b}${b}${alpha}`;
                }
                return hex;
            };

            const getBezierPathAndAngle = (start, end, sourceHandle, targetHandle, type, curvature = 0.5, controlPoint, waypoints = null) => {
                // For step type with custom waypoints
                if (type === 'step' && waypoints && waypoints.length > 0) {
                    // Build path through all waypoints with straight lines
                    let path = `M ${start.x} ${start.y}`;
                    
                    for (const wp of waypoints) {
                        path += ` L ${wp.x} ${wp.y}`;
                    }
                    
                    // Final segment to end
                    path += ` L ${end.x} ${end.y}`;
                    
                    // Calculate end angle from last waypoint to end
                    const lastWp = waypoints[waypoints.length - 1];
                    const angle = Math.atan2(end.y - lastWp.y, end.x - lastWp.x);
                    
                    const midIdx = Math.floor(waypoints.length / 2);
                    const midWp = waypoints[midIdx] || waypoints[0];
                    
                    return { path, angle, midX: midWp.x, midY: midWp.y, waypoints };
                }
                
                // For step type, generate default waypoints based on handle directions
                if (type === 'step') {
                    const dx = end.x - start.x;
                    const dy = end.y - start.y;
                    
                    let path = "";
                    let angle = 0;
                    let midX = (start.x + end.x) / 2;
                    let midY = (start.y + end.y) / 2;
                    let generatedWaypoints = [];
                    
                    // Determine source direction
                    const srcDir = sourceHandle === 'r' ? 'right' : 
                                   sourceHandle === 'l' ? 'left' : 
                                   sourceHandle === 't' ? 'up' : 
                                   sourceHandle === 'b' ? 'down' : 
                                   (sourceHandle && sourceHandle.includes('r')) ? 'right' :
                                   (sourceHandle && sourceHandle.includes('l')) ? 'left' :
                                   (sourceHandle && sourceHandle.includes('t')) ? 'up' :
                                   (sourceHandle && sourceHandle.includes('b')) ? 'down' : 'right';
                    
                    // Determine target direction
                    const tgtDir = targetHandle === 'l' ? 'left' : 
                                   targetHandle === 'r' ? 'right' : 
                                   targetHandle === 't' ? 'up' : 
                                   targetHandle === 'b' ? 'down' :
                                   (targetHandle && targetHandle.includes('l')) ? 'left' :
                                   (targetHandle && targetHandle.includes('r')) ? 'right' :
                                   (targetHandle && targetHandle.includes('t')) ? 'up' :
                                   (targetHandle && targetHandle.includes('b')) ? 'down' : 'left';
                    
                    const isHorizontalSrc = srcDir === 'left' || srcDir === 'right';
                    const isHorizontalTgt = tgtDir === 'left' || tgtDir === 'right';
                    
                    if (isHorizontalSrc && isHorizontalTgt) {
                        const midXPos = (start.x + end.x) / 2;
                        path = `M ${start.x} ${start.y} L ${midXPos} ${start.y} L ${midXPos} ${end.y} L ${end.x} ${end.y}`;
                        angle = dx > 0 ? 0 : Math.PI;
                        midX = midXPos;
                        midY = (start.y + end.y) / 2;
                        generatedWaypoints = [{ x: midXPos, y: start.y }, { x: midXPos, y: end.y }];
                    } else if (!isHorizontalSrc && !isHorizontalTgt) {
                        const midYPos = (start.y + end.y) / 2;
                        path = `M ${start.x} ${start.y} L ${start.x} ${midYPos} L ${end.x} ${midYPos} L ${end.x} ${end.y}`;
                        angle = dy > 0 ? Math.PI / 2 : -Math.PI / 2;
                        midX = (start.x + end.x) / 2;
                        midY = midYPos;
                        generatedWaypoints = [{ x: start.x, y: midYPos }, { x: end.x, y: midYPos }];
                    } else if (isHorizontalSrc && !isHorizontalTgt) {
                        path = `M ${start.x} ${start.y} L ${end.x} ${start.y} L ${end.x} ${end.y}`;
                        angle = dy > 0 ? Math.PI / 2 : -Math.PI / 2;
                        midX = end.x;
                        midY = start.y;
                        generatedWaypoints = [{ x: end.x, y: start.y }];
                    } else {
                        path = `M ${start.x} ${start.y} L ${start.x} ${end.y} L ${end.x} ${end.y}`;
                        angle = dx > 0 ? 0 : Math.PI;
                        midX = start.x;
                        midY = end.y;
                        generatedWaypoints = [{ x: start.x, y: end.y }];
                    }
                    
                    return { path, angle, midX, midY, generatedWaypoints };
                }
                
                // For straight type, ignore control point
                if (type === 'straight') {
                    const path = `M ${start.x} ${start.y} L ${end.x} ${end.y}`;
                    const angle = Math.atan2(end.y - start.y, end.x - start.x);
                    return { path, angle, midX: (start.x+end.x)/2, midY: (start.y+end.y)/2 };
                }
                
                // For bezier with control point
                if (controlPoint) {
                    const path = `M ${start.x} ${start.y} Q ${controlPoint.x} ${controlPoint.y} ${end.x} ${end.y}`;
                    const angle = Math.atan2(end.y - controlPoint.y, end.x - controlPoint.x);
                    return { path, angle, midX: controlPoint.x, midY: controlPoint.y };
                }

                const dist = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                const baseOffset = Math.min(dist * 0.25, 50);
                const offset = baseOffset * (curvature * 2);

                let cp1x = start.x, cp1y = start.y, cp2x = end.x, cp2y = end.y;

                if (sourceHandle.includes('t') || sourceHandle.startsWith('v')) cp1y -= offset;
                else if (sourceHandle.startsWith('v')) { if (end.x > start.x) cp1x += offset; else cp1x -= offset; }
                else {
                    if (sourceHandle.includes('t')) cp1y -= offset;
                    if (sourceHandle.includes('b')) cp1y += offset;
                    if (sourceHandle.includes('l')) cp1x -= offset;
                    if (sourceHandle.includes('r')) cp1x += offset;
                }

                if (targetHandle.startsWith('v')) { if (start.x > end.x) cp2x += offset; else cp2x -= offset; }
                else {
                    if (targetHandle.includes('t')) cp2y -= offset;
                    if (targetHandle.includes('b')) cp2y += offset;
                    if (targetHandle.includes('l')) cp2x -= offset;
                    if (targetHandle.includes('r')) cp2x += offset;
                }

                const path = `M ${start.x} ${start.y} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${end.x} ${end.y}`;
                // Calculate angle at the end of the curve using bezier derivative at t=1
                // For cubic bezier: B(t) = (1-t)Â³P0 + 3(1-t)Â²tP1 + 3(1-t)tÂ²P2 + tÂ³P3
                // Derivative: dB/dt = 3(1-t)Â²(P1-P0) + 6(1-t)t(P2-P1) + 3tÂ²(P3-P2)
                // At t=1: dB/dt = 3(P3-P2) = 3(end-cp2)
                const tangentX = 3 * (end.x - cp2x);
                const tangentY = 3 * (end.y - cp2y);
                const angle = Math.atan2(tangentY, tangentX);
               
                const t = 0.5;
                const midX = (1-t)*(1-t)*(1-t)*start.x + 3*(1-t)*(1-t)*t*cp1x + 3*(1-t)*t*t*cp2x + t*t*t*end.x;
                const midY = (1-t)*(1-t)*(1-t)*start.y + 3*(1-t)*(1-t)*t*cp1y + 3*(1-t)*t*t*cp2y + t*t*t*end.y;

                return { path, angle, midX, midY };
            };
           
            const getConnectionPath = (start, end, sourceHandle, targetHandle, type, curvature, controlPoint) => {
                const { path } = getBezierPathAndAngle(start, end, sourceHandle, targetHandle, type, curvature, controlPoint);
                return path;
            };

            const handleCanvasPointerDown = (e) => {
                const target = e.target;
                const isNodeOrHandle = target.closest('[data-node-id]') || target.closest('[data-handle]') || target.tagName === 'path' || target.tagName === 'circle';
               
                if (target.dataset.controlPoint) {
                    return;
                }

                if (!target.tagName || (target.tagName.toLowerCase() !== 'input' && target.tagName.toLowerCase() !== 'textarea')) {
                    setEditingField(null);
                }

                if (target.closest('.legend-box')) return;
                if (target.closest('.quick-add-handle')) return;
                
                if (e.button === 1 || (e.button === 0 && !isNodeOrHandle)) {
                    if (e.shiftKey) { const pos = getWorldPos(e); setIsSelecting(true); setSelectionBox({ startX: pos.x, startY: pos.y, currentX: pos.x, currentY: pos.y }); }
                    else { setIsPanning(true); setDragStartPos({ x: e.clientX, y: e.clientY }); if (!e.shiftKey) { setSelectedNodeIds([]); setSelectedConnectionId(null); setShowQuickAddHandles(false); } }
                }
            };
           
            
            const handleQuickAddNode = (direction, sourceNode) => {
                if (!sourceNode) return;
                const offset = 200;
                let newX = sourceNode.x;
                let newY = sourceNode.y;
                let targetHandle = 'l';
                let sourceHandle = 'r';
                
                if (direction === 'right') { newX = sourceNode.x + (sourceNode.width || 160) + offset; targetHandle = 'l'; sourceHandle = 'r'; }
                else if (direction === 'left') { newX = sourceNode.x - offset; targetHandle = 'r'; sourceHandle = 'l'; }
                else if (direction === 'down') { newY = sourceNode.y + (sourceNode.height || 100) + offset; targetHandle = 't'; sourceHandle = 'b'; }
                else if (direction === 'up') { newY = sourceNode.y - offset; targetHandle = 'b'; sourceHandle = 't'; }
                
                const newNodeId = Date.now().toString();
                const newNode = {
                    id: newNodeId,
                    type: sourceNode.type === 'SWIMLANE' ? 'COMPONENT' : sourceNode.type,
                    x: newX,
                    y: newY,
                    // Boyut - kaynak kutunun boyutunu kopyala
                    width: sourceNode.width || 160,
                    height: sourceNode.height || 100,
                    // Temel bilgiler - boş bırak (kullanıcı dolduracak)
                    title: 'Yeni Node',
                    description: '',
                    techStack: sourceNode.techStack || '',
                    owner: sourceNode.owner || 'SİSTEM',
                    stepNumber: '',
                    hasRisk: false,
                    customColor: sourceNode.customColor || null,
                    methods: sourceNode.methods || '',
                    // Header ayarları
                    headerHeight: sourceNode.headerHeight || 32,
                    titleHeight: sourceNode.titleHeight || 28,
                    headerPosition: sourceNode.headerPosition || 'top',
                    headerColor: sourceNode.headerColor,
                    // Header yazı ayarları
                    headerFontSize: sourceNode.headerFontSize || 10,
                    headerFontColor: sourceNode.headerFontColor || '#1f2937',
                    headerFontFamily: sourceNode.headerFontFamily || "'Segoe UI', Tahoma, sans-serif",
                    headerFontWeight: sourceNode.headerFontWeight || 800,
                    // BİLEŞEN (techStack) yazı ayarları
                    techStackFontSize: sourceNode.techStackFontSize || 9,
                    techStackFontColor: sourceNode.techStackFontColor || '#475569',
                    techStackFontFamily: sourceNode.techStackFontFamily || "'Segoe UI', Tahoma, sans-serif",
                    techStackFontWeight: sourceNode.techStackFontWeight || 700,
                    techStackBgColor: sourceNode.techStackBgColor,
                    // BAŞLIK yazı ayarları
                    titleFontSize: sourceNode.titleFontSize,
                    titleFontColor: sourceNode.titleFontColor,
                    titleFontFamily: sourceNode.titleFontFamily,
                    titleFontWeight: sourceNode.titleFontWeight,
                    // AÇIKLAMA yazı ayarları
                    descriptionFontSize: sourceNode.descriptionFontSize,
                    descriptionFontColor: sourceNode.descriptionFontColor,
                    descriptionFontFamily: sourceNode.descriptionFontFamily,
                    descriptionFontWeight: sourceNode.descriptionFontWeight,
                    // Görünüm - kutu renkleri
                    backgroundColor: sourceNode.backgroundColor || toPaleColor('#ffffff', '55'),
                    borderColor: sourceNode.borderColor || '#0f172a',
                    boxBgColor: sourceNode.boxBgColor,
                    boxBorderColor: sourceNode.boxBorderColor,
                    borderWidth: sourceNode.borderWidth,
                    borderStyle: sourceNode.borderStyle,
                    // Sağ alt etiket (tag) - stiller kopyalanır, içerik boş
                    tag: '',
                    tagBgColor: sourceNode.tagBgColor,
                    tagTextColor: sourceNode.tagTextColor,
                    tagBorderColor: sourceNode.tagBorderColor,
                    // Teknik not - içerik boş başlar
                    note: ''
                };
                
                setNodes(prev => [...prev, newNode]);
                setConnections(prev => [...prev, {
                    id: Date.now().toString() + '_conn',
                    from: sourceNode.id,
                    sourceHandle: sourceHandle,
                    to: newNodeId,
                    targetHandle: targetHandle,
                    label: '',
                    type: 'straight',
                    startArrow: 'none',
                    endArrow: 'standard',
                    animated: false
                }]);
                setSelectedNodeIds([newNodeId]);
                setShowQuickAddHandles(false);
            };

            const handleNodePointerDown = (e, nodeId) => {
                e.stopPropagation();
                if (e.button !== 0) return;
                if (editingField) return;

                let newSelectedIds = [...selectedNodeIds];
               
                if (e.shiftKey) {
                    if (newSelectedIds.includes(nodeId)) newSelectedIds = newSelectedIds.filter(id => id !== nodeId);
                    else newSelectedIds.push(nodeId);
                 } else {
                     if (!newSelectedIds.includes(nodeId)) newSelectedIds = [nodeId];
                     // If clicked node belongs to a group, select the whole group
                     const clickedNode = nodes.find(n => n.id === nodeId);
                     if (clickedNode && clickedNode.groupId) {
                        newSelectedIds = nodes.filter(n => n.groupId === clickedNode.groupId).map(n => n.id);
                     }
                 }
                setSelectedNodeIds(newSelectedIds); 
                setSelectedConnectionId(null); 
                setIsDraggingNode(true); 
                setDragStartPos(getWorldPos(e)); 
                const posMap = {}; 
                nodes.forEach(n => { if (newSelectedIds.includes(n.id)) posMap[n.id] = { x: n.x, y: n.y }; }); 
                setInitialNodePositions(posMap);
                initialNodePositionsRef.current = posMap;
                
                // Show quick add handles for single selection
                if (newSelectedIds.length === 1 && !e.shiftKey) {
                    const node = nodes.find(n => n.id === nodeId);
                    if (node && node.type !== 'SWIMLANE') {
                        setShowQuickAddHandles(true);
                    } else {
                        setShowQuickAddHandles(false);
                    }
                } else {
                    setShowQuickAddHandles(false);
                }
            };

            const handleResizePointerDown = (e, nodeId, handleId) => {
                e.stopPropagation(); e.preventDefault(); setIsResizing(true); 
                const pos = getWorldPos(e); 
                const posMap = {}; 
                // Save all nodes positions (for swimlane linked resize)
                nodes.forEach(n => { 
                    posMap[n.id] = { x: n.x, y: n.y, w: n.width || (n.type === 'SWIMLANE' ? 350 : 160), h: n.height || (n.type === 'SWIMLANE' ? 500 : 100) }; 
                }); 
                setResizeStart({ id: nodeId, startX: pos.x, startY: pos.y, handle: handleId, nodesMap: posMap });
            };

            const handleSpecificResizeStart = (e, nodeId, handleId) => { handleResizePointerDown(e, nodeId, handleId); }
            const attachGlobalPointerListeners = () => {
                window.addEventListener('pointermove', handlePointerMove, { passive: false });
                window.addEventListener('pointerup', handlePointerUp);
                document.addEventListener('pointermove', handlePointerMove, { passive: false });
                document.addEventListener('pointerup', handlePointerUp);
            };
            const detachGlobalPointerListeners = () => {
                window.removeEventListener('pointermove', handlePointerMove);
                window.removeEventListener('pointerup', handlePointerUp);
                document.removeEventListener('pointermove', handlePointerMove);
                document.removeEventListener('pointerup', handlePointerUp);
            };

            const handleHandlePointerDown = (e, nodeId, handleId) => { 
                console.log('Handle pointer down:', { nodeId, handleId, isConnecting }); 
                e.stopPropagation(); 
                e.preventDefault(); 
                // Capture the pointer so move events keep firing (Edge/Safari friendly)
                if (e.pointerId && e.target?.setPointerCapture) {
                    try { e.target.setPointerCapture(e.pointerId); } catch (_) {}
                }
                const pos = getWorldPos(e); 
                setIsConnecting(true); 
                setConnectionStartInfo({ nodeId, handle: handleId }); 
                setTempConnectionEnd(pos);
                attachGlobalPointerListeners();
            };
            const handleConnectionDragStart = (e, connectionId, type) => { e.stopPropagation(); e.preventDefault(); const conn = connections.find(c => c.id === connectionId); if(!conn) return; setIsReconnecting(true); setReconnectInfo({ connectionId, type }); const otherNodeId = type === 'source' ? conn.to : conn.from; const otherHandle = type === 'source' ? (conn.targetHandle || 'l') : (conn.sourceHandle || 'r'); setConnectionStartInfo({ nodeId: otherNodeId, handle: otherHandle }); setTempConnectionEnd(getWorldPos(e)); attachGlobalPointerListeners(); };
            const handleConnectionSelect = (e, connId) => { 
                e.stopPropagation(); 
                if (!isReconnecting && !isDraggingControlPoint) { 
                    setSelectedConnectionId(connId); 
                    setSelectedNodeIds([]); 
                    setShowQuickAddHandles(false);
                } 
            };
           
            // Connection Control Point Handler
            const handleConnectionControlPointDown = (e, connId) => {
                e.stopPropagation(); e.preventDefault();
                setIsDraggingControlPoint(true);
                setSelectedConnectionId(connId);
            };
            
            // Waypoint drag handler for step lines
            const handleWaypointDown = (e, connId, waypointIndex) => {
                e.stopPropagation(); e.preventDefault();
                setDraggingWaypointInfo({ connId, waypointIndex });
                setSelectedConnectionId(connId);
            };

            const handlePointerMove = (e) => {
                e.preventDefault(); if (isDraggingLegend) return;
                const pos = getWorldPos(e);

                if (isDraggingControlPoint && selectedConnectionId) {
                    setConnections(prev => prev.map(c => c.id === selectedConnectionId ? { ...c, controlPoint: { x: pos.x, y: pos.y } } : c));
                    return;
                }
                
                // Handle waypoint dragging for step lines
                if (draggingWaypointInfo) {
                    const { connId, waypointIndex } = draggingWaypointInfo;
                    setConnections(prev => prev.map(c => {
                        if (c.id === connId) {
                            const waypoints = c.waypoints ? [...c.waypoints] : [];
                            if (waypoints[waypointIndex]) {
                                waypoints[waypointIndex] = { x: pos.x, y: pos.y };
                            } else {
                                waypoints[waypointIndex] = { x: pos.x, y: pos.y };
                            }
                            return { ...c, waypoints };
                        }
                        return c;
                    }));
                    return;
                }

                if (isPanning) { const dx = e.clientX - dragStartPos.x; const dy = e.clientY - dragStartPos.y; setPan(prev => ({ x: prev.x + dx, y: prev.y + dy })); setDragStartPos({ x: e.clientX, y: e.clientY }); return; }
                if (isSelecting) { setSelectionBox(prev => ({ ...prev, currentX: pos.x, currentY: pos.y })); return; }
               
                if (isResizing && resizeStart) {
                    const deltaX = pos.x - resizeStart.startX; const deltaY = pos.y - resizeStart.startY; const { handle, nodesMap } = resizeStart;
                    const resizingNodeInit = nodesMap[resizeStart.id];
                    const resizingNode = nodes.find(n => n.id === resizeStart.id);
                    const isSwimlaneResize = resizingNode && resizingNode.type === 'SWIMLANE';
                    
                    if (!resizingNodeInit) return;
                    
                    // Calculate new dimensions for resizing node
                    const init = resizingNodeInit;
                    let newX = init.x, newY = init.y, newW = init.w, newH = init.h;
                    
                    if (handle.includes('r')) newW = Math.max(50, init.w + deltaX);
                    if (handle.includes('l')) { newW = Math.max(50, init.w - deltaX); newX = init.x + (init.w - newW); }
                    if (handle.includes('b')) newH = Math.max(50, init.h + deltaY);
                    if (handle.includes('t')) { newH = Math.max(50, init.h - deltaY); newY = init.y + (init.h - newH); }
                    
                    // Find adjacent swimlanes for linked resizing
                    const adjacentUpdates = {};
                    if (isSwimlaneResize) {
                        const oldRight = init.x + init.w;
                        const oldBottom = init.y + init.h;
                        const ADJACENT_THRESHOLD = 20;
                        
                        const isRightEdge = handle === 'r' || handle === 'tr' || handle === 'br';
                        const isLeftEdge = handle === 'l' || handle === 'tl' || handle === 'bl';
                        const isBottomEdge = handle === 'b' || handle === 'br' || handle === 'bl';
                        const isTopEdge = handle === 't' || handle === 'tr' || handle === 'tl';
                        
                        Object.keys(nodesMap).forEach(otherId => {
                            if (otherId === resizeStart.id) return;
                            const otherNode = nodes.find(n => n.id === otherId);
                            if (!otherNode || otherNode.type !== 'SWIMLANE') return;
                            
                            const otherInit = nodesMap[otherId];
                            const otherRight = otherInit.x + otherInit.w;
                            const otherBottom = otherInit.y + otherInit.h;
                            
                            const rightGap = Math.abs(oldRight - otherInit.x);
                            const leftGap = Math.abs(init.x - otherRight);
                            
                            if (isRightEdge && rightGap < ADJACENT_THRESHOLD) {
                                adjacentUpdates[otherId] = { 
                                    x: otherInit.x + deltaX, 
                                    width: Math.max(50, otherInit.w - deltaX) 
                                };
                            }
                            if (isLeftEdge && leftGap < ADJACENT_THRESHOLD) {
                                adjacentUpdates[otherId] = { 
                                    width: Math.max(50, otherInit.w + deltaX) 
                                };
                            }
                            if (isBottomEdge && Math.abs(oldBottom - otherInit.y) < ADJACENT_THRESHOLD) {
                                adjacentUpdates[otherId] = { 
                                    ...adjacentUpdates[otherId],
                                    y: otherInit.y + deltaY, 
                                    height: Math.max(50, otherInit.h - deltaY) 
                                };
                            }
                            if (isTopEdge && Math.abs(init.y - otherBottom) < ADJACENT_THRESHOLD) {
                                adjacentUpdates[otherId] = { 
                                    ...adjacentUpdates[otherId],
                                    height: Math.max(50, otherInit.h + deltaY) 
                                };
                            }
                        });
                    }
                    
                    setNodes(prev => prev.map(n => {
                        if (n.id === resizeStart.id) {
                            return { ...n, x: newX, y: newY, width: newW, height: newH };
                        }
                        if (adjacentUpdates[n.id]) {
                            const upd = adjacentUpdates[n.id];
                            return { 
                                ...n, 
                                x: upd.x !== undefined ? upd.x : n.x,
                                y: upd.y !== undefined ? upd.y : n.y,
                                width: upd.width !== undefined ? upd.width : n.width,
                                height: upd.height !== undefined ? upd.height : n.height
                            };
                        }
                        // Handle multi-select resize for non-adjacent nodes
                        if (selectedNodeIds.includes(n.id) && nodesMap[n.id] && n.id !== resizeStart.id && !adjacentUpdates[n.id]) {
                            const init2 = nodesMap[n.id]; let x2 = init2.x, y2 = init2.y, w2 = init2.w, h2 = init2.h;
                            if (handle.includes('r')) w2 = Math.max(50, init2.w + deltaX);
                            if (handle.includes('l')) { w2 = Math.max(50, init2.w - deltaX); x2 = init2.x + (init2.w - w2); }
                            if (handle.includes('b')) h2 = Math.max(50, init2.h + deltaY);
                            if (handle.includes('t')) { h2 = Math.max(50, init2.h - deltaY); y2 = init2.y + (init2.h - h2); }
                            return { ...n, x: x2, y: y2, width: w2, height: h2 };
                        }
                        return n;
                    })); 
                    return;
                }
               
                if (isDraggingNode && selectedNodeIds.length > 0) {
                    const dx = pos.x - dragStartPos.x; const dy = pos.y - dragStartPos.y;
                    dragDeltaRef.current = { dx, dy };
                    if (!dragRafRef.current) {
                        dragRafRef.current = requestAnimationFrame(() => {
                            const { dx, dy } = dragDeltaRef.current || { dx: 0, dy: 0 };
                            const ids = selectedNodeIdsRef.current;
                            const initMap = initialNodePositionsRef.current;
                            
                            // Swimlane snap logic
                            let snapDx = dx, snapDy = dy;
                            const newSnapLines = [];
                            
                            // Check if we're dragging a swimlane
                            const draggedSwimlanes = nodes.filter(n => ids.includes(n.id) && n.type === 'SWIMLANE');
                            const otherSwimlanes = nodes.filter(n => !ids.includes(n.id) && n.type === 'SWIMLANE');
                            
                            if (draggedSwimlanes.length === 1 && otherSwimlanes.length > 0) {
                                const dragged = draggedSwimlanes[0];
                                const draggedInit = initMap[dragged.id];
                                if (draggedInit) {
                                    const draggedNewX = draggedInit.x + dx;
                                    const draggedNewY = draggedInit.y + dy;
                                    const draggedW = dragged.width || 350;
                                    const draggedH = dragged.height || 500;
                                    const draggedRight = draggedNewX + draggedW;
                                    const draggedBottom = draggedNewY + draggedH;
                                    
                                    for (const other of otherSwimlanes) {
                                        const otherW = other.width || 350;
                                        const otherH = other.height || 500;
                                        const otherRight = other.x + otherW;
                                        const otherBottom = other.y + otherH;
                                        
                                        // Snap right edge to left edge (yan yana - sağ)
                                        if (Math.abs(draggedRight - other.x) < SNAP_THRESHOLD) {
                                            snapDx = dx + (other.x - draggedRight);
                                            newSnapLines.push({ type: 'vertical', x: other.x, y1: Math.min(draggedNewY, other.y), y2: Math.max(draggedBottom, otherBottom) });
                                        }
                                        // Snap left edge to right edge (yan yana - sol)
                                        if (Math.abs(draggedNewX - otherRight) < SNAP_THRESHOLD) {
                                            snapDx = dx + (otherRight - draggedNewX);
                                            newSnapLines.push({ type: 'vertical', x: otherRight, y1: Math.min(draggedNewY, other.y), y2: Math.max(draggedBottom, otherBottom) });
                                        }
                                        // Snap top edges
                                        if (Math.abs(draggedNewY - other.y) < SNAP_THRESHOLD) {
                                            snapDy = dy + (other.y - draggedNewY);
                                            newSnapLines.push({ type: 'horizontal', y: other.y, x1: Math.min(draggedNewX, other.x), x2: Math.max(draggedRight, otherRight) });
                                        }
                                        // Snap bottom edges
                                        if (Math.abs(draggedBottom - otherBottom) < SNAP_THRESHOLD) {
                                            snapDy = dy + (otherBottom - draggedBottom);
                                            newSnapLines.push({ type: 'horizontal', y: otherBottom, x1: Math.min(draggedNewX, other.x), x2: Math.max(draggedRight, otherRight) });
                                        }
                                        // Snap bottom to top (alt alta)
                                        if (Math.abs(draggedBottom - other.y) < SNAP_THRESHOLD) {
                                            snapDy = dy + (other.y - draggedBottom);
                                            newSnapLines.push({ type: 'horizontal', y: other.y, x1: Math.min(draggedNewX, other.x), x2: Math.max(draggedRight, otherRight) });
                                        }
                                        // Snap top to bottom (alt alta)
                                        if (Math.abs(draggedNewY - otherBottom) < SNAP_THRESHOLD) {
                                            snapDy = dy + (otherBottom - draggedNewY);
                                            newSnapLines.push({ type: 'horizontal', y: otherBottom, x1: Math.min(draggedNewX, other.x), x2: Math.max(draggedRight, otherRight) });
                                        }
                                    }
                                }
                            }
                            
                            setSnapLines(newSnapLines);
                            
                            setNodes(prev => prev.map(n => {
                                if (ids.includes(n.id) && initMap[n.id]) {
                                    return { ...n, x: initMap[n.id].x + snapDx, y: initMap[n.id].y + snapDy };
                                }
                                return n;
                            }));
                            dragRafRef.current = null;
                        });
                    }
                    if (selectedNodeIds.length === 1) setSwimlaneGuide(null);
                }
                if (isConnecting || isReconnecting) { 
                    setTempConnectionEnd(pos); 
                    const elements = document.elementsFromPoint(e.clientX, e.clientY); 
                    let handleEl = elements.find(el => el.getAttribute('data-handle') && el.getAttribute('data-node-id')); 
                    
                    // If no handle found at exact position, search nearby
                    if (!handleEl) {
                        const handleEls = Array.from(document.querySelectorAll('[data-handle][data-node-id]'));
                        if (handleEls.length > 0) {
                            let closest = null;
                            let minDist = 60; // 60px search radius for easier connection
                            handleEls.forEach(el => {
                                const rect = el.getBoundingClientRect();
                                const dist = Math.hypot(e.clientX - (rect.left + rect.width / 2), e.clientY - (rect.top + rect.height / 2));
                                if (dist < minDist) {
                                    minDist = dist;
                                    closest = el;
                                }
                            });
                            handleEl = closest;
                        }
                    }
                    
                    if (handleEl) setHoveredHandle({ nodeId: handleEl.getAttribute('data-node-id'), handle: handleEl.getAttribute('data-handle') }); 
                    else setHoveredHandle(null); 
                }
            };

            const handlePointerUp = () => {
                setIsDraggingControlPoint(false);
                setDraggingWaypointInfo(null);
                setSnapLines([]); // Clear snap lines
                if (isPanning) { setIsPanning(false); return; }
                if (isSelecting) { const x1 = Math.min(selectionBox.startX, selectionBox.currentX); const x2 = Math.max(selectionBox.startX, selectionBox.currentX); const y1 = Math.min(selectionBox.startY, selectionBox.currentY); const y2 = Math.max(selectionBox.startY, selectionBox.currentY); const newlySelected = nodes.filter(n => { const nRight = n.x + (n.width || 160); const nBottom = n.y + (n.height || 100); return n.x < x2 && nRight > x1 && n.y < y2 && nBottom > y1; }).map(n => n.id); setSelectedNodeIds(newlySelected); setIsSelecting(false); setSelectionBox(null); return; }
                if (isResizing) { setIsResizing(false); setResizeStart(null); return; }
                if (isConnecting || isReconnecting) { 
                    if (hoveredHandle && connectionStartInfo) { 
                        let sourceNodeId, sourceHandle, targetNodeId, targetHandle; 
                        if (isReconnecting) { 
                            const conn = connections.find(c => c.id === reconnectInfo.connectionId); 
                            if (conn) { 
                                if (reconnectInfo.type === 'target') { 
                                    sourceNodeId = conn.from; 
                                    sourceHandle = conn.sourceHandle || 'r'; 
                                    targetNodeId = hoveredHandle.nodeId; 
                                    targetHandle = hoveredHandle.handle; 
                                } else { 
                                    sourceNodeId = hoveredHandle.nodeId; 
                                    sourceHandle = hoveredHandle.handle; 
                                    targetNodeId = conn.to; 
                                    targetHandle = conn.targetHandle || 'l'; 
                                } 
                                if (sourceNodeId !== targetNodeId) setConnections(prev => prev.map(c => c.id === conn.id ? { ...c, from: sourceNodeId, sourceHandle, to: targetNodeId, targetHandle } : c)); 
                            } 
                        } else { 
                            sourceNodeId = connectionStartInfo.nodeId; 
                            sourceHandle = connectionStartInfo.handle; 
                            targetNodeId = hoveredHandle.nodeId; 
                            targetHandle = hoveredHandle.handle; 
                            if (sourceNodeId !== targetNodeId) { 
                                const exists = connections.some(c => c.from === sourceNodeId && c.to === targetNodeId && c.sourceHandle === sourceHandle && c.targetHandle === targetHandle); 
                                if (!exists) setConnections(prev => [...prev, { id: Date.now().toString(), from: sourceNodeId, sourceHandle, to: targetNodeId, targetHandle, label: '', type: 'straight', startArrow: 'none', endArrow: 'standard', animated: false }]); 
                            } 
                        } 
                    } 
                    setIsDraggingNode(false); 
                    setIsConnecting(false); 
                    setIsReconnecting(false); 
                    setConnectionStartInfo(null); 
                    setReconnectInfo(null); 
                    setHoveredHandle(null); 
                    setSwimlaneGuide(null);
                    detachGlobalPointerListeners();
                }
                setIsDraggingNode(false);
                if (!isDraggingNode) setSwimlaneGuide(null);
                if (dragRafRef.current) { cancelAnimationFrame(dragRafRef.current); dragRafRef.current = null; }
                dragDeltaRef.current = null;
            };

            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
            const handleDrop = (e) => { e.preventDefault(); const typeKey = e.dataTransfer.getData('application/reactflow'); if (typeKey) { const pos = getWorldPos(e); addNode(typeKey, pos); } };

            const selectedNode = selectedNodeIds.length === 1 ? nodes.find(n => n.id === selectedNodeIds[0]) : null;
            const isMultiSelect = selectedNodeIds.length > 1;
            const selectedConnection = connections.find(c => c.id === selectedConnectionId);
            const swimlanes = nodes.filter(n => n.type === 'SWIMLANE');
            const otherNodes = nodes.filter(n => n.type !== 'SWIMLANE');
           
            // Tooltip component
            const Tooltip = ({ children, text, side = 'right' }) => {
                const [isHovered, setIsHovered] = useState(false);
                const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });
                const buttonRef = useRef(null);
                
                const handleMouseEnter = (e) => {
                    setIsHovered(true);
                    if (buttonRef.current) {
                        const rect = buttonRef.current.getBoundingClientRect();
                        if (side === 'right') {
                            setTooltipPos({ x: rect.right + 8, y: rect.top + rect.height / 2 });
                        } else {
                            setTooltipPos({ x: rect.left + rect.width / 2, y: rect.top - 32 });
                        }
                    }
                };
                
                return (
                    <>
                        <div 
                            ref={buttonRef}
                            onMouseEnter={handleMouseEnter}
                            onMouseLeave={() => setIsHovered(false)}
                            className="relative"
                        >
                            {children}
                        </div>
                        {isHovered && text && (
                            <div 
                                className="tooltip"
                                style={{ 
                                    left: `${tooltipPos.x}px`, 
                                    top: `${tooltipPos.y}px`,
                                    transform: side === 'right' ? 'translateY(-50%)' : 'translateX(-50%) translateY(-100%)'
                                }}
                            >
                                {text}
                            </div>
                        )}
                    </>
                );
            };

            // Node tool definitions
            const nodeTools = [
                { type: 'START', icon: PlayCircle, label: 'Başlangıç Düğümü', color: 'text-emerald-600', group: 'flow' },
                { type: 'END', icon: StopCircle, label: 'Bitiş Düğümü', color: 'text-slate-900', group: 'flow' },
                { type: 'DECISION', icon: GitBranch, label: 'Kontrol / Sorgu', color: 'text-amber-600', group: 'flow' },
                { type: 'SWIMLANE', icon: Layout, label: 'Kulvar / Alan', color: 'text-slate-500', group: 'flow' },
                { type: 'LIFELINE', icon: ArrowDown, label: 'Sıralama Çizgisi', color: 'text-slate-700', group: 'uml' },
                { type: 'UML_CLASS', icon: BoxSelect, label: 'UML Sınıf', color: 'text-slate-700', group: 'uml' },
                { type: 'SERVER', icon: Server, label: 'Backend Sistemi', color: 'text-blue-600', group: 'tech' },
                { type: 'DATABASE', icon: Database, label: 'Veritabanı', color: 'text-green-600', group: 'tech' },
                { type: 'WEB', icon: Globe, label: 'Web Portal', color: 'text-purple-600', group: 'tech' },
                { type: 'MOBILE', icon: Smartphone, label: 'Mobil Uygulama', color: 'text-pink-600', group: 'tech' },
                { type: 'USER', icon: User, label: 'Kullanıcı', color: 'text-yellow-600', group: 'tech' },
                { type: 'PROCESS', icon: Activity, label: 'Süreç', color: 'text-orange-600', group: 'tech' },
                { type: 'COMPONENT', icon: Box, label: 'Rapor / Bileşen', color: 'text-gray-600', group: 'tech' },
                { type: 'MANUAL', icon: Keyboard, label: 'Manuel Giriş', color: 'text-slate-600', group: 'tech' },
            ];
            
            const actionTools = [
                { icon: Download, label: 'Dışa Aktar', action: () => setShowExportModal(true), group: 'file' },
                { icon: Upload, label: 'İçe Aktar', action: handleImportClick, group: 'file' },
                { icon: Copy, label: 'Şablonlar', action: () => setShowTemplateModal(true), color: 'text-indigo-600', group: 'file' },
            ];
            
            const viewTools = [
                { icon: ZoomIn, label: 'Yakınlaştır', action: zoomIn, group: 'view' },
                { icon: ZoomOut, label: 'Uzaklaştır', action: zoomOut, group: 'view' },
                { icon: Maximize, label: 'Sığdır', action: fitToScreen, group: 'view' },
                { icon: Search, label: 'Ara', action: () => setShowSearchModal(true), group: 'view' },
            ];
            
            const alignTools = [
                { icon: AlignLeft, label: 'Sola Hizala', action: () => alignNodes('left'), group: 'align', needSelection: true },
                { icon: AlignCenter, label: 'Ortaya Hizala', action: () => alignNodes('centerH'), group: 'align', needSelection: true },
                { icon: AlignRight, label: 'Sağa Hizala', action: () => alignNodes('right'), group: 'align', needSelection: true },
                { icon: ArrowDown, label: 'Yatay Dağıt', action: () => distributeNodes('horizontal'), group: 'align', needSelection: true },
                { icon: ArrowDown, label: 'Dikey Dağıt', action: () => distributeNodes('vertical'), group: 'align', needSelection: true },
                { icon: Lock, label: 'Kilitle/Aç', action: toggleLock, group: 'align', needSelection: true },
            ];
            
            const utilTools = [
                { icon: Info, label: 'Lejant', action: () => { try { setShowLegend(!showLegend); } catch(err) { console.error('Legend toggle error:', err); } }, active: showLegend, group: 'util' },
                { icon: Sparkles, label: 'AI Analiz', action: handleAiArchitectureAudit, color: 'text-purple-600', group: 'util' },
                { icon: RefreshCw, label: 'Sıfırla', action: resetCanvas, color: 'text-red-600', group: 'util' },
            ];

            return (
                <div className="flex flex-col h-screen font-mono text-slate-900 overflow-hidden relative select-none bg-[#fafafa]">
                    {/* Main Content Area */}
                    <div className="flex flex-row flex-1 overflow-hidden">
                    {/* Mobile Header */}
                    <div className="md:hidden h-14 bg-white/95 backdrop-blur-sm border-b border-slate-200 flex items-center justify-between px-4 z-30 shrink-0">
                        <div className="flex items-center gap-2"><Cpu className="w-5 h-5 text-slate-700" /><span className="font-bold text-sm text-slate-800">ARCH.STUDIO</span></div>
                        <button onClick={() => setShowExportModal(true)} className="p-2 bg-emerald-50 rounded-lg border border-emerald-200 hover:bg-emerald-100 transition-colors"><Download className="w-4 h-4 text-emerald-700" /></button>
                    </div>
                    
                    {/* Mobile Overlay */}
                    <div className={`fixed inset-0 z-40 bg-black/50 transition-opacity md:hidden ${showLeftPanel ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={() => setShowLeftPanel(false)} />
                    
                    {/* Icon-Based Sidebar - Hover Expandable */}
                    <div 
                        className={`fixed md:relative top-0 bottom-0 bg-white/95 backdrop-blur-sm border-r border-slate-200 flex flex-col z-50 transition-all duration-300 md:translate-x-0 ${showLeftPanel ? 'translate-x-0' : '-translate-x-full md:translate-x-0'} ${isLeftPanelExpanded || isLeftPanelPinned ? 'w-64' : 'w-16'}`}
                        onMouseEnter={() => !isLeftPanelPinned && setIsLeftPanelExpanded(true)}
                        onMouseLeave={() => !isLeftPanelPinned && setIsLeftPanelExpanded(false)}
                    >
                        <div className="p-3 border-b border-slate-200 flex items-center justify-between">
                            <button className="md:hidden p-2 hover:bg-slate-100 rounded-lg transition-colors" onClick={() => setShowLeftPanel(false)}><X className="w-5 h-5 text-slate-600" /></button>
                            <div className="hidden md:flex items-center gap-2 flex-1">
                                <Layers className="w-5 h-5 text-slate-700 flex-shrink-0" />
                                {(isLeftPanelExpanded || isLeftPanelPinned) && <span className="text-xs font-bold text-slate-700 whitespace-nowrap">ARAÇLAR</span>}
                            </div>
                            {(isLeftPanelExpanded || isLeftPanelPinned) && (
                                <button 
                                    className={`hidden md:block p-1.5 rounded-lg transition-colors ${
                                        isLeftPanelPinned 
                                            ? 'bg-blue-100 text-blue-600 hover:bg-blue-200' 
                                            : 'hover:bg-slate-100 text-slate-400'
                                    }`}
                                    onClick={() => setIsLeftPanelPinned(!isLeftPanelPinned)}
                                    title={isLeftPanelPinned ? 'Sabitlemeyi Kaldır' : 'Sabitle'}
                                >
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        {isLeftPanelPinned ? (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5l14 14M5 19l6-6M19 5l-6 6" />
                                        ) : (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5l14 14M19 19l-6-6M5 19l6-6" />
                                        )}
                                    </svg>
                                </button>
                            )}
                        </div>
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar py-2 px-1.5">
                            {/* Flow Tools */}
                            <div className="mb-4">
                                {nodeTools.filter(t => t.group === 'flow').map(tool => {
                                    const ToolIcon = tool.icon;
                                    return (
                                        <button
                                            key={tool.type}
                                            draggable
                                            onDragStart={(e) => e.dataTransfer.setData('application/reactflow', tool.type)}
                                            onClick={() => { addNode(tool.type); if (window.innerWidth < 768) setShowLeftPanel(false); }}
                                            className="w-full p-2.5 mb-1.5 rounded-lg hover:bg-slate-100 transition-colors flex items-center gap-3 group"
                                            title={tool.label}
                                        >
                                            <ToolIcon className={`w-5 h-5 ${tool.color || 'text-slate-700'} group-hover:scale-110 transition-transform flex-shrink-0`} />
                                            {(isLeftPanelExpanded || isLeftPanelPinned) && <span className="text-xs font-medium text-slate-700 whitespace-nowrap">{tool.label}</span>}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {/* Divider */}
                            <div className="h-px bg-slate-200 mb-4 mx-2"></div>
                            
                            {/* UML Tools */}
                            <div className="mb-4">
                                {nodeTools.filter(t => t.group === 'uml').map(tool => {
                                    const ToolIcon = tool.icon;
                                    return (
                                        <button
                                            key={tool.type}
                                            draggable
                                            onDragStart={(e) => e.dataTransfer.setData('application/reactflow', tool.type)}
                                            onClick={() => { addNode(tool.type); if (window.innerWidth < 768) setShowLeftPanel(false); }}
                                            className="w-full p-2.5 mb-1.5 rounded-lg hover:bg-slate-100 transition-colors flex items-center gap-3 group"
                                        >
                                            <ToolIcon className={`w-5 h-5 ${tool.color || 'text-slate-700'} group-hover:scale-110 transition-transform flex-shrink-0`} />
                                            {(isLeftPanelExpanded || isLeftPanelPinned) && <span className="text-xs font-medium text-slate-700 whitespace-nowrap">{tool.label}</span>}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {/* Divider */}
                            <div className="h-px bg-slate-200 mb-4 mx-2"></div>
                            
                            {/* Tech Components */}
                            <div className="mb-4">
                                {nodeTools.filter(t => t.group === 'tech').map(tool => {
                                    const ToolIcon = tool.icon;
                                    return (
                                        <button
                                            key={tool.type}
                                            draggable
                                            onDragStart={(e) => e.dataTransfer.setData('application/reactflow', tool.type)}
                                            onClick={() => { addNode(tool.type); if (window.innerWidth < 768) setShowLeftPanel(false); }}
                                            className="w-full p-2.5 mb-1.5 rounded-lg hover:bg-slate-100 transition-colors flex items-center gap-3 group"
                                        >
                                            <ToolIcon className={`w-5 h-5 ${tool.color || 'text-slate-700'} group-hover:scale-110 transition-transform flex-shrink-0`} />
                                            {(isLeftPanelExpanded || isLeftPanelPinned) && <span className="text-xs font-medium text-slate-700 whitespace-nowrap">{tool.label}</span>}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                        
                        {/* Bottom Tools Section */}
                        <div className="border-t border-slate-200 py-2 px-1.5">
                            {/* Görünüm Araçları */}
                            {(isLeftPanelExpanded || isLeftPanelPinned) && <div className="text-[9px] font-bold text-slate-400 px-2.5 mb-1 uppercase">Görünüm</div>}
                            <div className="flex flex-wrap gap-1 mb-2">
                                {viewTools.map((tool, idx) => {
                                    const ToolIcon = tool.icon;
                                    return (
                                        <button key={idx} onClick={tool.action} className="p-2 rounded-lg hover:bg-slate-100 transition-colors group" title={tool.label}>
                                            <ToolIcon className={`w-4 h-4 ${tool.color || 'text-slate-600'} group-hover:scale-110 transition-transform`} />
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {/* Hizalama Araçları */}
                            {selectedNodeIds.length >= 2 && (
                                <>
                                    {(isLeftPanelExpanded || isLeftPanelPinned) && <div className="text-[9px] font-bold text-slate-400 px-2.5 mb-1 uppercase">Hizalama</div>}
                                    <div className="flex flex-wrap gap-1 mb-2">
                                        {alignTools.slice(0, 3).map((tool, idx) => {
                                            const ToolIcon = tool.icon;
                                            return (
                                                <button key={idx} onClick={tool.action} className="p-2 rounded-lg hover:bg-blue-100 transition-colors group" title={tool.label}>
                                                    <ToolIcon className="w-4 h-4 text-blue-600 group-hover:scale-110 transition-transform" />
                                                </button>
                                            );
                                        })}
                                    </div>
                                </>
                            )}
                            {selectedNodeIds.length >= 3 && (
                                <div className="flex flex-wrap gap-1 mb-2">
                                    <button onClick={() => distributeNodes('horizontal')} className="p-2 rounded-lg hover:bg-green-100 transition-colors group" title="Yatay Dağıt">
                                        <Minus className="w-4 h-4 text-green-600 group-hover:scale-110 transition-transform" />
                                    </button>
                                    <button onClick={() => distributeNodes('vertical')} className="p-2 rounded-lg hover:bg-green-100 transition-colors group" title="Dikey Dağıt">
                                        <Minus className="w-4 h-4 text-green-600 rotate-90 group-hover:scale-110 transition-transform" />
                                    </button>
                                </div>
                            )}
                            {selectedNodeIds.length >= 1 && (
                                <button onClick={toggleLock} className="w-full p-2 mb-1 rounded-lg hover:bg-amber-100 transition-colors flex items-center gap-2 group" title="Kilitle/Aç">
                                    <Lock className="w-4 h-4 text-amber-600 group-hover:scale-110 transition-transform" />
                                    {(isLeftPanelExpanded || isLeftPanelPinned) && <span className="text-[10px] font-medium text-amber-700">Kilitle/Aç</span>}
                                </button>
                            )}
                            
                            <div className="h-px bg-slate-200 my-2"></div>
                            
                            {/* Dosya Araçları */}
                            {actionTools.map((tool, idx) => {
                                const ToolIcon = tool.icon;
                                return (
                                    <button
                                        key={idx}
                                        onClick={() => { tool.action(); if (window.innerWidth < 768) setShowLeftPanel(false); }}
                                        className={`w-full p-2.5 mb-1 rounded-lg transition-colors flex items-center gap-3 group ${tool.active ? 'bg-slate-900 text-white' : 'hover:bg-slate-100'}`}
                                    >
                                        <ToolIcon className={`w-5 h-5 ${tool.active ? 'text-white' : (tool.color || 'text-slate-700')} group-hover:scale-110 transition-transform flex-shrink-0`} />
                                        {(isLeftPanelExpanded || isLeftPanelPinned) && <span className={`text-xs font-medium whitespace-nowrap ${tool.active ? 'text-white' : 'text-slate-700'}`}>{tool.label}</span>}
                                    </button>
                                );
                            })}
                            
                            <div className="h-px bg-slate-200 my-2"></div>
                            
                            {/* Diğer Araçlar */}
                            {utilTools.map((tool, idx) => {
                                const ToolIcon = tool.icon;
                                return (
                                    <button
                                        key={idx}
                                        onClick={() => { tool.action(); if (window.innerWidth < 768) setShowLeftPanel(false); }}
                                        className={`w-full p-2.5 mb-1 rounded-lg transition-colors flex items-center gap-3 group ${tool.active ? 'bg-slate-900 text-white' : 'hover:bg-slate-100'}`}
                                    >
                                        <ToolIcon className={`w-5 h-5 ${tool.active ? 'text-white' : (tool.color || 'text-slate-700')} group-hover:scale-110 transition-transform flex-shrink-0`} />
                                        {(isLeftPanelExpanded || isLeftPanelPinned) && <span className={`text-xs font-medium whitespace-nowrap ${tool.active ? 'text-white' : 'text-slate-700'}`}>{tool.label}</span>}
                                    </button>
                                );
                            })}
                            <button
                                onClick={() => setShowAiSettingsModal(true)}
                                className="w-full p-2.5 mb-1.5 rounded-lg transition-colors flex items-center gap-3 group hover:bg-slate-100"
                            >
                                <Key className="w-5 h-5 text-slate-700 group-hover:scale-110 transition-transform flex-shrink-0" />
                                {(isLeftPanelExpanded || isLeftPanelPinned) && <span className="text-xs font-medium text-slate-700 whitespace-nowrap">AI Ayarları</span>}
                            </button>
                        </div>
                    </div>
                    
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />

                    <div
                        className="flex-1 relative overflow-hidden bg-[#fafafa] cursor-default"
                        ref={canvasRef}
                        style={{ touchAction: 'none' }}
                        onWheel={handleWheel}
                        onPointerMove={handlePointerMove}
                        onPointerUp={handlePointerUp}
                        onPointerLeave={handlePointerUp}
                        onPointerDown={handleCanvasPointerDown}
                        onDragOver={handleDragOver}
                        onDrop={handleDrop}
                    >
                        {/* Minimal Status Bar */}
                        <div className="absolute top-3 left-3 bg-white/90 backdrop-blur-sm border border-slate-200 px-3 py-1.5 rounded-lg shadow-sm text-[10px] font-medium text-slate-600 z-10 select-none pointer-events-none flex gap-3">
                            <span>{isPanning ? "KAYDIRMA" : "DÜZENLEME"}</span>
                            <span className="text-slate-400">â€¢</span>
                            <span>%{Math.round(scale * 100)}</span>
                        </div>
                        {/* Minimal Auto-Save Indicator */}
                        <div className="absolute bottom-3 right-3 bg-white/90 backdrop-blur-sm border border-slate-200 px-2.5 py-1 rounded-lg text-[10px] text-slate-500 font-medium z-10 select-none pointer-events-none flex items-center gap-1.5">
                            <Save className="w-3 h-3 text-slate-400 flex-shrink-0" />
                            <span className="truncate">{lastSaved ? lastSaved.toLocaleTimeString() : 'Bekleniyor'}</span>
                        </div>
                       
                        {showLegend && (
                            <div className="legend-box rounded-lg border-2 border-slate-400 bg-white shadow-2xl cursor-move" style={{ position: 'fixed', left: `${legendPos.x}px`, top: `${legendPos.y}px`, zIndex: 9999, width: '520px', maxHeight: '600px', display: 'flex', flexDirection: 'column' }} onPointerDown={handleLegendPointerDown}>
                                <div className="flex justify-between items-center px-3 py-2 bg-slate-100 border-b border-slate-300 cursor-move">
                                    <h3 className="text-sm font-bold text-slate-700">Legend</h3>
                                    <button onClick={(e) => { e.stopPropagation(); setShowLegend(false); }} className="p-1 hover:bg-red-100 rounded text-red-600 cursor-pointer">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                                
                                <div className="overflow-auto custom-scrollbar" style={{ maxHeight: '400px' }}>
                                    <table className="w-full text-xs border-collapse">
                                        <tbody>
                                            {legendItems && typeof legendItems === 'object' && !Array.isArray(legendItems) && Object.keys(legendItems).length > 0 ? (
                                                Object.entries(legendItems).map(([key, value]) => {
                                                    if (!key || !value) return null;
                                                    return (
                                                        <tr key={key} className="border-b border-slate-200 hover:bg-slate-50 group">
                                                            <td className="px-3 py-2.5 bg-blue-100 border-r border-slate-300 font-semibold text-slate-800 align-top w-32" onPointerDown={(e) => e.stopPropagation()}>
                                                                {key}
                                                            </td>
                                                            <td className="px-3 py-2.5 text-slate-700 relative" onPointerDown={(e) => e.stopPropagation()}>
                                                                <div className="pr-6">{value}</div>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        updateLegendItems(prev => {
                                                                            const updated = { ...prev };
                                                                            delete updated[key];
                                                                            return updated;
                                                                        });
                                                                    }}
                                                                    className="absolute right-2 top-2 p-1 text-red-500 opacity-0 group-hover:opacity-100 hover:bg-red-50 rounded transition-all cursor-pointer"
                                                                >
                                                                    <X className="w-3.5 h-3.5" />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })
                                            ) : (
                                                <tr>
                                                    <td colSpan="2" className="text-slate-400 text-center py-8 text-xs">Henüz kısaltma eklenmemiş</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div className="border-t border-slate-300 bg-slate-50 px-3 py-3">
                                    <div className="text-[10px] font-semibold text-slate-600 mb-2 uppercase tracking-wide">Yeni Kısaltma Ekle</div>
                                    <table className="w-full">
                                        <tbody>
                                            <tr>
                                                <td className="pr-2 w-32">
                                                    <input 
                                                        type="text" 
                                                        placeholder="Kısaltma" 
                                                        value={newLegendKey || ''} 
                                                        onChange={(e) => { try { setNewLegendKey(e.target.value); } catch(err) { console.error(err); } }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        onPointerDown={(e) => e.stopPropagation()}
                                                        className="w-full px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent cursor-text"
                                                    />
                                                </td>
                                                <td className="pl-2">
                                                    <input 
                                                        type="text" 
                                                        placeholder="Açıklama" 
                                                        value={newLegendValue || ''} 
                                                        onChange={(e) => { try { setNewLegendValue(e.target.value); } catch(err) { console.error(err); } }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        onPointerDown={(e) => e.stopPropagation()}
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter' && newLegendKey && newLegendValue) {
                                                                e.stopPropagation();
                                                                updateLegendItems(prev => ({ ...prev, [newLegendKey]: newLegendValue }));
                                                                setNewLegendKey('');
                                                                setNewLegendValue('');
                                                            }
                                                        }}
                                                        className="w-full px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent cursor-text"
                                                    />
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (newLegendKey && newLegendValue) {
                                                updateLegendItems(prev => ({ ...prev, [newLegendKey]: newLegendValue }));
                                                setNewLegendKey('');
                                                setNewLegendValue('');
                                            }
                                        }}
                                        disabled={!newLegendKey || !newLegendValue}
                                        className="w-full mt-2 px-3 py-1.5 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors font-medium disabled:bg-slate-300 disabled:cursor-not-allowed cursor-pointer"
                                    >
                                        + Ekle
                                    </button>
                                </div>
                            </div>
                        )}

                        <div ref={contentRef} style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})`, transformOrigin: '0 0', width: '100%', height: '100%', position: 'absolute', top: 0, left: 0 }}>
                             <div className="absolute inset-0 grid-pattern pointer-events-none" style={{ width: '50000px', height: '50000px', transform: 'translate(-25000px, -25000px)' }}></div>
                            {isSelecting && selectionBox && (<div className="selection-box" style={{ left: Math.min(selectionBox.startX, selectionBox.currentX), top: Math.min(selectionBox.startY, selectionBox.currentY), width: Math.abs(selectionBox.currentX - selectionBox.startX), height: Math.abs(selectionBox.currentY - selectionBox.startY) }}/>)}
                            
                            {/* Snap Guide Lines */}
                            {snapLines.length > 0 && (
                                <svg className="absolute top-0 left-0 pointer-events-none z-[9999]" style={{ width: '100%', height: '100%', overflow: 'visible' }}>
                                    {snapLines.map((line, idx) => (
                                        line.type === 'vertical' ? (
                                            <line key={idx} x1={line.x} y1={line.y1 - 20} x2={line.x} y2={line.y2 + 20} stroke="#3b82f6" strokeWidth="2" strokeDasharray="6,4" />
                                        ) : (
                                            <line key={idx} x1={line.x1 - 20} y1={line.y} x2={line.x2 + 20} y2={line.y} stroke="#3b82f6" strokeWidth="2" strokeDasharray="6,4" />
                                        )
                                    ))}
                                </svg>
                            )}
                            
                            <svg 
                                className="absolute top-0 left-0 pointer-events-none" 
                                style={{ 
                                    width: '100%', 
                                    height: '100%', 
                                    overflow: 'visible',
                                    position: 'absolute',
                                    top: 0,
                                    left: 0,
                                    zIndex: 1000
                                }}
                            >
                                {/* Swimlane merge preview removed */}
                                {/* NO MARKERS DEFINED - WE DRAW MANUALLY */}
                                {connections && connections.length > 0 && connections.map(conn => {
                                    const sourceNode = nodes.find(n => n.id === conn.from); 
                                    const targetNode = nodes.find(n => n.id === conn.to); 
                                    if (!sourceNode || !targetNode) return null;
                                    
                                    const start = getHandleCoords(sourceNode, conn.sourceHandle || 'r'); 
                                    const end = getHandleCoords(targetNode, conn.targetHandle || 'l');
                                   
                                    // Calculate path and end angle for arrow (include waypoints for step type)
                                    const { path: curvePath, angle, midX, midY, generatedWaypoints } = getBezierPathAndAngle(
                                        start, end, 
                                        conn.sourceHandle || 'r', 
                                        conn.targetHandle || 'l', 
                                        conn.type || 'bezier', 
                                        conn.curvature, 
                                        conn.controlPoint,
                                        conn.waypoints
                                    );
                                    
                                    // Use custom waypoints or generated ones for step type
                                    const displayWaypoints = conn.type === 'step' ? (conn.waypoints || generatedWaypoints || []) : [];
                                   
                                    const isBeingReconnected = isReconnecting && reconnectInfo?.connectionId === conn.id; 
                                    const isSelected = selectedConnectionId === conn.id;
                                    
                                    // Connection styling
                                    const lineColor = conn.color || '#475569';
                                    const lineWidth = conn.strokeWidth || 2;
                                    const dashArray = conn.dashed ? '8 4' : 'none';
                                   
                                    // Calculate arrowhead points manually
                                    const arrowLength = 12;
                                    const arrowWidth = 7;
                                    // Move tip back slightly
                                    const tipX = end.x;
                                    const tipY = end.y;
                                   
                                    const x1 = tipX - arrowLength * Math.cos(angle) + arrowWidth * Math.sin(angle);
                                    const y1 = tipY - arrowLength * Math.sin(angle) - arrowWidth * Math.cos(angle);
                                    const x2 = tipX - arrowLength * Math.cos(angle) - arrowWidth * Math.sin(angle);
                                    const y2 = tipY - arrowLength * Math.sin(angle) + arrowWidth * Math.cos(angle);
                                   
                                    const arrowPath = `M ${tipX} ${tipY} L ${x1} ${y1} L ${x2} ${y2} Z`;

                                    // Manual Control Point for visual
                                    const controlX = conn.controlPoint ? conn.controlPoint.x : midX;
                                    const controlY = conn.controlPoint ? conn.controlPoint.y : midY;

                                    return (
                                        <g key={conn.id} className={`pointer-events-auto group ${isBeingReconnected ? 'opacity-30' : ''}`} onPointerDown={(e) => handleConnectionSelect(e, conn.id)}>
                                            {/* Hit Area - Wider for easier selection */}
                                            <path d={curvePath} stroke="transparent" strokeWidth="25" fill="none" className="cursor-pointer" />
                                            
                                            {/* Shadow effect */}
                                            <path 
                                                d={curvePath} 
                                                stroke="#000000" 
                                                strokeWidth={(lineWidth || 2) + 1.5} 
                                                fill="none"
                                                opacity="0.12"
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                                strokeDasharray={dashArray}
                                            />
                                            {/* Main line with custom color, width, dash */}
                                            <path 
                                                d={curvePath} 
                                                stroke={isSelected ? '#3b82f6' : lineColor} 
                                                strokeWidth={isSelected ? (lineWidth || 2) + 1 : (lineWidth || 2)} 
                                                fill="none"
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                                strokeDasharray={dashArray}
                                                className={`transition-all ${conn.animated ? 'animated-arrow' : ''}`}
                                                style={{ filter: isSelected ? 'drop-shadow(0 0 4px rgba(59, 130, 246, 0.5))' : 'none' }}
                                            />
                                           
                                            {/* End Arrow Shadow & Main */}
                                            {renderArrow(renderArrowHead(conn.endArrow || 'standard', end.x, end.y, angle, isSelected ? '#3b82f6' : lineColor), true)}
                                            {renderArrow(renderArrowHead(conn.endArrow || 'standard', end.x, end.y, angle, isSelected ? '#3b82f6' : lineColor))}
                                            
                                            {/* Start Arrow Shadow & Main */}
                                            {renderArrow(renderArrowHead(conn.startArrow || 'none', start.x, start.y, angle + Math.PI, isSelected ? '#3b82f6' : lineColor), true)}
                                            {renderArrow(renderArrowHead(conn.startArrow || 'none', start.x, start.y, angle + Math.PI, isSelected ? '#3b82f6' : lineColor))}
                                           
                                            {/* Label with modern styling */}
                                            {conn.label && (
                                                <g>
                                                    <rect 
                                                        x={midX - (conn.label.length * 3.2) - 8} 
                                                        y={midY - 10} 
                                                        width={conn.label.length * 6.4 + 16} 
                                                        height="20" 
                                                        fill="white" 
                                                        stroke={isSelected ? '#3b82f6' : lineColor}
                                                        strokeWidth="1.5"
                                                        rx="10"
                                                        style={{ filter: 'drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))' }}
                                                    />
                                                    <text 
                                                        x={midX} 
                                                        y={midY + 4} 
                                                        textAnchor="middle" 
                                                        fontSize="11" 
                                                        fontWeight="600" 
                                                        fill={isSelected ? '#3b82f6' : lineColor}
                                                        style={{ fontFamily: "'Segoe UI', sans-serif" }}
                                                    >
                                                        {conn.label}
                                                    </text>
                                                </g>
                                            )}
                                           
                                            {/* Connection endpoint handles */}
                                            <circle 
                                                cx={start.x} 
                                                cy={start.y} 
                                                r="6" 
                                                fill={isSelected ? '#3b82f6' : 'white'}
                                                stroke={isSelected ? 'white' : lineColor}
                                                strokeWidth="2"
                                                className={`cursor-move transition-all ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}
                                                style={{ filter: 'drop-shadow(0 1px 3px rgba(0, 0, 0, 0.2))' }}
                                                onPointerDown={(e) => handleConnectionDragStart(e, conn.id, 'source')} 
                                            />
                                            <circle 
                                                cx={end.x} 
                                                cy={end.y} 
                                                r="6" 
                                                fill={isSelected ? '#3b82f6' : 'white'}
                                                stroke={isSelected ? 'white' : lineColor}
                                                strokeWidth="2"
                                                className={`cursor-move transition-all ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}
                                                style={{ filter: 'drop-shadow(0 1px 3px rgba(0, 0, 0, 0.2))' }}
                                                onPointerDown={(e) => handleConnectionDragStart(e, conn.id, 'target')} 
                                            />
                                           
                                            {/* Control point for curves (bezier only) */}
                                            {isSelected && conn.type !== 'step' && conn.type !== 'straight' && (
                                                <g>
                                                    {/* Control point line */}
                                                    <line x1={midX} y1={midY} x2={controlX} y2={controlY} stroke="#3b82f6" strokeWidth="1" strokeDasharray="4 2" opacity="0.5" />
                                                    <circle
                                                        cx={controlX}
                                                        cy={controlY}
                                                        r="7"
                                                        fill="#3b82f6"
                                                        stroke="white"
                                                        strokeWidth="2"
                                                        className="cursor-move"
                                                        data-control-point="true"
                                                        style={{ filter: 'drop-shadow(0 2px 4px rgba(59, 130, 246, 0.4))' }}
                                                        onPointerDown={(e) => handleConnectionControlPointDown(e, conn.id)}
                                                    />
                                                </g>
                                            )}
                                            
                                            {/* Waypoints for step/orthogonal lines */}
                                            {isSelected && conn.type === 'step' && displayWaypoints.map((wp, idx) => (
                                                <circle
                                                    key={`wp-${idx}`}
                                                    cx={wp.x}
                                                    cy={wp.y}
                                                    r="6"
                                                    fill="#10b981"
                                                    stroke="white"
                                                    strokeWidth="2"
                                                    className="cursor-move"
                                                    style={{ filter: 'drop-shadow(0 2px 4px rgba(16, 185, 129, 0.4))' }}
                                                    onPointerDown={(e) => {
                                                        // Initialize waypoints if not exist
                                                        if (!conn.waypoints || conn.waypoints.length === 0) {
                                                            setConnections(prev => prev.map(c => 
                                                                c.id === conn.id ? { ...c, waypoints: [...displayWaypoints] } : c
                                                            ));
                                                        }
                                                        handleWaypointDown(e, conn.id, idx);
                                                    }}
                                                />
                                            ))}
                                        </g>
                                    );
                                })}
                                {(isConnecting || isReconnecting) && connectionStartInfo && (() => {
                                    const s = nodes.find(n => n.id === connectionStartInfo.nodeId);
                                    if(!s) return null;
                                    const st = getHandleCoords(s, connectionStartInfo.handle);
                                    const en = hoveredHandle ? getHandleCoords(nodes.find(n => n.id === hoveredHandle.nodeId), hoveredHandle.handle) : tempConnectionEnd;

                                    return (
                                        <g style={{ pointerEvents: 'none' }}>
                                            <defs>
                                                <filter id="tempArrowGlow" x="-50%" y="-50%" width="200%" height="200%">
                                                    <feDropShadow dx="0" dy="0" stdDeviation="4" floodColor="#ef4444" floodOpacity="0.8" />
                                                </filter>
                                                <marker id="tempArrowHead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                                                    <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444" />
                                                </marker>
                                            </defs>
                                            <line
                                                x1={st.x}
                                                y1={st.y}
                                                x2={en.x}
                                                y2={en.y}
                                                stroke="#ef4444"
                                                strokeWidth="5"
                                                strokeDasharray="12 6"
                                                strokeLinecap="round"
                                                opacity="1"
                                                filter="url(#tempArrowGlow)"
                                                markerEnd="url(#tempArrowHead)"
                                            />
                                            <circle cx={st.x} cy={st.y} r="10" fill="#22c55e" stroke="white" strokeWidth="3" />
                                            <circle cx={en.x} cy={en.y} r="10" fill={hoveredHandle ? "#22c55e" : "#3b82f6"} stroke="white" strokeWidth="3">
                                                <animate attributeName="r" values="10;14;10" dur="0.6s" repeatCount="indefinite" />
                                            </circle>
                                        </g>
                                    );
                                })()}
                            </svg>
                            {[...swimlanes, ...otherNodes].map((node) => {
                                const nodeType = NODE_TYPES[node.type] || NODE_TYPES.COMPONENT; const isSelected = selectedNodeIds.includes(node.id); const isSwimlane = node.type === 'SWIMLANE'; const isRound = node.type === 'START' || node.type === 'END'; const isDecision = node.type === 'DECISION'; const isUML = node.type === 'UML_CLASS'; const isLifeline = node.type === 'LIFELINE'; const hasRisk = node.hasRisk; const NodeIcon = nodeType.icon;
                                const renderHandles = () => {
                                    let handlesToRender = [];
                                    if (node.type === 'LIFELINE') {
                                        // Lifeline: Top/Bottom resize, others hidden/different
                                        handlesToRender = getHandlesForNode(node).filter(h => ['t', 'b'].includes(h.id));
                                    } else if (node.type === 'SWIMLANE') {
                                        return null; // Swimlane uses internal handles
                                    } else {
                                        // Standard Node: CORNERS are for Resize
                                        handlesToRender = HANDLES.filter(h => ['tl', 'tr', 'bl', 'br'].includes(h.id));
                                    }
                                    return handlesToRender.map(h => (<div key={h.id} data-handle={h.id} data-node-id={node.id} onPointerDown={(e) => handleResizePointerDown(e, node.id, h.id)} className={`absolute w-3 h-3 border rounded-full z-50 cursor-pointer ${isSelected ? 'bg-blue-600 border-white scale-125 opacity-100' : 'bg-white border-slate-400 opacity-0 group-hover:opacity-100'} ${isSelected ? h.cursor : 'cursor-crosshair'} ${(isConnecting || isReconnecting) && hoveredHandle?.nodeId === node.id && hoveredHandle?.handle === h.id ? '!opacity-100 !scale-150 !bg-green-500 !border-white' : ''}`} style={{ left: `${h.x}%`, top: `${h.y}%`, transform: 'translate(-50%, -50%)', borderRadius: isSelected ? '2px' : '9999px' }} />));
                                };

                                const renderConnectionPoints = () => {
                                    if(isSwimlane) return null;
                                    let handlesToRender = [];
                                    if (node.type === 'LIFELINE') {
                                         handlesToRender = getHandlesForNode(node).filter(h => h.id.startsWith('v'));
                                    } else {
                                         // Standard Node: SIDES are for Connection
                                         handlesToRender = HANDLES.filter(h => ['t', 'r', 'b', 'l'].includes(h.id));
                                    }
                                    return handlesToRender.map(h => (
                                        <div 
                                            key={h.id} 
                                            data-handle={h.id} 
                                            data-node-id={node.id} 
                                            onMouseDown={(e) => handleHandlePointerDown(e, node.id, h.id)}
                                            onPointerDown={(e) => handleHandlePointerDown(e, node.id, h.id)} 
                                            className={`absolute w-5 h-5 border-2 rounded-full z-40 cursor-crosshair bg-blue-100 border-blue-400 opacity-0 group-hover:opacity-100 hover:!scale-150 hover:!bg-blue-500 hover:!border-white transition-all ${(isConnecting || isReconnecting) && hoveredHandle?.nodeId === node.id && hoveredHandle?.handle === h.id ? '!opacity-100 !scale-150 !bg-green-500 !border-white' : ''} ${isConnecting || isReconnecting ? '!opacity-100' : ''}`} 
                                            style={{ left: `${h.x}%`, top: `${h.y}%`, transform: 'translate(-50%, -50%)', boxShadow: (isConnecting || isReconnecting) && hoveredHandle?.nodeId === node.id && hoveredHandle?.handle === h.id ? '0 0 8px rgba(34, 197, 94, 0.9)' : '0 0 4px rgba(59, 130, 246, 0.5)' }} 
                                        />
                                    ));
                                }
                               
                                if (isSwimlane) {
                                    const headerPos = node.headerPosition || 'top';
                                    const isLeftHeader = headerPos === 'left';
                                    const isRightHeader = headerPos === 'right';
                                    const isTopHeader = headerPos === 'top';
                                    
                                    return (
                                        <div key={node.id} data-node-id={node.id} onPointerDown={(e) => handleNodePointerDown(e, node.id)} onDoubleClick={(e) => { e.stopPropagation(); handleSwimlaneDoubleClick(node.id); }} style={{ left: node.x, top: node.y, width: node.width || 350, height: node.height || 500, position: 'absolute', borderColor: node.borderColor || '#cbd5e1', backgroundColor: node.backgroundColor || 'rgba(248, 250, 252, 0.35)' }} className={`transition-shadow duration-200 cursor-move group select-none flex ${isLeftHeader ? 'flex-row' : isRightHeader ? 'flex-row-reverse' : 'flex-col'} overflow-visible border-2 z-10 ${isSelected ? 'border-blue-400 ring-2 ring-blue-200' : 'hover:shadow-sm'}`}>
                                            {renderHandles()}
                                            <div className={`${isLeftHeader || isRightHeader ? 'w-10 flex items-center justify-center py-2' : 'w-full h-10 border-b flex items-center justify-center px-2'}`} style={isLeftHeader ? { borderRight: `2px solid ${node.borderColor || '#cbd5e1'}`, backgroundColor: node.headerColor || 'rgb(226, 232, 240)' } : isRightHeader ? { borderLeft: `2px solid ${node.borderColor || '#cbd5e1'}`, backgroundColor: node.headerColor || 'rgb(226, 232, 240)' } : { borderColor: node.borderColor || '#cbd5e1', backgroundColor: node.headerColor || 'rgb(226, 232, 240)' }}>
                                                <div className={`text-[10px] font-bold uppercase tracking-wider text-slate-400 block ${isLeftHeader || isRightHeader ? 'whitespace-nowrap' : 'truncate text-center'}`} style={(isLeftHeader || isRightHeader) ? { writingMode: 'vertical-rl', transform: isLeftHeader ? 'rotate(180deg)' : 'none' } : {}}>
                                                    {renderEditableField(node, 'title', '', (isLeftHeader || isRightHeader) ? { width: '100%', height: 'auto' } : {})}
                                                </div>
                                            </div>
                                            <div className="flex-1 flex items-center justify-center relative overflow-hidden">
                                                <div className={`text-4xl font-black text-slate-200 uppercase opacity-20 pointer-events-none whitespace-nowrap absolute ${isLeftHeader ? 'top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -rotate-45' : isRightHeader ? 'top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -rotate-45' : 'left-0 top-1/2 -translate-y-1/2 -rotate-90'}`}>{node.title}</div>
                                            </div>
                                            {(() => {
                                                if (!isSelected) return null;
                                                return HANDLES.map(h => (<div key={h.id} data-handle={h.id} data-node-id={node.id} onPointerDown={(e) => handleResizePointerDown(e, node.id, h.id)} className={`absolute w-3 h-3 border rounded-full z-50 cursor-pointer bg-white border-blue-600`} style={{ left: `${h.x}%`, top: `${h.y}%`, transform: 'translate(-50%, -50%)' }} />));
                                            })()}
                                        </div>
                                    );
                                }
                                if (isDecision) {
                                    const decisionWidth = node.width || 120;
                                    const decisionHeight = node.height || 120;
                                    const minDim = Math.min(decisionWidth, decisionHeight);
                                    const diamondSize = minDim * 0.75;
                                    const diamondOffset = (minDim - diamondSize) / 2;
                                    return (
                                    <div key={node.id} data-node-id={node.id} onPointerDown={(e) => handleNodePointerDown(e, node.id)} 
                                        style={{ left: node.x, top: node.y, width: decisionWidth, height: decisionHeight, position: 'absolute' }} 
                                        className="cursor-move group select-none flex flex-col justify-center items-center z-20"
                                    >
                                        <div 
                                            className={`absolute bg-gradient-to-br from-white to-slate-50 ${isSelected ? 'shadow-lg' : 'shadow-sm'}`} 
                                            style={{ 
                                                width: diamondSize,
                                                height: diamondSize,
                                                left: (decisionWidth - diamondSize) / 2,
                                                top: (decisionHeight - diamondSize) / 2,
                                                transform: 'rotate(45deg)', 
                                                borderRadius: '8px',
                                                border: isSelected ? '2px solid #3b82f6' : hasRisk ? '2px solid #f59e0b' : '2px solid #94a3b8',
                                                boxShadow: isSelected ? '0 0 0 3px rgba(59, 130, 246, 0.2)' : hasRisk ? '0 4px 12px rgba(245, 158, 11, 0.3)' : '0 2px 8px rgba(0, 0, 0, 0.08)'
                                            }}
                                        />
                                        {renderHandles()}{renderConnectionPoints()}
                                        <div className="relative z-10 flex flex-col items-center justify-center text-center p-4 w-full h-full pointer-events-none">
                                            <NodeIcon className="w-4 h-4 mb-1 text-slate-400" />
                                            <div className="text-[11px] font-semibold leading-tight line-clamp-3 text-slate-700 pointer-events-auto">
                                                {renderEditableField(node, 'title', 'bg-transparent text-center')}
                                            </div>
                                            {hasRisk && <AlertTriangle className="w-3.5 h-3.5 text-amber-500 mt-1" />}
                                        </div>
                                    </div>
                                );
                                }
                                
                                if (isRound) return (
                                    <div key={node.id} data-node-id={node.id} onPointerDown={(e) => handleNodePointerDown(e, node.id)} 
                                        style={{ 
                                            left: node.x, top: node.y, 
                                            width: node.width || 80, height: node.height || 80, 
                                            position: 'absolute', 
                                            borderRadius: '999px',
                                            background: 'linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%)',
                                            border: isSelected ? '2px solid #3b82f6' : '2px solid #94a3b8',
                                            boxShadow: isSelected ? '0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)' : '0 2px 8px rgba(0, 0, 0, 0.08)'
                                        }} 
                                        className="cursor-move group select-none flex flex-col justify-center items-center z-20"
                                    >
                                        {renderHandles()}{renderConnectionPoints()}
                                        <div className="text-[11px] font-semibold text-slate-700 text-center px-2">
                                            {renderEditableField(node, 'title', 'text-center')}
                                        </div>
                                    </div>
                                );
                                
                                if (isUML) return (
                                    <div key={node.id} data-node-id={node.id} onPointerDown={(e) => handleNodePointerDown(e, node.id)} 
                                        style={{ 
                                            left: node.x, top: node.y, 
                                            width: node.width || 180, height: node.height || 200, 
                                            position: 'absolute',
                                            borderRadius: '8px',
                                            border: isSelected ? '2px solid #3b82f6' : '1px solid #cbd5e1',
                                            boxShadow: isSelected ? '0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)' : '0 2px 8px rgba(0, 0, 0, 0.06)'
                                        }} 
                                        className="flex flex-col bg-white overflow-hidden cursor-move group select-none z-20"
                                    >
                                        {renderHandles()}{renderConnectionPoints()}
                                        <div className="bg-gradient-to-r from-slate-700 to-slate-800 px-3 py-2 text-center">
                                            <div className="text-[10px] text-slate-300 italic">{renderEditableField(node, 'techStack', 'text-center bg-transparent text-slate-300')}</div>
                                            <div className="font-bold text-sm text-white">{renderEditableField(node, 'title', 'text-center bg-transparent text-white')}</div>
                                        </div>
                                        <div className="flex-1 border-b border-slate-200 p-2 text-[10px] text-slate-600 overflow-hidden bg-slate-50">
                                            {renderEditableField(node, 'description', 'w-full h-full', {}, 'textarea')}
                                        </div>
                                        <div className="flex-1 p-2 text-[10px] text-slate-600 overflow-hidden">
                                            {renderEditableField(node, 'methods', 'w-full h-full', {}, 'textarea')}
                                        </div>
                                    </div>
                                );
                                
                                if (isLifeline) return (
                                    <div key={node.id} data-node-id={node.id} onPointerDown={(e) => handleNodePointerDown(e, node.id)} 
                                        style={{ left: node.x, top: node.y, width: node.width || 100, height: node.height || 350, position: 'absolute' }} 
                                        className="flex flex-col items-center cursor-move group select-none z-20"
                                    >
                                        <div 
                                            className="w-full py-2 px-3 bg-gradient-to-r from-slate-700 to-slate-800 flex items-center justify-center font-semibold text-[11px] text-white"
                                            style={{ 
                                                borderRadius: '6px 6px 0 0',
                                                boxShadow: isSelected ? '0 0 0 2px #3b82f6' : '0 2px 4px rgba(0, 0, 0, 0.1)'
                                            }}
                                        >
                                            {renderEditableField(node, 'title', 'text-center bg-transparent text-white')}
                                        </div>
                                        <div className="w-0 border-l-2 border-dashed border-slate-300 h-full" />
                                        {renderHandles()}{renderConnectionPoints()}
                                    </div>
                                );
                               
                                return (
                                    <div 
                                        key={node.id} 
                                        data-node-id={node.id} 
                                        onPointerDown={(e) => handleNodePointerDown(e, node.id)} 
                                        style={{ 
                                            left: node.x, 
                                            top: node.y, 
                                            width: node.width || 180, 
                                            height: node.height || 95, 
                                            position: 'absolute', 
                                            backgroundColor: node.bgOpacity !== undefined && node.bgOpacity < 100 
                                                ? `${node.backgroundColor || '#ffffff'}${Math.round(node.bgOpacity * 2.55).toString(16).padStart(2, '0')}` 
                                                : (node.backgroundColor || '#ffffff'),
                                            borderRadius: `${node.borderRadius ?? 10}px`,
                                            boxShadow: isSelected 
                                                ? '0 0 0 2px #3b82f6, 0 8px 20px rgba(59, 130, 246, 0.15)' 
                                                : hasRisk 
                                                    ? '0 4px 12px rgba(245, 158, 11, 0.2)' 
                                                    : (node.customShadow && node.customShadow !== 'none' ? node.customShadow : '0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04)'),
                                            border: node.borderWidth ? `${node.borderWidth}px ${node.borderStyle || 'solid'} ${node.boxBorderColor || '#e2e8f0'}` : 'none'
                                        }} 
                                        className={`flex flex-col overflow-hidden cursor-move group select-none z-20 ${hasRisk ? 'ring-2 ring-amber-400' : ''}`}
                                    >
                                        {renderHandles()}
                                        {renderConnectionPoints()}
                                        
                                        {/* Header - Gradient */}
                                        <div 
                                            style={{ 
                                                height: (node.headerHeight || 28) + 'px',
                                                background: hasRisk 
                                                    ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' 
                                                    : (node.headerColor || `linear-gradient(135deg, ${node.borderColor || '#1e293b'} 0%, ${node.borderColor ? node.borderColor + 'ee' : '#334155'} 100%)`),
                                                borderRadius: `${node.borderRadius ?? 10}px ${node.borderRadius ?? 10}px 0 0`
                                            }} 
                                            className="flex items-stretch shrink-0"
                                        >
                                            {/* Step Number */}
                                            <div 
                                                className="w-[38px] flex items-center justify-center flex-shrink-0"
                                                style={{ 
                                                    borderTopLeftRadius: `${node.borderRadius ?? 10}px`,
                                                    backgroundColor: node.stepNumberBgColor 
                                                        ? `${node.stepNumberBgColor}${Math.round((node.stepNumberBgOpacity ?? 15) * 2.55).toString(16).padStart(2, '0')}` 
                                                        : `rgba(0,0,0,${(node.stepNumberBgOpacity ?? 15) / 100})`,
                                                    fontSize: `${node.stepNumberFontSize || 10}px`,
                                                    fontWeight: node.stepNumberFontWeight || 700,
                                                    color: node.stepNumberColor || 'rgba(255,255,255,0.9)'
                                                }}
                                            >
                                                {renderEditableField(node, 'stepNumber', 'bg-transparent w-full text-center', {color: 'inherit', fontSize: 'inherit', fontWeight: 'inherit'})}
                                            </div>
                                           
                                            {/* Owner */}
                                            <div className="flex-1 flex items-center justify-center px-2 overflow-hidden">
                                                <span
                                                    style={{
                                                        fontSize: `${node.headerFontSize || 9}px`,
                                                        fontFamily: node.headerFontFamily || "'Segoe UI', sans-serif",
                                                        fontWeight: node.headerFontWeight || 700,
                                                        letterSpacing: '0.04em',
                                                        textTransform: 'uppercase',
                                                        color: node.headerFontColor || 'rgba(255,255,255,0.95)'
                                                    }}
                                                    className="truncate"
                                                >
                                                    {renderEditableField(node, 'owner', 'bg-transparent text-center w-full', {color: 'inherit'})}
                                                </span>
                                                {hasRisk && <AlertTriangle className="w-3 h-3 text-white/80 ml-1 flex-shrink-0" />}
                                            </div>
                                           
                                            {/* Tech Badge */}
                                            <div 
                                                className="flex items-center px-2 gap-1"
                                                style={{ 
                                                    borderTopRightRadius: `${node.borderRadius ?? 10}px`,
                                                    backgroundColor: node.techStackBgColor || 'rgba(255,255,255,0.1)'
                                                }}
                                            >
                                                {NodeIcon && <NodeIcon className="w-3 h-3 text-white/60" />}
                                                <span
                                                    style={{ 
                                                        fontSize: `${node.techStackFontSize || 8}px`, 
                                                        fontWeight: node.techStackFontWeight || 600,
                                                        color: node.techStackFontColor || 'rgba(255,255,255,0.85)'
                                                    }}
                                                >
                                                    {renderEditableField(node, 'techStack', 'bg-transparent text-center min-w-[20px]', {color: 'inherit'})}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Title Bar */}
                                        <div 
                                            style={{ 
                                                height: (node.titleHeight || 22) + 'px',
                                                backgroundColor: hasRisk ? '#fef3c7' : '#f8fafc',
                                                borderBottom: hasRisk ? '1px solid #fcd34d' : '1px solid #e2e8f0'
                                            }}
                                            className="flex items-center justify-center px-2 shrink-0"
                                        >
                                            <span 
                                                className="truncate w-full text-center"
                                                style={{ 
                                                    fontSize: `${node.titleFontSize || 10}px`,
                                                    fontWeight: node.titleFontWeight || 600,
                                                    fontFamily: node.titleFontFamily || "'Segoe UI', sans-serif",
                                                    color: hasRisk ? '#92400e' : (node.titleFontColor || '#64748b')
                                                }}
                                            >
                                                {renderEditableField(node, 'title', 'text-center w-full')}
                                            </span>
                                        </div>
                                        
                                        {/* Description */}
                                        <div 
                                            className="flex-1 px-2.5 py-1.5 overflow-y-auto relative"
                                            style={{ 
                                                fontSize: `${node.descriptionFontSize || 10}px`, 
                                                fontWeight: node.descriptionFontWeight || 400,
                                                fontFamily: node.descriptionFontFamily || "'Segoe UI', sans-serif",
                                                lineHeight: node.descriptionLineHeight || 1.4,
                                                color: node.descriptionFontColor || '#64748b',
                                                backgroundColor: hasRisk ? '#fffbeb' : 'transparent',
                                                borderRadius: `0 0 ${node.borderRadius ?? 10}px ${node.borderRadius ?? 10}px`
                                            }}
                                        >
                                            {renderEditableField(node, 'description', 'w-full h-full', {}, 'textarea')}
                                            
                                            {/* Sol Alt Not İkonu - Tıklayınca Popup Açılır */}
                                            {node.note && (
                                                <div 
                                                    className="absolute bottom-1.5 left-1.5 cursor-pointer"
                                                    onClick={(e) => { e.stopPropagation(); setNotePopupNodeId(node.id); }}
                                                >
                                                    <div className="w-5 h-5 rounded bg-amber-100 border border-amber-300 flex items-center justify-center hover:bg-amber-200 hover:scale-110 transition-all shadow-sm">
                                                        <FileText className="w-3 h-3 text-amber-600" />
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Sağ Alt Etiket - API, Webservice vs. */}
                                            {node.tag && (
                                                <div 
                                                    className="absolute bottom-1.5 right-1.5 px-2 py-0.5 rounded text-[9px] font-semibold"
                                                    style={{
                                                        backgroundColor: node.tagBgColor || '#e2e8f0',
                                                        color: node.tagTextColor || '#475569',
                                                        border: `1px solid ${node.tagBorderColor || '#cbd5e1'}`
                                                    }}
                                                >
                                                    {renderEditableField(node, 'tag', 'bg-transparent text-center', {color: 'inherit', fontSize: 'inherit'})}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                            
                            {/* Quick Add Handles */}
                            {showQuickAddHandles && selectedNodeIds.length === 1 && (() => {
                                const node = nodes.find(n => n.id === selectedNodeIds[0]);
                                if (!node || node.type === 'SWIMLANE') return null;
                                const rect = getNodeRect(node);
                                return (
                                    <>
                                        <div className="quick-add-handle" style={{ left: rect.x + rect.width / 2, top: rect.y - 40, transform: 'translate(-50%, -50%)' }} onClick={() => handleQuickAddNode('up', node)} title="Yukarı Ekle">
                                            <Plus className="w-4 h-4 text-white" />
                                        </div>
                                        <div className="quick-add-handle" style={{ left: rect.x + rect.width + 40, top: rect.y + rect.height / 2, transform: 'translate(-50%, -50%)' }} onClick={() => handleQuickAddNode('right', node)} title="Sağa Ekle">
                                            <Plus className="w-4 h-4 text-white" />
                                        </div>
                                        <div className="quick-add-handle" style={{ left: rect.x + rect.width / 2, top: rect.y + rect.height + 40, transform: 'translate(-50%, -50%)' }} onClick={() => handleQuickAddNode('down', node)} title="Aşağı Ekle">
                                            <Plus className="w-4 h-4 text-white" />
                                        </div>
                                        <div className="quick-add-handle" style={{ left: rect.x - 40, top: rect.y + rect.height / 2, transform: 'translate(-50%, -50%)' }} onClick={() => handleQuickAddNode('left', node)} title="Sola Ekle">
                                            <Plus className="w-4 h-4 text-white" />
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                    </div>

                    {/* Right Properties Panel */}
                    <div className="w-72 bg-white/95 backdrop-blur-sm border-l border-slate-200 flex flex-col z-40 overflow-hidden">
                        {(selectedNode || isMultiSelect) ? (
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                <div className="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                                    <h2 className="text-xs font-bold text-slate-800">{isMultiSelect ? "ÇOKLU SEÇİM" : "ÖZELLİKLER"}</h2>
                                    <button onClick={deleteSelected} className="p-1 hover:bg-red-50 rounded transition-colors text-red-600"><Trash2 className="w-3.5 h-3.5" /></button>
                                </div>
                                <div className="p-2 space-y-1">
                                    {!isMultiSelect && selectedNode && (
                                        <>
                                            {/* TEMEL BİLGİLER - Accordion */}
                                            <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                <button onClick={() => toggleSection('temel')} className="w-full flex items-center justify-between p-2 bg-slate-50 hover:bg-slate-100 transition-colors">
                                                    <span className="text-[10px] font-bold text-slate-700 uppercase tracking-wide">Temel Bilgiler</span>
                                                    <ChevronDown className={`w-3.5 h-3.5 text-slate-500 transition-transform ${expandedSections.temel ? 'rotate-180' : ''}`} />
                                                </button>
                                                {expandedSections.temel && (
                                                    <div className="p-2 space-y-2 bg-white">
                                                        <div className="grid grid-cols-3 gap-1">
                                                            <div className="col-span-1">
                                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">ADIM</label>
                                                                <input type="text" value={selectedNode.stepNumber || ''} onChange={(e) => updateNodeData('stepNumber', e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white" placeholder="1.0"/>
                                                            </div>
                                                            <div className="col-span-2">
                                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">BAŞLIK</label>
                                                                <input type="text" value={selectedNode.title} onChange={(e) => updateNodeData('title', e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white"/>
                                                            </div>
                                                        </div>
                                                        {selectedNode.type !== 'SWIMLANE' && selectedNode.type !== 'START' && selectedNode.type !== 'END' && selectedNode.type !== 'DECISION' && selectedNode.type !== 'LIFELINE' && (
                                                            <div className="grid grid-cols-2 gap-1">
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block">BİLEŞEN</label>
                                                                    <input type="text" value={selectedNode.techStack} onChange={(e) => updateNodeData('techStack', e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white"/>
                                                                </div>
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block">AKTÖR</label>
                                                                    <input type="text" value={selectedNode.owner} onChange={(e) => updateNodeData('owner', e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white"/>
                                                                </div>
                                                            </div>
                                                        )}
                                                        {selectedNode.type !== 'SWIMLANE' && selectedNode.type !== 'START' && selectedNode.type !== 'END' && selectedNode.type !== 'DECISION' && selectedNode.type !== 'LIFELINE' && (
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">ETİKET (API, Webservice vs.)</label>
                                                                <input type="text" value={selectedNode.tag || ''} onChange={(e) => updateNodeData('tag', e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white" placeholder="REST API, SOAP, GraphQL..."/>
                                                            </div>
                                                        )}
                                                        {selectedNode.type !== 'LIFELINE' && (
                                                            <div>
                                                                <div className="flex justify-between items-center mb-1">
                                                                    <label className="text-[10px] font-bold text-slate-400">AÇIKLAMA</label>
                                                                    <button type="button" onClick={handleAiNodeDescription} disabled={isAiLoading} className="text-[10px] font-bold bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200 flex items-center gap-0.5 hover:bg-purple-200">
                                                                        <Sparkles className="w-2.5 h-2.5"/> AI
                                                                    </button>
                                                                </div>
                                                                <textarea value={selectedNode.description} onChange={(e) => updateNodeData('description', e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs h-20 bg-white resize-none"/>
                                                            </div>
                                                        )}
                                                        {selectedNode.type !== 'SWIMLANE' && selectedNode.type !== 'START' && selectedNode.type !== 'END' && selectedNode.type !== 'LIFELINE' && (
                                                            <div>
                                                                <div className="flex justify-between items-center mb-1">
                                                                    <label className="text-[10px] font-bold text-amber-600 flex items-center gap-1">
                                                                        <FileText className="w-3 h-3" /> TEKNİK NOT
                                                                    </label>
                                                                </div>
                                                                <textarea 
                                                                    value={selectedNode.note || ''} 
                                                                    onChange={(e) => updateNodeData('note', e.target.value)} 
                                                                    className="w-full p-1.5 border border-amber-200 rounded text-xs h-16 bg-amber-50 resize-none" 
                                                                    placeholder="Tablo adı, teknik detay, SQL sorgusu vb..."
                                                                />
                                                            </div>
                                                        )}
                                                        <div className="flex items-center gap-2 p-1.5 border border-amber-200 bg-amber-50 rounded cursor-pointer" onClick={() => updateNodeData('hasRisk', !selectedNode.hasRisk)}>
                                                            <input type="checkbox" checked={selectedNode.hasRisk || false} onChange={() => {}} className="w-3 h-3 text-amber-600 rounded" />
                                                            <span className="text-[10px] font-bold text-amber-800">Risk İşaretle</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* BOYUT - Accordion */}
                                            <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                <button onClick={() => toggleSection('boyut')} className="w-full flex items-center justify-between p-2 bg-slate-50 hover:bg-slate-100 transition-colors">
                                                    <span className="text-[10px] font-bold text-slate-700 uppercase tracking-wide">Boyut</span>
                                                    <ChevronDown className={`w-3.5 h-3.5 text-slate-500 transition-transform ${expandedSections.boyut ? 'rotate-180' : ''}`} />
                                                </button>
                                                {expandedSections.boyut && (
                                                    <div className="p-2 bg-white">
                                                        <div className="grid grid-cols-2 gap-1">
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">GENİŞLİK</label>
                                                                <input type="number" value={Math.round(selectedNode.width || 160)} onChange={(e) => updateNodeData('width', parseInt(e.target.value))} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white"/>
                                                            </div>
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">YÜKSEKLİK</label>
                                                                <input type="number" value={Math.round(selectedNode.height || 100)} onChange={(e) => updateNodeData('height', parseInt(e.target.value))} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* YAZI AYARLARI - Accordion */}
                                            {selectedNode.type !== 'SWIMLANE' && selectedNode.type !== 'START' && selectedNode.type !== 'END' && selectedNode.type !== 'DECISION' && selectedNode.type !== 'LIFELINE' && (
                                                <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                    <button onClick={() => toggleSection('yazi')} className="w-full flex items-center justify-between p-2 bg-slate-50 hover:bg-slate-100 transition-colors">
                                                        <span className="text-[10px] font-bold text-slate-700 uppercase tracking-wide">Yazı Ayarları</span>
                                                        <ChevronDown className={`w-3.5 h-3.5 text-slate-500 transition-transform ${expandedSections.yazi ? 'rotate-180' : ''}`} />
                                                    </button>
                                                    {expandedSections.yazi && (
                                                        <div className="p-2 space-y-3 bg-white">
                                                            
                                                            {/* AKTÖR AYARLARI */}
                                                            <div className="p-2 bg-blue-50 rounded-lg border border-blue-100">
                                                                <div className="text-[10px] font-bold text-blue-700 mb-2 flex items-center gap-1">
                                                                    AKTÖR (Header)
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-blue-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="7" max="16" value={Math.round(selectedNode.headerFontSize || 9)} onChange={(e) => updateNodeData('headerFontSize', parseInt(e.target.value) || 9)} className="w-full p-1.5 border border-blue-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-blue-600 mb-0.5 block">RENK</label>
                                                                        <input type="color" value={selectedNode.headerFontColor || '#ffffff'} onChange={(e) => updateNodeData('headerFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-blue-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-blue-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.headerFontWeight || 700} onChange={(e) => updateNodeData('headerFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-blue-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                            <option value="800">Çok Kalın</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* BİLEŞEN AYARLARI */}
                                                            <div className="p-2 bg-purple-50 rounded-lg border border-purple-100">
                                                                <div className="text-[10px] font-bold text-purple-700 mb-2 flex items-center gap-1">
                                                                    BİLEŞEN
                                                                </div>
                                                                <div className="grid grid-cols-4 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="6" max="14" value={Math.round(selectedNode.techStackFontSize || 8)} onChange={(e) => updateNodeData('techStackFontSize', parseInt(e.target.value) || 8)} className="w-full p-1.5 border border-purple-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">METİN</label>
                                                                        <input type="color" value={selectedNode.techStackFontColor || '#ffffff'} onChange={(e) => updateNodeData('techStackFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-purple-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">ARKA PLAN</label>
                                                                        <input type="color" value={selectedNode.techStackBgColor || '#ffffff'} onChange={(e) => updateNodeData('techStackBgColor', e.target.value + '1a')} className="w-full h-7 p-0.5 border border-purple-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.techStackFontWeight || 600} onChange={(e) => updateNodeData('techStackFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-purple-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div className="mt-1.5 flex gap-1">
                                                                    <label className="text-[10px] text-purple-600">Opaklık:</label>
                                                                    <input 
                                                                        type="range" 
                                                                        min="0" 
                                                                        max="100" 
                                                                        value={selectedNode.techStackBgOpacity ?? 10} 
                                                                        onChange={(e) => {
                                                                            const opacity = parseInt(e.target.value);
                                                                            const baseColor = (selectedNode.techStackBgColor || '#ffffff').substring(0, 7);
                                                                            const hex = Math.round(opacity * 2.55).toString(16).padStart(2, '0');
                                                                            updateNodeData('techStackBgColor', baseColor + hex);
                                                                            updateNodeData('techStackBgOpacity', opacity);
                                                                        }} 
                                                                        className="flex-1 h-1.5 accent-purple-500" 
                                                                    />
                                                                    <span className="text-[10px] text-purple-600 w-6">{selectedNode.techStackBgOpacity ?? 10}%</span>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* BAŞLIK AYARLARI */}
                                                            <div className="p-2 bg-amber-50 rounded-lg border border-amber-100">
                                                                <div className="text-[10px] font-bold text-amber-700 mb-2 flex items-center gap-1">
                                                                    BAŞLIK (Title)
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-amber-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="8" max="16" value={Math.round(selectedNode.titleFontSize || 10)} onChange={(e) => updateNodeData('titleFontSize', parseInt(e.target.value) || 10)} className="w-full p-1.5 border border-amber-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-amber-600 mb-0.5 block">RENK</label>
                                                                        <input type="color" value={selectedNode.titleFontColor || '#64748b'} onChange={(e) => updateNodeData('titleFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-amber-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-amber-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.titleFontWeight || 600} onChange={(e) => updateNodeData('titleFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-amber-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* DETAY AYARLARI */}
                                                            <div className="p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                                                                <div className="text-[10px] font-bold text-emerald-700 mb-2 flex items-center gap-1">
                                                                    SÜREÇ DETAYI (Description)
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-emerald-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="8" max="16" value={Math.round(selectedNode.descriptionFontSize || 10)} onChange={(e) => updateNodeData('descriptionFontSize', parseInt(e.target.value) || 10)} className="w-full p-1.5 border border-emerald-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-emerald-600 mb-0.5 block">RENK</label>
                                                                        <input type="color" value={selectedNode.descriptionFontColor || '#64748b'} onChange={(e) => updateNodeData('descriptionFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-emerald-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-emerald-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.descriptionFontWeight || 400} onChange={(e) => updateNodeData('descriptionFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-emerald-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div className="mt-1.5">
                                                                    <label className="text-[10px] text-emerald-600 mb-0.5 block">SATIR ARALIĞI</label>
                                                                    <div className="flex gap-1">
                                                                        {[1.2, 1.4, 1.6, 1.8, 2].map(lh => (
                                                                            <button key={lh} onClick={() => updateNodeData('descriptionLineHeight', lh)} className={`flex-1 p-1.5 border rounded text-[10px] ${(selectedNode.descriptionLineHeight || 1.4) === lh ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white border-emerald-200 text-emerald-700'}`}>{lh}</button>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* ORTAK FONT */}
                                                            <div className="p-2 bg-slate-100 rounded-lg">
                                                                <label className="text-[10px] font-bold text-slate-600 mb-1 block">ORTAK FONT AİLESİ</label>
                                                                <select value={selectedNode.headerFontFamily || "'Segoe UI', sans-serif"} onChange={(e) => { updateNodeData('headerFontFamily', e.target.value); updateNodeData('techStackFontFamily', e.target.value); updateNodeData('titleFontFamily', e.target.value); updateNodeData('descriptionFontFamily', e.target.value); }} className="w-full p-1.5 border border-slate-300 rounded text-[10px] bg-white">
                                                                    <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
                                                                    <option value="'Inter', system-ui, sans-serif">Inter</option>
                                                                    <option value="'Roboto', Arial, sans-serif">Roboto</option>
                                                                    <option value="'Poppins', 'Segoe UI', sans-serif">Poppins</option>
                                                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                                                    <option value="'Lato', sans-serif">Lato</option>
                                                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                                                    <option value="monospace">Monospace</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* GÖRÜNÜM - Accordion */}
                                            {selectedNode.type !== 'LIFELINE' && selectedNode.type !== 'SWIMLANE' && (
                                                <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                    <button onClick={() => toggleSection('gorunum')} className="w-full flex items-center justify-between p-2 bg-slate-50 hover:bg-slate-100 transition-colors">
                                                        <span className="text-[10px] font-bold text-slate-700 uppercase tracking-wide">Görünüm</span>
                                                        <ChevronDown className={`w-3.5 h-3.5 text-slate-500 transition-transform ${expandedSections.gorunum ? 'rotate-180' : ''}`} />
                                                    </button>
                                                    {expandedSections.gorunum && (
                                                        <div className="p-2 space-y-3 bg-white">
                                                            
                                                            {/* HEADER RENGİ */}
                                                            <div className="p-2 bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg">
                                                                <label className="text-[10px] font-bold text-slate-600 mb-1.5 block">
                                                                    HEADER RENGİ
                                                                </label>
                                                                <div className="grid grid-cols-6 gap-1 mb-2">
                                                                    {[
                                                                        // Satır 1: Gri ve Mavi tonları
                                                                        { hex: '#ffffff', label: 'Beyaz' },
                                                                        { hex: '#cbd5e1', label: 'Açık Gri' },
                                                                        { hex: '#1e293b', label: 'Koyu Lacivert' },
                                                                        { hex: '#bfdbfe', label: 'Açık Mavi' },
                                                                        { hex: '#3b82f6', label: 'Mavi' },
                                                                        { hex: '#1e40af', label: 'Koyu Mavi' },
                                                                        // Satır 2: Yeşil ve Kırmızı tonları
                                                                        { hex: '#bbf7d0', label: 'Açık Yeşil' },
                                                                        { hex: '#22c55e', label: 'Yeşil' },
                                                                        { hex: '#166534', label: 'Koyu Yeşil' },
                                                                        { hex: '#fecaca', label: 'Açık Kırmızı' },
                                                                        { hex: '#ef4444', label: 'Kırmızı' },
                                                                        { hex: '#b91c1c', label: 'Koyu Kırmızı' },
                                                                        // Satır 3: Sarı ve Mor tonları
                                                                        { hex: '#fef9c3', label: 'Açık Sarı' },
                                                                        { hex: '#FBCE07', label: 'Shell Sarı' },
                                                                        { hex: '#e9d5ff', label: 'Açık Mor' },
                                                                        { hex: '#a855f7', label: 'Mor' },
                                                                        { hex: '#7e22ce', label: 'Koyu Mor' },
                                                                        { hex: '#ffffff', label: 'Boş', hidden: true },
                                                                        // Satır 4: Pembe tonları
                                                                        { hex: '#ffffff', label: 'Boş', hidden: true },
                                                                        { hex: '#ffffff', label: 'Boş', hidden: true },
                                                                        { hex: '#f9a8d4', label: 'Açık Pembe' },
                                                                        { hex: '#ec4899', label: 'Pembe' },
                                                                    ].filter(c => !c.hidden).map((color, idx) => (
                                                                        <button 
                                                                            key={idx} 
                                                                            onClick={() => updateNodeData('borderColor', color.hex)} 
                                                                            className={`w-7 h-7 rounded-lg border-2 hover:scale-110 transition-transform ${selectedNode.borderColor === color.hex ? 'ring-2 ring-offset-1 ring-blue-500' : 'border-white/50'}`} 
                                                                            style={{ backgroundColor: color.hex }} 
                                                                            title={color.label} 
                                                                        />
                                                                    ))}
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <label className="text-[10px] text-slate-500">Özel:</label>
                                                                    <input 
                                                                        type="color" 
                                                                        value={selectedNode.borderColor || '#1e293b'} 
                                                                        onChange={(e) => updateNodeData('borderColor', e.target.value)} 
                                                                        className="w-8 h-6 rounded border border-slate-300 cursor-pointer" 
                                                                        title="Özel Renk Seç" 
                                                                    />
                                                                    <span className="text-[10px] text-slate-400 font-mono">{selectedNode.borderColor || '#1e293b'}</span>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* ARKA PLAN */}
                                                            <div className="p-2 bg-white rounded-lg border border-slate-100">
                                                                <label className="text-[10px] font-bold text-slate-600 mb-1.5 block flex items-center gap-1">
                                                                    ARKA PLAN RENGİ
                                                                </label>
                                                                <div className="flex gap-1.5 flex-wrap mb-2">
                                                                    {[
                                                                        { id: 'white', hex: '#ffffff', label: 'Beyaz' },
                                                                        { id: 'slate', hex: '#f8fafc', label: 'Açık Gri' },
                                                                        { id: 'blue', hex: '#eff6ff', label: 'Açık Mavi' },
                                                                        { id: 'indigo', hex: '#eef2ff', label: 'Açık İndigo' },
                                                                        { id: 'purple', hex: '#faf5ff', label: 'Açık Mor' },
                                                                        { id: 'pink', hex: '#fdf2f8', label: 'Açık Pembe' },
                                                                        { id: 'red', hex: '#fef2f2', label: 'Açık Kırmızı' },
                                                                        { id: 'orange', hex: '#fff7ed', label: 'Açık Turuncu' },
                                                                        { id: 'amber', hex: '#fffbeb', label: 'Açık Amber' },
                                                                        { id: 'yellow', hex: '#fefce8', label: 'Açık Sarı' },
                                                                        { id: 'green', hex: '#f0fdf4', label: 'Açık Yeşil' },
                                                                        { id: 'teal', hex: '#f0fdfa', label: 'Açık Teal' }
                                                                    ].map(color => (
                                                                        <button 
                                                                            key={color.id} 
                                                                            onClick={() => updateNodeData('backgroundColor', color.hex)} 
                                                                            className={`w-6 h-6 rounded-md border hover:scale-110 transition-all ${selectedNode.backgroundColor === color.hex ? 'ring-2 ring-offset-1 ring-blue-500 border-blue-400' : 'border-slate-200'}`} 
                                                                            style={{ backgroundColor: color.hex }} 
                                                                            title={color.label} 
                                                                        />
                                                                    ))}
                                                                    <input 
                                                                        type="color" 
                                                                        value={selectedNode.backgroundColor || '#ffffff'} 
                                                                        onChange={(e) => updateNodeData('backgroundColor', e.target.value)} 
                                                                        className="w-6 h-6 rounded-md border border-slate-300 cursor-pointer" 
                                                                        title="Özel Renk" 
                                                                    />
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <label className="text-[10px] text-slate-500">Opaklık:</label>
                                                                    <input 
                                                                        type="range" 
                                                                        min="0" 
                                                                        max="100" 
                                                                        value={selectedNode.bgOpacity || 100} 
                                                                        onChange={(e) => updateNodeData('bgOpacity', parseInt(e.target.value))} 
                                                                        className="flex-1 h-1.5 accent-blue-500" 
                                                                    />
                                                                    <span className="text-[10px] text-slate-500 w-6">{selectedNode.bgOpacity || 100}%</span>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* ADIM NUMARASI */}
                                                            <div className="p-2 bg-orange-50 rounded-lg border border-orange-100">
                                                                <label className="text-[10px] font-bold text-orange-700 mb-1.5 block flex items-center gap-1">
                                                                    ADIM NUMARASI
                                                                </label>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-orange-600 mb-0.5 block">BOYUT</label>
                                                                        <input 
                                                                            type="number" 
                                                                            min="8" 
                                                                            max="16" 
                                                                            value={selectedNode.stepNumberFontSize || 10} 
                                                                            onChange={(e) => updateNodeData('stepNumberFontSize', parseInt(e.target.value) || 10)} 
                                                                            className="w-full p-1.5 border border-orange-200 rounded text-[10px] bg-white" 
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-orange-600 mb-0.5 block">RENK</label>
                                                                        <input 
                                                                            type="color" 
                                                                            value={selectedNode.stepNumberColor || '#ffffff'} 
                                                                            onChange={(e) => updateNodeData('stepNumberColor', e.target.value)} 
                                                                            className="w-full h-7 p-0.5 border border-orange-200 rounded bg-white cursor-pointer" 
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-orange-600 mb-0.5 block">KALINLIK</label>
                                                                        <select 
                                                                            value={selectedNode.stepNumberFontWeight || 700} 
                                                                            onChange={(e) => updateNodeData('stepNumberFontWeight', parseInt(e.target.value))} 
                                                                            className="w-full p-1.5 border border-orange-200 rounded text-[10px] bg-white"
                                                                        >
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                            <option value="800">Çok Kalın</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div className="mt-1.5">
                                                                    <label className="text-[10px] text-orange-600 mb-0.5 block">ARKA PLAN</label>
                                                                    <div className="flex gap-1 items-center">
                                                                        <input 
                                                                            type="color" 
                                                                            value={selectedNode.stepNumberBgColor || '#00000026'} 
                                                                            onChange={(e) => updateNodeData('stepNumberBgColor', e.target.value)} 
                                                                            className="w-8 h-7 p-0.5 border border-orange-200 rounded bg-white cursor-pointer" 
                                                                        />
                                                                        <input 
                                                                            type="range" 
                                                                            min="0" 
                                                                            max="100" 
                                                                            value={selectedNode.stepNumberBgOpacity ?? 15} 
                                                                            onChange={(e) => updateNodeData('stepNumberBgOpacity', parseInt(e.target.value))} 
                                                                            className="flex-1 h-1.5 accent-orange-500" 
                                                                        />
                                                                        <span className="text-[10px] text-orange-600 w-6">{selectedNode.stepNumberBgOpacity ?? 15}%</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* BİLEŞEN RENGİ */}
                                                            <div className="p-2 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg">
                                                                <label className="text-[10px] font-bold text-purple-700 mb-1.5 block">
                                                                    BİLEŞEN RENGİ
                                                                </label>
                                                                <div className="grid grid-cols-6 gap-1 mb-2">
                                                                    {[
                                                                        // Satır 1: Gri ve Mavi tonları
                                                                        { hex: '#ffffff', label: 'Beyaz' },
                                                                        { hex: '#cbd5e1', label: 'Açık Gri' },
                                                                        { hex: '#1e293b', label: 'Koyu Lacivert' },
                                                                        { hex: '#bfdbfe', label: 'Açık Mavi' },
                                                                        { hex: '#3b82f6', label: 'Mavi' },
                                                                        { hex: '#1e40af', label: 'Koyu Mavi' },
                                                                        // Satır 2: Yeşil ve Kırmızı tonları
                                                                        { hex: '#bbf7d0', label: 'Açık Yeşil' },
                                                                        { hex: '#22c55e', label: 'Yeşil' },
                                                                        { hex: '#166534', label: 'Koyu Yeşil' },
                                                                        { hex: '#fecaca', label: 'Açık Kırmızı' },
                                                                        { hex: '#ef4444', label: 'Kırmızı' },
                                                                        { hex: '#b91c1c', label: 'Koyu Kırmızı' },
                                                                        // Satır 3: Sarı ve Mor tonları
                                                                        { hex: '#fef9c3', label: 'Açık Sarı' },
                                                                        { hex: '#FBCE07', label: 'Shell Sarı' },
                                                                        { hex: '#e9d5ff', label: 'Açık Mor' },
                                                                        { hex: '#a855f7', label: 'Mor' },
                                                                        { hex: '#7e22ce', label: 'Koyu Mor' },
                                                                        { hex: '#f9a8d4', label: 'Açık Pembe' },
                                                                        // Satır 4: Pembe tonları
                                                                        { hex: '#ec4899', label: 'Pembe' },
                                                                    ].map((color, idx) => (
                                                                        <button 
                                                                            key={idx} 
                                                                            onClick={() => updateNodeData('techStackBgColor', color.hex)} 
                                                                            className={`w-7 h-7 rounded-lg border-2 hover:scale-110 transition-transform ${selectedNode.techStackBgColor === color.hex ? 'ring-2 ring-offset-1 ring-purple-500' : 'border-white/50'}`} 
                                                                            style={{ backgroundColor: color.hex }} 
                                                                            title={color.label} 
                                                                        />
                                                                    ))}
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <label className="text-[10px] text-purple-600">Özel:</label>
                                                                    <input 
                                                                        type="color" 
                                                                        value={selectedNode.techStackBgColor || '#1e293b'} 
                                                                        onChange={(e) => updateNodeData('techStackBgColor', e.target.value)} 
                                                                        className="w-8 h-6 rounded border border-purple-300 cursor-pointer" 
                                                                        title="Özel Renk Seç" 
                                                                    />
                                                                    <span className="text-[10px] text-purple-500 font-mono">{selectedNode.techStackBgColor || '#1e293b'}</span>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* GÖLGE & KENARLIK */}
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div className="p-2 bg-slate-50 rounded-lg">
                                                                    <label className="text-[10px] font-bold text-slate-600 mb-1.5 block">GÖLGE</label>
                                                                    <div className="flex flex-col gap-1">
                                                                        {[
                                                                            { id: 'none', label: 'Yok', value: 'none' },
                                                                            { id: 'sm', label: 'Hafif', value: '0 1px 2px rgba(0,0,0,0.05)' },
                                                                            { id: 'md', label: 'Orta', value: '0 4px 6px rgba(0,0,0,0.1)' },
                                                                            { id: 'lg', label: 'Güçlü', value: '0 10px 15px rgba(0,0,0,0.15)' },
                                                                            { id: 'xl', label: 'Çok Güçlü', value: '0 20px 25px rgba(0,0,0,0.2)' }
                                                                        ].map(shadow => (
                                                                            <button 
                                                                                key={shadow.id} 
                                                                                onClick={() => updateNodeData('customShadow', shadow.value)} 
                                                                                className={`text-[10px] px-2 py-1 rounded border transition-all ${(selectedNode.customShadow || '0 4px 6px rgba(0,0,0,0.1)') === shadow.value ? 'bg-blue-500 text-white border-blue-500' : 'bg-white border-slate-200 text-slate-600 hover:border-blue-300'}`}
                                                                            >
                                                                                {shadow.label}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                                <div className="p-2 bg-slate-50 rounded-lg">
                                                                    <label className="text-[10px] font-bold text-slate-600 mb-1.5 block">KÖŞE YUVARLATMA</label>
                                                                    <div className="flex flex-col gap-1">
                                                                        {[
                                                                            { id: 'none', label: 'Yok', value: 0 },
                                                                            { id: 'sm', label: 'Az', value: 4 },
                                                                            { id: 'md', label: 'Orta', value: 10 },
                                                                            { id: 'lg', label: 'Fazla', value: 16 },
                                                                            { id: 'xl', label: 'Çok Fazla', value: 24 }
                                                                        ].map(radius => (
                                                                            <button 
                                                                                key={radius.id} 
                                                                                onClick={() => updateNodeData('borderRadius', radius.value)} 
                                                                                className={`text-[10px] px-2 py-1 rounded border transition-all ${(selectedNode.borderRadius ?? 10) === radius.value ? 'bg-blue-500 text-white border-blue-500' : 'bg-white border-slate-200 text-slate-600 hover:border-blue-300'}`}
                                                                            >
                                                                                {radius.label}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* KENARLK STILI */}
                                                            <div className="p-2 bg-white rounded-lg border border-slate-100">
                                                                <label className="text-[10px] font-bold text-slate-600 mb-1.5 block flex items-center gap-1">
                                                                    KENARLIK STİLİ
                                                                </label>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-slate-500 mb-0.5 block">Kalınlık</label>
                                                                        <div className="flex gap-0.5">
                                                                            {[0, 1, 2, 3].map(w => (
                                                                                <button 
                                                                                    key={w} 
                                                                                    onClick={() => updateNodeData('borderWidth', w)} 
                                                                                    className={`flex-1 text-[10px] py-1 rounded border ${(selectedNode.borderWidth ?? 0) === w ? 'bg-blue-500 text-white border-blue-500' : 'bg-white border-slate-200'}`}
                                                                                >
                                                                                    {w}
                                                                                </button>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-slate-500 mb-0.5 block">Stil</label>
                                                                        <select 
                                                                            value={selectedNode.borderStyle || 'solid'} 
                                                                            onChange={(e) => updateNodeData('borderStyle', e.target.value)} 
                                                                            className="w-full p-1.5 border border-slate-200 rounded text-[10px] bg-white"
                                                                        >
                                                                            <option value="solid">Düz</option>
                                                                            <option value="dashed">Kesikli</option>
                                                                            <option value="dotted">Noktalı</option>
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-slate-500 mb-0.5 block">Renk</label>
                                                                        <input 
                                                                            type="color" 
                                                                            value={selectedNode.boxBorderColor || '#e2e8f0'} 
                                                                            onChange={(e) => updateNodeData('boxBorderColor', e.target.value)} 
                                                                            className="w-full h-6 rounded border border-slate-200 cursor-pointer" 
                                                                        />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* YAZI AYARLARI - Accordion */}
                                            {selectedNode.type !== 'SWIMLANE' && selectedNode.type !== 'START' && selectedNode.type !== 'END' && selectedNode.type !== 'DECISION' && selectedNode.type !== 'LIFELINE' && (
                                                <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                    <button onClick={() => toggleSection('yazi')} className="w-full flex items-center justify-between p-2 bg-slate-50 hover:bg-slate-100 transition-colors">
                                                        <span className="text-[10px] font-bold text-slate-700 uppercase tracking-wide">âœï¸ Yazı Ayarları</span>
                                                        <ChevronDown className={`w-3.5 h-3.5 text-slate-500 transition-transform ${expandedSections.yazi ? 'rotate-180' : ''}`} />
                                                    </button>
                                                    {expandedSections.yazi && (
                                                        <div className="p-2 space-y-3 bg-white">
                                                            
                                                            {/* AKTÖR AYARLARI */}
                                                            <div className="p-2 bg-blue-50 rounded-lg border border-blue-100">
                                                                <div className="text-[10px] font-bold text-blue-700 mb-2 flex items-center gap-1">
                                                                    AKTÖR (Header)
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-blue-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="7" max="16" value={Math.round(selectedNode.headerFontSize || 9)} onChange={(e) => updateNodeData('headerFontSize', parseInt(e.target.value) || 9)} className="w-full p-1.5 border border-blue-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-blue-600 mb-0.5 block">RENK</label>
                                                                        <input type="color" value={selectedNode.headerFontColor || '#ffffff'} onChange={(e) => updateNodeData('headerFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-blue-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-blue-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.headerFontWeight || 700} onChange={(e) => updateNodeData('headerFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-blue-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                            <option value="800">Çok Kalın</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* BİLEŞEN AYARLARI */}
                                                            <div className="p-2 bg-purple-50 rounded-lg border border-purple-100">
                                                                <div className="text-[10px] font-bold text-purple-700 mb-2 flex items-center gap-1">
                                                                    BİLEŞEN
                                                                </div>
                                                                <div className="grid grid-cols-4 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="6" max="14" value={Math.round(selectedNode.techStackFontSize || 8)} onChange={(e) => updateNodeData('techStackFontSize', parseInt(e.target.value) || 8)} className="w-full p-1.5 border border-purple-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">METİN</label>
                                                                        <input type="color" value={selectedNode.techStackFontColor || '#ffffff'} onChange={(e) => updateNodeData('techStackFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-purple-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">ARKA PLAN</label>
                                                                        <input type="color" value={selectedNode.techStackBgColor || '#ffffff'} onChange={(e) => updateNodeData('techStackBgColor', e.target.value + '1a')} className="w-full h-7 p-0.5 border border-purple-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-purple-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.techStackFontWeight || 600} onChange={(e) => updateNodeData('techStackFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-purple-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div className="mt-1.5 flex gap-1">
                                                                    <label className="text-[10px] text-purple-600">Opaklık:</label>
                                                                    <input 
                                                                        type="range" 
                                                                        min="0" 
                                                                        max="100" 
                                                                        value={selectedNode.techStackBgOpacity ?? 10} 
                                                                        onChange={(e) => {
                                                                            const opacity = parseInt(e.target.value);
                                                                            const baseColor = (selectedNode.techStackBgColor || '#ffffff').substring(0, 7);
                                                                            const hex = Math.round(opacity * 2.55).toString(16).padStart(2, '0');
                                                                            updateNodeData('techStackBgColor', baseColor + hex);
                                                                            updateNodeData('techStackBgOpacity', opacity);
                                                                        }} 
                                                                        className="flex-1 h-1.5 accent-purple-500" 
                                                                    />
                                                                    <span className="text-[10px] text-purple-600 w-6">{selectedNode.techStackBgOpacity ?? 10}%</span>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* BAŞLIK AYARLARI */}
                                                            <div className="p-2 bg-amber-50 rounded-lg border border-amber-100">
                                                                <div className="text-[10px] font-bold text-amber-700 mb-2 flex items-center gap-1">
                                                                    BAŞLIK (Title)
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-amber-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="8" max="16" value={Math.round(selectedNode.titleFontSize || 10)} onChange={(e) => updateNodeData('titleFontSize', parseInt(e.target.value) || 10)} className="w-full p-1.5 border border-amber-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-amber-600 mb-0.5 block">RENK</label>
                                                                        <input type="color" value={selectedNode.titleFontColor || '#64748b'} onChange={(e) => updateNodeData('titleFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-amber-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-amber-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.titleFontWeight || 600} onChange={(e) => updateNodeData('titleFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-amber-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* DETAY AYARLARI */}
                                                            <div className="p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                                                                <div className="text-[10px] font-bold text-emerald-700 mb-2 flex items-center gap-1">
                                                                    SÜREÇ DETAYI (Description)
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-1.5">
                                                                    <div>
                                                                        <label className="text-[10px] text-emerald-600 mb-0.5 block">BOYUT</label>
                                                                        <input type="number" min="8" max="16" value={Math.round(selectedNode.descriptionFontSize || 10)} onChange={(e) => updateNodeData('descriptionFontSize', parseInt(e.target.value) || 10)} className="w-full p-1.5 border border-emerald-200 rounded text-[10px] bg-white" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-emerald-600 mb-0.5 block">RENK</label>
                                                                        <input type="color" value={selectedNode.descriptionFontColor || '#64748b'} onChange={(e) => updateNodeData('descriptionFontColor', e.target.value)} className="w-full h-7 p-0.5 border border-emerald-200 rounded bg-white cursor-pointer" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[10px] text-emerald-600 mb-0.5 block">KALINLIK</label>
                                                                        <select value={selectedNode.descriptionFontWeight || 400} onChange={(e) => updateNodeData('descriptionFontWeight', parseInt(e.target.value))} className="w-full p-1.5 border border-emerald-200 rounded text-[10px] bg-white">
                                                                            <option value="400">Normal</option>
                                                                            <option value="500">Orta</option>
                                                                            <option value="600">Kalın</option>
                                                                            <option value="700">Bold</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div className="mt-1.5">
                                                                    <label className="text-[10px] text-emerald-600 mb-0.5 block">SATIR ARALIıžI</label>
                                                                    <div className="flex gap-1">
                                                                        {[1.2, 1.4, 1.6, 1.8, 2].map(lh => (
                                                                            <button key={lh} onClick={() => updateNodeData('descriptionLineHeight', lh)} className={`flex-1 p-1.5 border rounded text-[10px] ${(selectedNode.descriptionLineHeight || 1.4) === lh ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white border-emerald-200 text-emerald-700'}`}>{lh}</button>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* ORTAK FONT */}
                                                            <div className="p-2 bg-slate-100 rounded-lg">
                                                                <label className="text-[10px] font-bold text-slate-600 mb-1 block">ORTAK FONT AİLESİ</label>
                                                                <select value={selectedNode.headerFontFamily || "'Segoe UI', sans-serif"} onChange={(e) => { updateNodeData('headerFontFamily', e.target.value); updateNodeData('techStackFontFamily', e.target.value); updateNodeData('titleFontFamily', e.target.value); updateNodeData('descriptionFontFamily', e.target.value); }} className="w-full p-1.5 border border-slate-300 rounded text-[10px] bg-white">
                                                                    <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
                                                                    <option value="'Inter', system-ui, sans-serif">Inter</option>
                                                                    <option value="'Roboto', Arial, sans-serif">Roboto</option>
                                                                    <option value="'Poppins', 'Segoe UI', sans-serif">Poppins</option>
                                                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                                                    <option value="'Lato', sans-serif">Lato</option>
                                                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                                                    <option value="monospace">Monospace</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* SWIMLANE Özel Ayarlar */}
                                            {selectedNode.type === 'SWIMLANE' && (
                                                <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                    <button onClick={() => toggleSection('gorunum')} className="w-full flex items-center justify-between p-2 bg-slate-50 hover:bg-slate-100 transition-colors">
                                                        <span className="text-[10px] font-bold text-slate-700 uppercase tracking-wide">Kulvar Ayarları</span>
                                                        <ChevronDown className={`w-3.5 h-3.5 text-slate-500 transition-transform ${expandedSections.gorunum ? 'rotate-180' : ''}`} />
                                                    </button>
                                                    {expandedSections.gorunum && (
                                                        <div className="p-2 space-y-2 bg-white">
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">BAŞLIK KONUMU</label>
                                                                <div className="grid grid-cols-3 gap-1">
                                                                    <button onClick={() => updateNodeData('headerPosition', 'top')} className={`p-1.5 border rounded text-[10px] font-medium ${selectedNode.headerPosition === 'top' || !selectedNode.headerPosition ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 border-slate-200'}`}>ÜST</button>
                                                                    <button onClick={() => updateNodeData('headerPosition', 'left')} className={`p-1.5 border rounded text-[10px] font-medium ${selectedNode.headerPosition === 'left' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 border-slate-200'}`}>SOL</button>
                                                                    <button onClick={() => updateNodeData('headerPosition', 'right')} className={`p-1.5 border rounded text-[10px] font-medium ${selectedNode.headerPosition === 'right' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 border-slate-200'}`}>SAıž</button>
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block">ARKA PLAN</label>
                                                                    <div className="flex gap-1 flex-wrap">
                                                                        {BG_COLORS.slice(0, 5).map(color => (
                                                                            <button key={color.id} onClick={() => updateNodeData('backgroundColor', toPaleColor(color.hex, '33'))} className="w-5 h-5 rounded border hover:scale-110" style={{ backgroundColor: toPaleColor(color.hex, '33') }} />
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-slate-400 mb-1 block">ÇİZGİ</label>
                                                                    <div className="flex gap-1 flex-wrap">
                                                                        {BORDER_COLORS.slice(0, 5).map(color => (
                                                                            <button key={color.id} onClick={() => updateNodeData('borderColor', toPaleColor(color.hex, '66'))} className="w-5 h-5 rounded border-2 hover:scale-110" style={{ borderColor: color.hex }} />
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </>
                                    )}
                                    
                                    {isMultiSelect && (
                                        <div className="space-y-2">
                                            <div className="flex items-center gap-1">
                                                <button onClick={groupSelected} className="flex-1 px-2 py-1.5 text-[10px] font-bold bg-slate-900 text-white rounded hover:bg-slate-700">Grupla</button>
                                                <button onClick={ungroupSelected} className="flex-1 px-2 py-1.5 text-[10px] font-bold bg-white text-slate-900 border border-slate-300 rounded hover:bg-slate-50">ÇÖz</button>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 mb-1 block">ETİKET RENGİ (TOPLU)</label>
                                                <div className="flex gap-1 flex-wrap">
                                                    {BADGE_COLORS.map(color => (
                                                        <button key={color.id} onClick={() => updateNodeData('customColor', color.class)} className={`w-5 h-5 rounded-full border ${color.class} hover:scale-110`} />
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 p-1.5 border border-amber-200 bg-amber-50 rounded cursor-pointer" onClick={() => updateNodeData('hasRisk', !selectedNode?.hasRisk)}>
                                                <input type="checkbox" checked={selectedNode?.hasRisk || false} onChange={() => {}} className="w-3 h-3 text-amber-600 rounded" />
                                                <span className="text-[10px] font-bold text-amber-800">Risk İşaretle (Toplu)</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : selectedConnection ? (
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                <div className="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                                    <h2 className="text-xs font-bold text-slate-800">BAĞLANTI</h2>
                                    <button onClick={deleteSelected} className="p-1 hover:bg-red-50 rounded transition-colors text-red-600"><Trash2 className="w-3.5 h-3.5" /></button>
                                </div>
                                <div className="p-2 space-y-2">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 mb-1 block">ETİKET</label>
                                        <input type="text" value={selectedConnection.label || ''} onChange={(e) => updateConnectionLabel(selectedConnection.id, e.target.value)} className="w-full p-1.5 border border-slate-200 rounded text-xs bg-white" placeholder="Veri Akışı..." />
                                    </div>
                                    
                                    {/* Renk ve Kalınlık */}
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 mb-1 block">RENK</label>
                                            <div className="flex gap-1 flex-wrap">
                                                {['#475569', '#0f172a', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'].map(color => (
                                                    <button key={color} onClick={() => updateConnectionData(selectedConnection.id, 'color', color)} className={`w-5 h-5 rounded-full border-2 hover:scale-110 transition-transform ${(selectedConnection.color || '#475569') === color ? 'border-blue-500 ring-2 ring-blue-200' : 'border-white'}`} style={{ backgroundColor: color }} />
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 mb-1 block">KALINLIK</label>
                                            <div className="flex gap-1">
                                                {[1.5, 2, 3, 4].map(w => (
                                                    <button key={w} onClick={() => updateConnectionData(selectedConnection.id, 'strokeWidth', w)} className={`flex-1 p-1.5 border rounded text-[10px] ${(selectedConnection.strokeWidth || 2) === w ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>{w}px</button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 mb-1 block">ÇİZGİ TİPİ</label>
                                        <div className="grid grid-cols-4 gap-1">
                                            <button onClick={() => updateConnectionData(selectedConnection.id, 'type', 'bezier')} className={`p-1.5 border rounded text-[10px] font-medium ${(selectedConnection.type || 'bezier') === 'bezier' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>Eğri</button>
                                            <button onClick={() => updateConnectionData(selectedConnection.id, 'type', 'straight')} className={`p-1.5 border rounded text-[10px] font-medium ${selectedConnection.type === 'straight' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>Düz</button>
                                            <button onClick={() => updateConnectionData(selectedConnection.id, 'type', 'step')} className={`p-1.5 border rounded text-[10px] font-medium ${selectedConnection.type === 'step' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>KÖşeli</button>
                                            <button onClick={() => updateConnectionData(selectedConnection.id, 'dashed', !selectedConnection.dashed)} className={`p-1.5 border rounded text-[10px] font-medium ${selectedConnection.dashed ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>- - -</button>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 mb-1 block">OK BAŞI</label>
                                            <div className="grid grid-cols-3 gap-1">
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'startArrow', 'none')} className={`p-1.5 border rounded text-[10px] ${(selectedConnection.startArrow || 'none') === 'none' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â€”</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'startArrow', 'standard')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.startArrow === 'standard' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—€</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'startArrow', 'open')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.startArrow === 'open' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â€¹</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'startArrow', 'circle')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.startArrow === 'circle' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—‹</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'startArrow', 'filledCircle')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.startArrow === 'filledCircle' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'startArrow', 'diamond')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.startArrow === 'diamond' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—‡</button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 mb-1 block">OK SONU</label>
                                            <div className="grid grid-cols-3 gap-1">
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'endArrow', 'none')} className={`p-1.5 border rounded text-[10px] ${(selectedConnection.endArrow || 'standard') === 'none' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â€”</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'endArrow', 'standard')} className={`p-1.5 border rounded text-[10px] ${(selectedConnection.endArrow || 'standard') === 'standard' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â–¶</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'endArrow', 'open')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.endArrow === 'open' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â€º</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'endArrow', 'circle')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.endArrow === 'circle' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—‹</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'endArrow', 'filledCircle')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.endArrow === 'filledCircle' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—</button>
                                                <button onClick={() => updateConnectionData(selectedConnection.id, 'endArrow', 'diamond')} className={`p-1.5 border rounded text-[10px] ${selectedConnection.endArrow === 'diamond' ? 'bg-blue-600 text-white' : 'bg-white border-slate-200'}`}>â—‡</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button onClick={() => updateConnectionData(selectedConnection.id, 'animated', !selectedConnection.animated)} className={`w-full p-1.5 border rounded text-[10px] font-medium flex items-center justify-center gap-1 ${selectedConnection.animated ? 'bg-emerald-600 text-white' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                        {selectedConnection.animated ? 'âœ“ Animasyonlu' : 'â–¸ Animasyon Ekle'}
                                    </button>
                                    
                                    <div className="p-1.5 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-100 rounded">
                                        <p className="text-[10px] text-blue-600">Mavi noktayı sürükleyerek eğriyi şekillendirebilirsiniz</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-300 p-8 text-center">
                                <FileText className="w-16 h-16 mb-4 opacity-20" />
                                <h3 className="text-sm font-bold">SEÇİM YAPILMADI</h3>
                                <p className="text-xs text-slate-400 mt-2">Bir Öğe seçin veya yeni bir Öğe ekleyin</p>
                            </div>
                        )}
                    </div>

                    {/* AI Modal */}
                    {showAiModal && (
                        <div className="absolute inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
                            <div className="bg-white w-full max-w-3xl rounded-lg border-2 border-black flex flex-col max-h-[80vh]">
                                <div className="p-4 border-b-2 border-slate-100 flex justify-between bg-purple-50 rounded-t-lg"><h2 className="text-lg font-bold text-purple-900 flex items-center gap-2"><Sparkles className="w-5 h-5"/> SÜREÇ ANALİZ RAPORU</h2><button type="button" onClick={() => setShowAiModal(false)}><X className="w-6 h-6" /></button></div>
                                <div className="p-4 md:p-8 overflow-y-auto font-mono text-xs md:text-sm text-slate-700 whitespace-pre-wrap">{aiAnalysisResult}</div>
                                <div className="p-4 border-t-2 border-slate-100 bg-slate-50 rounded-b-lg flex justify-end gap-2"><button onClick={downloadReport} className="px-4 py-2 bg-emerald-100 text-emerald-800 rounded font-bold text-sm hover:bg-emerald-200">Raporu İndir (.md)</button><button onClick={() => setShowAiModal(false)} className="px-6 py-2 bg-slate-900 text-white font-bold text-sm rounded">KAPAT</button></div>
                            </div>
                        </div>
                    )}

                    {/* AI Settings Modal */}
                    {showAiSettingsModal && (
                        <div className="absolute inset-0 z-[200] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" onClick={() => setShowAiSettingsModal(false)}>
                            <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <Sparkles className="w-5 h-5 text-purple-600" />
                                        AI Ayarları
                                    </h2>
                                    <button type="button" onClick={() => setShowAiSettingsModal(false)}><X className="w-6 h-6 text-slate-400 hover:text-slate-600" /></button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 mb-2 block">Sağlayıcı</label>
                                        <select value={aiProvider} onChange={handleProviderChange} className="w-full p-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="gemini">Google Gemini</option>
                                            <option value="azure">Azure OpenAI</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 mb-2 block">API Key</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="password" 
                                                value={apiKeyInput} 
                                                onChange={handleKeyInput} 
                                                placeholder="API anahtarınızı girin..." 
                                                className="flex-1 p-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                            {apiKeyInput && <div className="p-2.5 text-green-600 flex items-center"><Key className="w-5 h-5" /></div>}
                                        </div>
                                    </div>
                                    {aiProvider === 'azure' && (
                                        <div>
                                            <label className="text-sm font-medium text-slate-700 mb-2 block">Endpoint URL</label>
                                            <input 
                                                type="text" 
                                                value={azureEndpoint} 
                                                onChange={handleEndpointInput} 
                                                placeholder="https://your-endpoint.openai.azure.com/..." 
                                                className="w-full p-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                        </div>
                                    )}
                                    <div className="pt-4 border-t border-slate-200">
                                        <button 
                                            onClick={() => setShowAiSettingsModal(false)}
                                            className="w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
                                        >
                                            Kaydet
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Not Popup Modal */}
                    {notePopupNodeId && (() => {
                        const noteNode = nodes.find(n => n.id === notePopupNodeId);
                        if (!noteNode) return null;
                        return (
                            <div className="absolute inset-0 z-[200] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" onClick={() => setNotePopupNodeId(null)}>
                                <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                    {/* Header */}
                                    <div className="bg-gradient-to-r from-amber-500 to-amber-600 px-5 py-4 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                                <FileText className="w-5 h-5 text-white" />
                                            </div>
                                            <div>
                                                <h2 className="text-lg font-bold text-white">Teknik Not</h2>
                                                <p className="text-amber-100 text-xs">{noteNode.title || 'İsimsiz Kutu'}</p>
                                            </div>
                                        </div>
                                        <button type="button" onClick={() => setNotePopupNodeId(null)} className="p-1.5 hover:bg-white/20 rounded-lg transition-colors">
                                            <X className="w-5 h-5 text-white" />
                                        </button>
                                    </div>
                                    {/* Content */}
                                    <div className="p-5">
                                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 min-h-[120px]">
                                            <pre className="text-sm text-slate-700 whitespace-pre-wrap font-mono leading-relaxed">{noteNode.note}</pre>
                                        </div>
                                        {/* Footer info */}
                                        <div className="mt-4 flex items-center justify-between text-xs text-slate-400">
                                            <span>Tablo adı, SQL sorgusu, teknik detay vb.</span>
                                            <button 
                                                onClick={() => { navigator.clipboard.writeText(noteNode.note); }}
                                                className="flex items-center gap-1 px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-600 transition-colors"
                                            >
                                                <Copy className="w-3 h-3" /> Kopyala
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="absolute inset-0 z-[200] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" onClick={() => setShowExportModal(false)}>
                            <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-slate-800">Dışa Aktar</h2><button type="button" onClick={() => setShowExportModal(false)}><X className="w-6 h-6 text-slate-400 hover:text-slate-600" /></button></div>
                                <div className="space-y-3">
                                    <button type="button" onClick={exportJSON} className="w-full flex items-center p-4 rounded-lg border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all group"><div className="p-3 bg-blue-100 rounded-full text-blue-600 mr-4 group-hover:scale-110"><FileJson className="w-6 h-6" /></div><div className="text-left"><div className="font-bold text-slate-800">Proje Dosyası (.json)</div><div className="text-xs text-slate-500">Yedekleme ve tekrar düzenleme için.</div></div></button>
                                    <button type="button" onClick={exportPNG} className="w-full flex items-center p-4 rounded-lg border border-slate-200 hover:border-purple-500 hover:bg-purple-50 transition-all group"><div className="p-3 bg-purple-100 rounded-full text-purple-600 mr-4 group-hover:scale-110"><ImageIcon className="w-6 h-6" /></div><div className="text-left"><div className="font-bold text-slate-800">Görsel (.png)</div><div className="text-xs text-slate-500">Sunumlar için yüksek kalite.</div></div></button>
                                    <button type="button" onClick={exportMarkdown} className="w-full flex items-center p-4 rounded-lg border border-slate-200 hover:border-emerald-500 hover:bg-emerald-50 transition-all group"><div className="p-3 bg-emerald-100 rounded-full text-emerald-600 mr-4 group-hover:scale-110"><FileText className="w-6 h-6" /></div><div className="text-left"><div className="font-bold text-slate-800">Rapor (.md)</div><div className="text-xs text-slate-500">Metin tabanlı süreç dÖkümü.</div></div></button>
                                    <button type="button" onClick={exportMermaid} className="w-full flex items-center p-4 rounded-lg border border-slate-200 hover:border-cyan-500 hover:bg-cyan-50 transition-all group"><div className="p-3 bg-cyan-100 rounded-full text-cyan-600 mr-4 group-hover:scale-110"><FileJson className="w-6 h-6" /></div><div className="text-left"><div className="font-bold text-slate-800">Mermaid (.mmd)</div><div className="text-xs text-slate-500">Mermaid.js formatında dışa aktar.</div></div></button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Search Modal */}
                    {showSearchModal && (
                        <div className="absolute inset-0 z-[200] flex items-start justify-center pt-20 bg-slate-900/30 backdrop-blur-sm" onClick={() => setShowSearchModal(false)}>
                            <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center gap-3 p-4 border-b border-slate-200">
                                    <Search className="w-5 h-5 text-slate-400" />
                                    <input 
                                        type="text" 
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="Kutularda ara..."
                                        className="flex-1 text-lg outline-none"
                                        autoFocus
                                    />
                                    <button onClick={() => setShowSearchModal(false)}><X className="w-5 h-5 text-slate-400 hover:text-slate-600" /></button>
                                </div>
                                <div className="max-h-80 overflow-y-auto">
                                    {searchQuery && searchResults.length === 0 && (
                                        <div className="p-8 text-center text-slate-500">Sonuç bulunamadı</div>
                                    )}
                                    {searchResults.map(node => (
                                        <button 
                                            key={node.id}
                                            onClick={() => {
                                                setSelectedNodeIds([node.id]);
                                                setSelectedConnectionId(null);
                                                const target = { x: node.x - 300, y: node.y - 200 };
                                                setPan(target);
                                                setShowSearchModal(false);
                                                setSearchQuery('');
                                            }}
                                            className="w-full flex items-center gap-3 p-3 hover:bg-slate-50 border-b border-slate-100 text-left"
                                        >
                                            <div className={`w-8 h-8 rounded flex items-center justify-center text-white text-xs font-bold ${node.customColor || 'bg-slate-600'}`}>
                                                {node.title?.charAt(0) || '?'}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-slate-800 truncate">{node.title || 'İsimsiz'}</div>
                                                <div className="text-xs text-slate-500 truncate">{node.type} {node.tag && `• ${node.tag}`}</div>
                                            </div>
                                            <ArrowRight className="w-4 h-4 text-slate-400" />
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Template Modal */}
                    {showTemplateModal && (
                        <div className="absolute inset-0 z-[200] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" onClick={() => setShowTemplateModal(false)}>
                            <div className="bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-800">Şablonlar</h2>
                                    <button type="button" onClick={() => setShowTemplateModal(false)}><X className="w-6 h-6 text-slate-400 hover:text-slate-600" /></button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {templates.map((template, idx) => (
                                        <button 
                                            key={idx}
                                            onClick={() => applyTemplate(template)}
                                            className="text-left p-4 rounded-xl border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition-all group"
                                        >
                                            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                                <Layout className="w-6 h-6 text-white" />
                                            </div>
                                            <div className="font-bold text-slate-800 mb-1">{template.name}</div>
                                            <div className="text-xs text-slate-500">{template.nodes.length} kutu</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    </div>{/* End of Main Content Area */}
                    
                    {/* Page Tabs Bar - Bottom */}
                    <div className="h-10 bg-white border-t border-slate-200 flex items-center px-2 gap-1 shrink-0 overflow-x-auto">
                        {pages.map((page, index) => (
                            <div 
                                key={page.id}
                                className={`group flex items-center gap-1 px-3 py-1.5 rounded-t-lg cursor-pointer transition-all min-w-[100px] max-w-[180px] ${
                                    currentPageId === page.id 
                                        ? 'bg-blue-50 border border-b-0 border-blue-200 text-blue-700' 
                                        : 'bg-slate-50 border border-b-0 border-slate-200 text-slate-600 hover:bg-slate-100'
                                }`}
                                onClick={() => { setCurrentPageId(page.id); setSelectedNodeIds([]); setSelectedConnectionId(null); }}
                            >
                                <FileText className="w-3.5 h-3.5 flex-shrink-0" />
                                {editingPageId === page.id ? (
                                    <input 
                                        type="text" 
                                        value={page.name}
                                        onChange={(e) => renamePage(page.id, e.target.value)}
                                        onBlur={() => setEditingPageId(null)}
                                        onKeyDown={(e) => { if(e.key === 'Enter') setEditingPageId(null); }}
                                        onClick={(e) => e.stopPropagation()}
                                        className="text-xs font-medium bg-white border border-blue-300 rounded px-1 py-0.5 w-full"
                                        autoFocus
                                    />
                                ) : (
                                    <span 
                                        className="text-xs font-medium truncate"
                                        onDoubleClick={(e) => { e.stopPropagation(); setEditingPageId(page.id); }}
                                    >
                                        {page.name}
                                    </span>
                                )}
                                {pages.length > 1 && (
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); deletePage(page.id); }}
                                        className="opacity-0 group-hover:opacity-100 p-0.5 hover:bg-red-100 rounded transition-all ml-auto"
                                    >
                                        <X className="w-3 h-3 text-red-500" />
                                    </button>
                                )}
                            </div>
                        ))}
                        <button 
                            onClick={addPage}
                            className="flex items-center gap-1 px-2 py-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded transition-colors"
                            title="Yeni Sayfa Ekle"
                        >
                            <Plus className="w-4 h-4" />
                            <span className="text-xs">Sayfa</span>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ArchitectureTool />);
    </script>
</body>
</html>
